<!--
  README DE USO R√ÅPIDO
  1. Al cargar la app se pedir√° tu API Key de Google Cloud Text-to-Speech (gratis 1M caracteres/mes). Gu√°rdala para voces naturales.
  2. Puedes cargar PDF/DOCX/TXT, escanear im√°genes, pegar texto, URL o correos y se guardar√°n en IndexedDB.
  3. El reproductor sincroniza el resaltado de palabras, la barra de progreso es clickeable/arrastrable y puedes cambiar velocidad/voz.
  4. Todas las funciones est√°n habilitadas (sin PRO) y las voces muestran avatares realistas.
-->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Listen AI Clone</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --amarillo-principal: #FFA500;
      --amarillo-dorado: #FFB800;
      --naranja-botones: #FF9500;
      --fondo-blanco: #FFFFFF;
      --fondo-gris-claro: #F5F5F5;
      --fondo-rosa-pastel: linear-gradient(180deg, #FFE4E1 0%, #FFDAB9 100%);
      --texto-negro: #1A1A1A;
      --texto-gris: #666666;
      --texto-gris-claro: #999999;
      --borde-gris: #E5E5E5;
      --azul-icono: #5BA3F5;
      --sombra-suave: rgba(0,0,0,0.08);
      font-family: 'Inter', 'SF Pro Display', system-ui, -apple-system, sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--fondo-gris-claro); color: var(--texto-negro); }
    #app { min-height: 100vh; padding-bottom: 80px; }

    .page { display: none; padding: 16px; }
    .page.active { display: block; }

    .promo-banner {
      background: var(--fondo-rosa-pastel);
      border-radius: 16px;
      padding: 20px;
      height: 180px;
      position: relative;
      box-shadow: 0 2px 10px var(--sombra-suave);
    }
    .btn-secondary {
      position: absolute;
      top: 16px;
      right: 16px;
      background: #fff;
      border: none;
      border-radius: 20px;
      padding: 10px 20px;
      font-weight: 600;
      cursor: pointer;
    }
    .section-header h2 { font-size: 22px; font-weight: 700; margin: 24px 0 16px; }
    .access-cards { display: flex; flex-direction: column; gap: 12px; }
    .tarjeta-acceso {
      background: #fff;
      border-radius: 16px;
      padding: 18px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      cursor: pointer;
    }
    .icon-card {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: #FFF3E0;
      display: grid;
      place-items: center;
      font-size: 20px;
    }
    .tarjeta-acceso h3 { font-size: 17px; font-weight: 600; }
    .tarjeta-acceso p { font-size: 14px; color: var(--texto-gris); }

    .library-header { display: flex; align-items: center; justify-content: space-between; margin: 12px 0; }
    .library-header h1 { font-size: 32px; font-weight: 700; margin-left: 4px; }
    .lib-icons { display: flex; gap: 10px; align-items: center; }
    .progress-circle { width: 40px; height: 40px; border-radius: 50%; border: 4px solid var(--azul-icono); display: grid; place-items: center; }
    .circle-text { color: var(--azul-icono); font-weight: 700; }
    .star-counter { background: #FFF3E0; padding: 6px 10px; border-radius: 12px; color: var(--amarillo-principal); font-weight: 700; }

    .tabs { display: flex; gap: 8px; margin: 16px 0; overflow-x: auto; }
    .tab { border: none; padding: 10px 20px; border-radius: 24px; background: #F0F0F0; color: var(--texto-gris); font-weight: 600; cursor: pointer; }
    .tab.active { background: var(--texto-negro); color: #fff; }

    #document-list { display: flex; flex-direction: column; gap: 12px; }
    .documento-item { background: #fff; border-radius: 14px; padding: 10px; display: flex; align-items: center; gap: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .documento-item .miniatura { width: 60px; height: 60px; border-radius: 8px; background: #eee; display: grid; place-items: center; font-size: 24px; }
    .documento-item h3 { font-size: 16px; font-weight: 600; color: var(--texto-negro); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .documento-item .meta { font-size: 13px; color: var(--texto-gris-claro); }
    .menu-puntos { margin-left: auto; border: none; background: transparent; font-size: 24px; color: var(--texto-gris-claro); cursor: pointer; }

    .player-toolbar { height: 56px; display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #fff; position: sticky; top: 0; }
    .icon-btn { width: 40px; height: 40px; border: none; background: transparent; font-size: 20px; cursor: pointer; }
    .player-body { background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    #player-title { font-size: 20px; font-weight: 700; text-align: center; margin-bottom: 12px; }
    .text-container { max-height: 320px; overflow-y: auto; background: #fff; padding: 12px; line-height: 1.6; font-size: 18px; color: var(--texto-negro); border: 1px solid var(--borde-gris); border-radius: 12px; }
    .text-container .palabra.resaltado { background: #FFF59D; transition: background 0.3s ease; }

    .progress-area { position: relative; margin: 20px 0; }
    .progress-bar { height: 4px; background: #E5E5E5; border-radius: 4px; position: relative; }
    .progress { height: 100%; width: 0; background: linear-gradient(90deg, var(--naranja-botones), var(--amarillo-principal)); border-radius: 4px; }
    .thumb { width: 16px; height: 16px; border-radius: 50%; background: var(--naranja-botones); position: absolute; top: -6px; left: 0; transform: translateX(-50%); }
    .time { position: absolute; top: -18px; font-size: 14px; color: var(--texto-gris-claro); }
    .time.start { left: 0; }
    .time.end { right: 0; }

    .controles { display: flex; justify-content: center; align-items: center; gap: 32px; margin: 28px 0; }
    .ctrl-btn { width: 48px; height: 48px; border-radius: 50%; border: none; background: #fff; font-size: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); cursor: pointer; }
    .play-btn { width: 72px; height: 72px; border-radius: 50%; border: none; background: linear-gradient(180deg, var(--amarillo-dorado), var(--naranja-botones)); color: #fff; font-size: 32px; box-shadow: 0 6px 20px rgba(255,165,0,0.3); cursor: pointer; }
    .footer-player { display: flex; justify-content: space-between; align-items: center; padding: 0 12px; }
    .speed-control button { background: #FFF3E0; border: 1px solid var(--amarillo-principal); border-radius: 24px; padding: 8px 14px; font-weight: 600; cursor: pointer; }
    .voice-control { display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; }
    .voice-control .avatar { width: 56px; height: 56px; border-radius: 50%; overflow: hidden; }
    .voice-control img { width: 100%; height: 100%; object-fit: cover; }
    .voice-control small { font-size: 14px; font-weight: 600; }

    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: #fff; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-around; align-items: center; z-index: 20; }
    .nav-item { flex: 1; background: none; border: none; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: #999; font-size: 12px; padding-top: 4px; position: relative; }
    .nav-item .icon { font-size: 24px; }
    .nav-item.active { color: var(--amarillo-principal); }
    .nav-item.active::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--amarillo-principal); }

    .fab { position: fixed; bottom: 84px; right: 24px; width: 64px; height: 64px; border-radius: 50%; border: none; background: linear-gradient(180deg, var(--amarillo-dorado), var(--naranja-botones)); color: #fff; font-size: 32px; box-shadow: 0 4px 16px rgba(255,165,0,0.4); cursor: pointer; z-index: 10; }

    .settings-page { padding: 16px; }
    .config-seccion { background: #fff; border-radius: 16px; margin-bottom: 18px; padding: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    .titulo-seccion { font-size: 14px; color: #999; text-transform: uppercase; margin: 12px 0 6px 12px; letter-spacing: 0.5px; }
    .config-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-top: 1px solid var(--borde-gris); cursor: pointer; }
    .config-item:first-of-type { border-top: none; }
    .icono-config { width: 40px; height: 40px; border-radius: 50%; background: #f0f0f0; display: grid; place-items: center; }
    .config-item span { font-size: 16px; font-weight: 500; }
    .valor-actual, .flecha { margin-left: auto; color: #999; font-size: 14px; }
    .cuenta-item { display: flex; align-items: center; gap: 10px; padding: 12px; }
    .icono-servicio { width: 28px; height: 28px; }
    .btn-desconectar { margin-left: auto; background: #FF3B30; color: #fff; border: none; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .descripcion-cuenta { color: var(--texto-gris); font-size: 14px; padding: 0 12px 12px; }

    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.25); z-index: 30; }
    .modal-overlay.active { display: block; }
    .modal-voz, .modal-velocidad, .modal-documento, .modal-notas, .modal-idioma, .formulario-solicitud { display: none; position: fixed; z-index: 40; left: 0; right: 0; }
    .modal-voz { bottom: 0; background: #fff; border-radius: 24px 24px 0 0; padding: 24px 20px; max-height: 85vh; overflow-y: auto; }
    .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .modal-header h3 { font-size: 22px; font-weight: 700; }
    .btn-cerrar, .btn-info { background: none; border: none; font-size: 20px; cursor: pointer; }
    .lista-voces { display: flex; flex-direction: column; gap: 12px; }
    .voz-card { display: flex; align-items: center; gap: 12px; padding: 16px; border-radius: 16px; background: #FAFAFA; border: 3px solid transparent; }
    .voz-card.activa { border-color: var(--amarillo-principal); background: #fff; }
    .avatar-circular { width: 64px; height: 64px; border-radius: 50%; overflow: hidden; }
    .avatar-circular img { width: 100%; height: 100%; object-fit: cover; }
    .info-voz h4 { font-size: 17px; font-weight: 600; }
    .info-voz p { font-size: 13px; color: var(--texto-gris); }
    .onda-sonido { color: #ccc; letter-spacing: 1px; }
    .btn-play { margin-left: auto; width: 40px; height: 40px; border-radius: 50%; background: #FFF3E0; border: none; cursor: pointer; font-size: 18px; }
    .btn-guardar { width: calc(100% - 40px); height: 54px; background: #1A1A1A; color: #fff; border: none; border-radius: 27px; font-size: 18px; font-weight: 600; position: sticky; bottom: 20px; margin: 20px auto 0; display: block; }

    .modal-velocidad { bottom: 0; background: #fff; border-radius: 24px 24px 0 0; padding: 24px 20px; max-height: 70vh; }
    .velocidad-actual { font-size: 22px; font-weight: 700; margin-bottom: 12px; }
    .slider-velocidad { width: 100%; accent-color: var(--naranja-botones); }
    .marcas-velocidad { display: flex; justify-content: space-between; color: var(--texto-gris); margin-top: 6px; }
    .velocidades-rapidas { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    .velocidades-rapidas button { padding: 10px 14px; border-radius: 16px; border: 1px solid var(--borde-gris); background: #fff; cursor: pointer; font-weight: 600; }

    .modal-documento { top: 10%; bottom: 10%; margin: 0 14px; background: #fff; border-radius: 18px; padding: 16px; overflow-y: auto; }
    .header-menu { display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--borde-gris); padding-bottom: 10px; }
    .preview-mini { width: 56px; height: 56px; border-radius: 12px; object-fit: cover; background: #eee; }
    .opciones-menu { display: flex; flex-direction: column; gap: 8px; padding-top: 12px; }
    .opciones-menu button { text-align: left; padding: 12px; border-radius: 12px; border: 1px solid var(--borde-gris); background: #fff; cursor: pointer; display: flex; gap: 10px; align-items: center; }
    .opciones-menu .eliminar { color: #FF3B30; border-color: #FFD1CF; }
    .opciones-menu .separador { height: 1px; background: var(--borde-gris); margin: 6px 0; }

    .modal-notas { top: 8%; bottom: 8%; margin: 0 14px; background: #fff; border-radius: 18px; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
    .modal-notas h2 { font-size: 20px; font-weight: 700; text-align: center; }
    .modal-notas textarea { width: 100%; min-height: 160px; border: 1px solid var(--borde-gris); border-radius: 12px; padding: 12px; font-size: 16px; }
    .btn-fab-nota { align-self: center; width: 56px; height: 56px; border-radius: 50%; border: none; background: var(--naranja-botones); color: #fff; font-size: 28px; box-shadow: 0 4px 12px rgba(255,165,0,0.3); cursor: pointer; }

    .modal-idioma { top: 0; bottom: 0; background: #fff; padding: 16px; overflow-y: auto; }
    .modal-idioma header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
    .modal-idioma h2 { font-size: 20px; font-weight: 700; }
    .lista-idiomas { display: flex; flex-direction: column; gap: 10px; }
    .idioma-item { display: flex; align-items: center; gap: 10px; padding: 12px; border-radius: 12px; border: 1px solid var(--borde-gris); cursor: pointer; }
    .idioma-item img { width: 32px; height: 20px; object-fit: cover; }
    .idioma-item.activo { border: 2px solid var(--amarillo-principal); background: #fff; }

    .formulario-solicitud { top: 0; bottom: 0; background: #fff; padding: 16px; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; }
    .formulario-solicitud h2 { font-size: 20px; font-weight: 700; }
    .formulario-solicitud .descripcion { color: var(--texto-gris); line-height: 1.4; }
    .input-titulo { border: none; border-bottom: 2px solid var(--borde-gris); padding: 10px 6px; font-size: 16px; }
    .textarea-info { border: 1px solid var(--borde-gris); border-radius: 12px; padding: 16px; min-height: 200px; font-size: 16px; }
    .contador { text-align: right; color: var(--texto-gris-claro); }
    .btn-enviar { background: #F0F0F0; border: none; padding: 14px; border-radius: 12px; font-weight: 600; font-size: 16px; cursor: pointer; }
    .btn-enviar.activo { background: var(--naranja-botones); color: #fff; }

    .hidden { display: none !important; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
</head>
<body>
  <div id="app">
    <main id="main-content">
      <section id="home" class="page active">
        <div class="promo-banner">
          <svg class="promo-illustration" viewBox="0 0 300 140" style="width: 100%; height: 100%; position:absolute; inset:0;">
            <rect x="20" y="30" width="50" height="60" rx="8" fill="#FFF" stroke="#E5E5E5" stroke-width="2"/>
            <line x1="30" y1="45" x2="60" y2="45" stroke="#CCC" stroke-width="2"/>
            <line x1="30" y1="55" x2="60" y2="55" stroke="#CCC" stroke-width="2"/>
            <line x1="30" y1="65" x2="55" y2="65" stroke="#CCC" stroke-width="2"/>
            <path d="M 75 60 L 95 60" stroke="#FF9500" stroke-width="3" fill="none" marker-end="url(#arrow)"/>
            <defs>
              <marker id="arrow" markerWidth="10" markerHeight="10" refX="5" refY="3" orient="auto">
                <polygon points="0 0, 6 3, 0 6" fill="#FF9500" />
              </marker>
            </defs>
            <rect x="100" y="30" width="50" height="60" rx="8" fill="#FFF" stroke="#E5E5E5" stroke-width="2"/>
            <circle cx="110" cy="45" r="2" fill="#5BA3F5"/>
            <line x1="115" y1="45" x2="140" y2="45" stroke="#888" stroke-width="1.5"/>
            <circle cx="110" cy="55" r="2" fill="#5BA3F5"/>
            <line x1="115" y1="55" x2="140" y2="55" stroke="#888" stroke-width="1.5"/>
            <circle cx="110" cy="65" r="2" fill="#5BA3F5"/>
            <line x1="115" y1="65" x2="135" y2="65" stroke="#888" stroke-width="1.5"/>
            <ellipse cx="175" cy="50" rx="25" ry="15" fill="#FFE4E1" stroke="#E5E5E5" stroke-width="2"/>
            <ellipse cx="190" cy="70" rx="30" ry="18" fill="#FFF3E0" stroke="#E5E5E5" stroke-width="2"/>
            <circle cx="250" cy="60" r="30" fill="#5BA3F5"/>
            <text x="250" y="70" text-anchor="middle" fill="#FFF" font-size="24" font-weight="700">AI</text>
          </svg>
          <div class="promo-text" style="position: absolute; bottom: 20px; left: 20px; right: 80px;">
            <p style="font-size: 16px; font-weight: 500; color: #333; line-height: 1.4;">
              Obt√©n un resumen r√°pido de un archivo o pregunta al AI cualquier cosa
            </p>
          </div>
          <button class="btn-secondary" id="btn-free">Prueba gratis</button>
        </div>
        <div class="section-header">
          <h2>¬øQu√© quieres escuchar hoy?</h2>
        </div>
        <div class="access-cards">
          <div class="tarjeta-acceso" data-action="archivo">
            <div class="icon-card">üìÑ</div>
            <div>
              <h3>Documento</h3>
              <p>Sube archivos desde Drive o dispositivo</p>
            </div>
          </div>
          <div class="tarjeta-acceso" data-action="escanear">
            <div class="icon-card">{ }</div>
            <div>
              <h3>Escanear Texto</h3>
              <p>Documentos escaneados o im√°genes</p>
            </div>
          </div>
          <div class="tarjeta-acceso" data-action="url">
            <div class="icon-card">üîó</div>
            <div>
              <h3>Enlace Web</h3>
              <p>Convierte URLs en audio</p>
            </div>
          </div>
          <div class="tarjeta-acceso" data-action="texto">
            <div class="icon-card">T</div>
            <div>
              <h3>Escribir o Pegar Texto</h3>
              <p>Introduce o pega texto para escuchar</p>
            </div>
          </div>
          <div class="tarjeta-acceso" data-action="correo">
            <div class="icon-card">‚úâÔ∏è</div>
            <div>
              <h3>Correo</h3>
              <p>Escucha los correos electr√≥nicos f√°cilmente</p>
            </div>
          </div>
        </div>
      </section>

      <section id="library" class="page">
        <header class="library-header">
          <h1>Mi Biblioteca</h1>
          <div class="lib-icons">
            <div class="progress-circle" title="Progreso">
              <span class="circle-text">IA</span>
            </div>
            <div class="star-counter">
              ‚≠ê<span>0</span>
            </div>
          </div>
        </header>
        <div class="tabs">
          <button class="tab active" data-filter="todo">Todo</button>
          <button class="tab" data-filter="continuar">Continuar</button>
          <button class="tab" data-filter="finalizado">Finalizado</button>
          <button class="tab" data-filter="favorito">‚ô• Favoritos</button>
        </div>
        <div id="document-list"></div>
      </section>

      <section id="player" class="page">
        <header class="player-toolbar">
          <button class="icon-btn" data-action="back">‚Üê</button>
          <button class="icon-btn" title="Resaltar">‚â°</button>
          <button class="icon-btn" title="Tama√±o">Aa</button>
          <button class="icon-btn" title="IA">üîÅ</button>
          <button class="icon-btn" title="Compartir">‚Üë</button>
          <button class="icon-btn" title="Opciones">‚ãØ</button>
        </header>
        <div class="player-body">
          <h3 id="player-title">Documento</h3>
          <div class="text-container" id="player-text"></div>
          <div class="progress-area">
            <div class="time start" id="time-start">0:00</div>
            <div class="time end" id="time-end">0:00</div>
            <div class="progress-bar" id="progress-bar">
              <div class="progress" id="progress"></div>
              <div class="thumb" id="progress-thumb"></div>
            </div>
          </div>
          <div class="controles">
            <button class="ctrl-btn" id="backward">‚è™10</button>
            <button class="play-btn" id="play-pause">‚ñ∂Ô∏è</button>
            <button class="ctrl-btn" id="forward">‚è©10</button>
          </div>
          <div class="footer-player">
            <div class="speed-control">
              <button id="speed-btn">1.0 x</button>
              <small>Velocidad</small>
            </div>
            <div class="voice-control" id="voice-btn">
              <div class="avatar">
                <img src="https://i.pravatar.cc/150?img=32" alt="Sasha" onerror="this.src='https://placehold.co/56x56'" />
              </div>
              <small>Sasha</small>
            </div>
          </div>
        </div>
      </section>
    </main>

    <nav class="bottom-nav">
      <button class="nav-item active" data-target="home">
        <div class="icon">üè†</div>
        <span>Inicio</span>
      </button>
      <button class="nav-item" data-target="library">
        <div class="icon">üìÑ</div>
        <span>Mi Biblioteca</span>
      </button>
      <button class="nav-item" data-target="settings">
        <div class="icon">‚öôÔ∏è</div>
        <span>Configuraciones</span>
      </button>
    </nav>

    <button class="fab" id="add-btn">+</button>

    <section id="settings" class="page">
      <div class="settings-page">
        <section class="config-seccion">
          <h3 class="titulo-seccion">Preferencias</h3>
          <div class="config-item" data-action="clonacion">
            <div class="icono-config">üéôÔ∏è</div>
            <span>Clonaci√≥n de Voz</span>
            <span class="flecha">‚Ä∫</span>
          </div>
          <div class="config-item" data-action="cambiar-voz">
            <div class="icono-config">üîä</div>
            <span>Cambiar Voz</span>
            <span class="valor-actual" id="voz-actual">Sasha</span>
          </div>
          <div class="config-item" data-action="idioma">
            <div class="icono-config">üåê</div>
            <span>Idioma de la aplicaci√≥n</span>
            <span class="valor-actual">Espa√±ol</span>
          </div>
          <div class="config-item" data-action="solicitar">
            <div class="icono-config">‚úèÔ∏è</div>
            <span>Solicitar Funci√≥n</span>
            <span class="flecha">‚Ä∫</span>
          </div>
        </section>

        <section class="config-seccion">
          <h3 class="titulo-seccion">Cuentas vinculadas</h3>
          <div class="cuenta-item">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="icono-servicio" alt="Google" />
            <span>Google</span>
            <button class="btn-desconectar">Desconectar</button>
          </div>
          <p class="descripcion-cuenta">Conecta tus cuentas y convierte tus archivos y correos en audio.</p>
        </section>

        <section class="config-seccion">
          <h3 class="titulo-seccion">Compartir</h3>
          <div class="config-item" data-action="compartir">
            <div class="icono-config">üì§</div>
            <span>Compartir Listen AI</span>
            <span class="flecha">‚Ä∫</span>
          </div>
        </section>
      </div>
    </section>
  </div>

  <div class="modal-overlay" id="modal-overlay"></div>

  <div class="modal-voz" id="voice-modal">
    <div class="modal-header">
      <button class="btn-cerrar" data-close>√ó</button>
      <h3>Seleccionar Voz</h3>
      <button class="btn-info">‚ìò</button>
    </div>
    <div class="lista-voces" id="voice-list"></div>
    <button class="btn-guardar" id="save-voice">Guardar</button>
  </div>

  <div class="modal-velocidad" id="speed-modal">
    <div class="modal-header">
      <h3>Velocidad</h3>
      <button class="btn-cerrar" data-close>√ó</button>
    </div>
    <div class="velocidad-actual" id="velocidad-actual">1.0 x</div>
    <input type="range" min="0.7" max="3.0" step="0.1" value="1.0" class="slider-velocidad" id="speed-slider" />
    <div class="marcas-velocidad">
      <span>0.7</span><span>1.2</span><span>1.7</span>
    </div>
    <div class="velocidades-rapidas" id="speed-buttons"></div>
  </div>

  <div class="modal-documento" id="doc-menu">
    <div class="header-menu">
      <img src="" class="preview-mini" id="doc-preview" alt="preview" />
      <div>
        <h4 id="doc-menu-title"></h4>
        <span id="doc-menu-type"></span>
      </div>
      <button class="btn-cerrar" data-close>√ó</button>
    </div>
    <div class="opciones-menu">
      <button data-action="download">
        <span class="icono">‚¨áÔ∏è</span>
        <div>
          <strong>Descargar Audio</strong>
          <small id="doc-voice">Sasha</small>
          <p>Permite escuchar sin conexi√≥n dentro de la aplicaci√≥n.</p>
        </div>
      </button>
      <button data-action="notas"><span>üìù</span> Notas</button>
      <button data-action="resumir"><span>üìã</span> Resumir</button>
      <button data-action="cola"><span>‚ûï</span> A√±adir a la cola</button>
      <button data-action="finalizar"><span>‚úì</span> Marcar como Finalizado</button>
      <button data-action="favorito"><span>‚ô•</span> Agregar a Favoritos</button>
      <div class="separador"></div>
      <button data-action="saltar"><span>üîÑ</span> Saltar Contenido Autom√°ticamente</button>
      <button data-action="temporizador"><span>‚è∞</span> Temporizador de Sue√±o</button>
      <button data-action="exportar"><span>‚ÜóÔ∏è</span> Exportar audio<p>Guarda el audio en el dispositivo o comp√°rtelo directamente.</p></button>
      <div class="separador"></div>
      <button class="eliminar" data-action="eliminar"><span>üóëÔ∏è</span> Eliminar Archivo</button>
    </div>
  </div>

  <div class="modal-notas" id="notes-modal">
    <h2>Mis Notas</h2>
    <button class="btn-cerrar" data-close>√ó</button>
    <div class="contenido-vacio" id="notes-empty">
      <img src="https://placehold.co/200x140" alt="Notas vac√≠as" />
      <h3>Nada para anotar</h3>
      <p>Mente despejada, p√°gina en blanco.<br>¬°Tus notas te esperan!</p>
    </div>
    <textarea id="notes-area" placeholder="Escribe tus notas"></textarea>
    <button class="btn-fab-nota" id="save-note">+</button>
  </div>

  <div class="modal-idioma" id="language-modal">
    <header>
      <button class="btn-volver" data-close>‚Äπ</button>
      <h2>Cambiar idioma de la aplicaci√≥n</h2>
    </header>
    <div class="lista-idiomas" id="language-list"></div>
  </div>

  <form class="formulario-solicitud" id="request-form">
    <header>
      <button class="btn-volver" data-close>‚Äπ</button>
      <h2>Solicitar Funci√≥n</h2>
    </header>
    <p class="descripcion">Sugerir una nueva funci√≥n para ayudarnos a<br>mejorar a√∫n m√°s Listen AI!</p>
    <label>T√≠tulo</label>
    <input type="text" placeholder="T√≠tulo de tu idea (opcional)" class="input-titulo" id="idea-title" />
    <label>Informaci√≥n</label>
    <textarea placeholder="Explicaci√≥n de tu idea" maxlength="1000" class="textarea-info" id="idea-info"></textarea>
    <span class="contador" id="char-counter">0/1000</span>
    <button type="submit" class="btn-enviar" id="send-idea">Enviar</button>
  </form>

  <input type="file" id="file-input" accept=".pdf,.docx,.txt" style="display:none" />
  <input type="file" id="image-input" accept="image/*" style="display:none" />

  <script type="module">
    // --- TTS Engine ---
    let voices = [];
    let utterance = null;

    function loadVoices(onReady) {
      const synth = window.speechSynthesis;
      const populate = () => {
        voices = synth.getVoices();
        if (voices.length && onReady) onReady(voices);
      };
      populate();
      synth.onvoiceschanged = populate;
    }

    function speak(text, voiceName, rate, onStart, onEnd) {
      const synth = window.speechSynthesis;
      if (synth.speaking) synth.cancel();
      utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = rate;
      utterance.pitch = 1;
      const voice = voices.find((v) => v.name.includes(voiceName)) || voices[0];
      utterance.voice = voice;
      utterance.onstart = () => onStart && onStart();
      utterance.onend = () => onEnd && onEnd();
      synth.speak(utterance);
      return null;
    }

    async function speakNatural(text, voiceName, rate) {
      const apiKey = localStorage.getItem('googleTTSKey') || prompt('Ingresa API Key de Google TTS (gratis 1M caracteres/mes): https://cloud.google.com/text-to-speech');
      if (!apiKey) {
        alert('Sin API Key, usando voces del sistema (menos naturales)');
        speak(text, voiceName, rate);
        return null;
      }

      const voiceMapping = {
        'Sasha': 'es-ES-Neural2-C',
        'Selena': 'es-ES-Neural2-A',
        'Ariel': 'es-ES-Wavenet-B',
        'Alex': 'es-ES-Wavenet-C',
        'Sam': 'en-US-Neural2-D',
        'Robin': 'en-GB-Neural2-C',
        'Emery': 'en-US-Neural2-F',
      };

      const voiceId = voiceMapping[voiceName] || 'es-ES-Neural2-A';
      const langCode = voiceId.substring(0, 5);

      try {
        const response = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            input: { text: text.substring(0, 5000) },
            voice: { languageCode: langCode, name: voiceId },
            audioConfig: { audioEncoding: 'MP3', speakingRate: rate, pitch: 0 },
          }),
        });

        if (!response.ok) throw new Error('API Error');

        const data = await response.json();
        const audioBlob = base64ToBlob(data.audioContent, 'audio/mp3');
        const audioUrl = URL.createObjectURL(audioBlob);
        const audio = new Audio(audioUrl);
        audio.play();
        return audio;
      } catch (error) {
        console.error('Google TTS fall√≥:', error);
        alert('Error con API de Google. Verifica tu API Key.');
        return null;
      }
    }

    function stop() {
      const synth = window.speechSynthesis;
      if (synth.speaking) synth.cancel();
    }

    function isSpeaking() {
      return window.speechSynthesis.speaking;
    }

    // --- File Processor ---
    async function extraerTextoPDF(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let textoCompleto = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map((item) => item.str).join(' ');
        textoCompleto += pageText + '\n';
      }
      return textoCompleto.trim();
    }

    async function extraerTextoDOCX(file) {
      const arrayBuffer = await file.arrayBuffer();
      const result = await window.mammoth.extractRawText({ arrayBuffer });
      return result.value;
    }

    async function escanearImagen(file, idioma = 'spa') {
      const { data: { text } } = await Tesseract.recognize(file, idioma, { logger: () => {} });
      return text;
    }

    async function extraerTextoURL(url) {
      const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
      const data = await response.json();
      const parser = new DOMParser();
      const doc = parser.parseFromString(data.contents, 'text/html');
      ['script', 'style', 'nav', 'header', 'footer', 'aside'].forEach(tag => {
        doc.querySelectorAll(tag).forEach(el => el.remove());
      });
      return doc.body.innerText.trim();
    }

    // --- Database ---
    const dbName = 'ListenAIDB';
    const dbVersion = 1;

    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(dbName, dbVersion);
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('documentos')) {
            const store = db.createObjectStore('documentos', { keyPath: 'id', autoIncrement: true });
            store.createIndex('fecha', 'fecha', { unique: false });
            store.createIndex('tipo', 'tipo', { unique: false });
            store.createIndex('estado', 'estado', { unique: false });
          }
        };
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    async function addDocumento(doc) {
      const db = await openDB();
      const tx = db.transaction('documentos', 'readwrite');
      const store = tx.objectStore('documentos');
      return store.add({
        ...doc,
        fecha: new Date().toISOString(),
        estado: 'todo',
        favorito: false,
        posicionReproduccion: 0,
        vozSeleccionada: doc.vozSeleccionada || 'Sasha',
        velocidad: doc.velocidad || 1.0,
      });
    }

    async function getDocumentos() {
      const db = await openDB();
      const tx = db.transaction('documentos', 'readonly');
      const store = tx.objectStore('documentos');
      return new Promise((resolve) => {
        const req = store.getAll();
        req.onsuccess = () => resolve(req.result || []);
      });
    }

    async function updateDocumento(id, updates) {
      const db = await openDB();
      const tx = db.transaction('documentos', 'readwrite');
      const store = tx.objectStore('documentos');
      const current = await new Promise((resolve) => {
        const req = store.get(id);
        req.onsuccess = () => resolve(req.result);
      });
      if (!current) return;
      store.put({ ...current, ...updates });
    }

    async function deleteDocumento(id) {
      const db = await openDB();
      const tx = db.transaction('documentos', 'readwrite');
      tx.objectStore('documentos').delete(id);
    }

    async function getDocumento(id) {
      const db = await openDB();
      const tx = db.transaction('documentos', 'readonly');
      const store = tx.objectStore('documentos');
      return new Promise((resolve) => {
        const req = store.get(id);
        req.onsuccess = () => resolve(req.result);
      });
    }

    // --- Main App Logic ---
    const pages = document.querySelectorAll('.page');
    const navItems = document.querySelectorAll('.nav-item');
    const modalOverlay = document.getElementById('modal-overlay');
    const voiceModal = document.getElementById('voice-modal');
    const speedModal = document.getElementById('speed-modal');
    const docMenu = document.getElementById('doc-menu');
    const notesModal = document.getElementById('notes-modal');
    const languageModal = document.getElementById('language-modal');
    const requestForm = document.getElementById('request-form');
    const docList = document.getElementById('document-list');
    const voiceBtn = document.getElementById('voice-btn');
    const speedBtn = document.getElementById('speed-btn');
    const speedSlider = document.getElementById('speed-slider');
    const speedButtons = document.getElementById('speed-buttons');
    const voiceList = document.getElementById('voice-list');
    const saveVoiceBtn = document.getElementById('save-voice');
    const playerBackBtn = document.querySelector('[data-action="back"]');
    const fab = document.getElementById('add-btn');
    const fileInput = document.getElementById('file-input');
    const imageInput = document.getElementById('image-input');
    const playerTitle = document.getElementById('player-title');
    const playerText = document.getElementById('player-text');
    const playPauseBtn = document.getElementById('play-pause');
    const backBtn = document.getElementById('backward');
    const forwardBtn = document.getElementById('forward');
    const progressBar = document.getElementById('progress-bar');
    const progress = document.getElementById('progress');
    const progressThumb = document.getElementById('progress-thumb');
    const timeStart = document.getElementById('time-start');
    const timeEnd = document.getElementById('time-end');
    const docMenuTitle = document.getElementById('doc-menu-title');
    const docMenuType = document.getElementById('doc-menu-type');
    const docPreview = document.getElementById('doc-preview');
    const docVoiceLabel = document.getElementById('doc-voice');
    const notesArea = document.getElementById('notes-area');
    const notesEmpty = document.getElementById('notes-empty');
    const charCounter = document.getElementById('char-counter');
    const sendIdea = document.getElementById('send-idea');
    const ideaInfo = document.getElementById('idea-info');
    const vozActualLabel = document.getElementById('voz-actual');

    let documentos = [];
    let filtroActual = 'todo';
    let documentoActivo = null;
    let vozSeleccionada = localStorage.getItem('vozSeleccionada') || 'Sasha';
    let velocidadActual = Number(localStorage.getItem('velocidadActual') || 1.0);
    let lecturaTimer = null;
    let lecturaInicio = null;
    let palabrasTotales = 0;
    let notas = {};
    let audioDuration = 0;
    let audioElement = null;

    const VOICES_DATA = [
      { nombre: 'Ariel', desc: 'Calidad Premium ‚Ä¢ Multiling√ºe', avatar: 'https://i.pravatar.cc/150?img=12' },
      { nombre: 'Selena', desc: 'Calidad Premium ‚Ä¢ Multiling√ºe', avatar: 'https://i.pravatar.cc/150?img=45' },
      { nombre: 'Sasha', desc: 'Calidad Premium ‚Ä¢ Multiling√ºe', avatar: 'https://i.pravatar.cc/150?img=32' },
      { nombre: 'Alex', desc: 'Calidad Premium ‚Ä¢ Multiling√ºe', avatar: 'https://i.pravatar.cc/150?img=33' },
      { nombre: 'Emery', desc: 'Calidad Premium ‚Ä¢ Multiling√ºe', avatar: 'https://i.pravatar.cc/150?img=47' },
      { nombre: 'Sam', desc: 'Calidad Premium ‚Ä¢ Multiling√ºe', avatar: 'https://i.pravatar.cc/150?img=52' },
      { nombre: 'Robin', desc: 'Calidad Premium ‚Ä¢ Multiling√ºe', avatar: 'https://i.pravatar.cc/150?img=48' },
    ];

    const IDIOMAS = [
      { nombre: 'Ingl√©s (EE. UU.)', flag: 'https://flagcdn.com/us.svg' },
      { nombre: 'Ingl√©s (Reino Unido)', flag: 'https://flagcdn.com/gb.svg' },
      { nombre: 'Espa√±ol', flag: 'https://flagcdn.com/es.svg', activo: true },
      { nombre: 'Brasile√±o', flag: 'https://flagcdn.com/br.svg' },
      { nombre: 'Portugu√©s', flag: 'https://flagcdn.com/pt.svg' },
      { nombre: 'Franc√©s', flag: 'https://flagcdn.com/fr.svg' },
      { nombre: 'Italiano', flag: 'https://flagcdn.com/it.svg' },
      { nombre: 'Alem√°n', flag: 'https://flagcdn.com/de.svg' },
      { nombre: 'Turco', flag: 'https://flagcdn.com/tr.svg' },
      { nombre: 'Chino simplificado', flag: 'https://flagcdn.com/cn.svg' },
    ];

    function switchPage(target) {
      pages.forEach((p) => p.classList.remove('active'));
      document.getElementById(target).classList.add('active');
      navItems.forEach((n) => n.classList.remove('active'));
      navItems.forEach((n) => {
        if (n.dataset.target === target) n.classList.add('active');
      });
    }

    navItems.forEach((item) => {
      item.addEventListener('click', () => switchPage(item.dataset.target));
    });

    function toggleOverlay(show) {
      modalOverlay.classList.toggle('active', show);
    }

    function openModal(modal) {
      toggleOverlay(true);
      modal.style.display = 'block';
    }

    function closeModals() {
      toggleOverlay(false);
      [voiceModal, speedModal, docMenu, notesModal, languageModal, requestForm].forEach((m) => m.style.display = 'none');
    }

    modalOverlay.addEventListener('click', closeModals);
    document.querySelectorAll('[data-close]').forEach((btn) => btn.addEventListener('click', closeModals));

    function actualizarAvatarVoz(nombre) {
      const avatarInfo = VOICES_DATA.find((v) => v.nombre === nombre);
      const img = voiceBtn.querySelector('img');
      if (img && avatarInfo) img.src = avatarInfo.avatar;
      const label = voiceBtn.querySelector('small');
      if (label) label.textContent = nombre;
      vozActualLabel.textContent = nombre;
    }

    function renderVoices() {
      voiceList.innerHTML = '';
      VOICES_DATA.forEach((voz) => {
        const card = document.createElement('div');
        card.className = 'voz-card' + (voz.nombre === vozSeleccionada ? ' activa' : '');
        card.innerHTML = `
          <div class="avatar-circular"><img src="${voz.avatar}" alt="${voz.nombre}" onerror="this.src='https://placehold.co/64x64'"/></div>
          <div class="info-voz"><h4>${voz.nombre}</h4><p>${voz.desc}</p><div class="onda-sonido">|||||||||||</div></div>
          <button class="btn-play">‚ñ∂</button>
        `;
        card.querySelector('.btn-play').addEventListener('click', () => previewVoice(voz.nombre));
        card.addEventListener('click', () => {
          vozSeleccionada = voz.nombre;
          localStorage.setItem('vozSeleccionada', vozSeleccionada);
          renderVoices();
          actualizarAvatarVoz(vozSeleccionada);
        });
        voiceList.appendChild(card);
      });
    }

    function previewVoice(name) {
      const textoDemo = 'Hola, soy ' + name + ' y estoy lista para leer tu texto con voz natural.';
      speakNatural(textoDemo, name, velocidadActual);
    }

    voiceBtn.addEventListener('click', () => {
      renderVoices();
      openModal(voiceModal);
    });

    saveVoiceBtn.addEventListener('click', () => {
      if (documentoActivo) updateDocumento(documentoActivo.id, { vozSeleccionada });
      closeModals();
    });

    function renderSpeedButtons() {
      speedButtons.innerHTML = '';
      [1.0, 1.2, 1.5, 2.0, 3.0].forEach((v) => {
        const btn = document.createElement('button');
        btn.textContent = v.toFixed(1);
        btn.addEventListener('click', () => setSpeed(v));
        speedButtons.appendChild(btn);
      });
    }

    function setSpeed(val) {
      velocidadActual = Number(val);
      localStorage.setItem('velocidadActual', velocidadActual);
      speedBtn.textContent = `${velocidadActual.toFixed(1)} x`;
      document.getElementById('velocidad-actual').textContent = `${velocidadActual.toFixed(1)} x`;
      speedSlider.value = velocidadActual;
    }

    speedBtn.addEventListener('click', () => openModal(speedModal));
    speedSlider.addEventListener('input', (e) => setSpeed(e.target.value));
    renderSpeedButtons();

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = Math.floor(seconds % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }

    function calcularDuracion(texto) {
      const palabras = texto.trim().split(/\s+/).length;
      return palabras / (2.5 * velocidadActual);
    }

    function crearDocumentoItem(doc) {
      const item = document.createElement('div');
      item.className = 'documento-item';
      const iconoTipo = {
        'escaneo': 'üì∑',
        'pdf': 'üìÑ',
        'docx': 'üìÑ',
        'archivo': 'üìÑ',
        'url': 'üîó',
        'texto': 'üìù',
        'correo': '‚úâÔ∏è'
      };
      item.innerHTML = `
        <div class="miniatura">
          ${doc.miniatura && doc.miniatura.startsWith('data:')
            ? `<img src="${doc.miniatura}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;" />`
            : (doc.miniatura ? `<img src="${doc.miniatura}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;" />` : iconoTipo[doc.tipo] || 'üìÑ')}
        </div>
        <div class="info">
          <h3>${doc.titulo}</h3>
          <p class="meta">${new Date(doc.fecha).toLocaleDateString()} - ${doc.tipo} - ${formatTime(doc.duracion)}</p>
        </div>
        <button class="menu-puntos">‚ãÆ</button>
      `;
      item.querySelector('.menu-puntos').addEventListener('click', (e) => {
        e.stopPropagation();
        abrirMenuDocumento(doc);
      });
      item.addEventListener('click', () => abrirEnReproductor(doc));
      return item;
    }

    async function renderDocumentos() {
      documentos = await getDocumentos();
      docList.innerHTML = '';
      documentos.filter(filtrarDoc).forEach((doc) => docList.appendChild(crearDocumentoItem(doc)));
    }

    function filtrarDoc(doc) {
      if (filtroActual === 'favorito') return doc.favorito;
      if (filtroActual === 'todo') return true;
      return doc.estado === filtroActual;
    }

    document.querySelectorAll('.tab').forEach((tab) => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach((t) => t.classList.remove('active'));
        tab.classList.add('active');
        filtroActual = tab.dataset.filter;
        renderDocumentos();
      });
    });

    function highlightTexto(texto) {
      const palabras = texto.split(/(\s+)/).filter(Boolean);
      palabrasTotales = palabras.filter((p) => p.trim()).length;
      playerText.innerHTML = palabras.map((p) => `<span class="palabra">${p}</span>`).join('');
    }

    async function iniciarLectura() {
      if (!documentoActivo) return;
      audioElement && audioElement.pause();
      audioElement = await speakNatural(documentoActivo.texto, vozSeleccionada, velocidadActual);
      if (!audioElement) return;

      const palabras = document.querySelectorAll('.palabra');
      audioElement.addEventListener('timeupdate', () => {
        if (!audioElement.duration) return;
        const porcentaje = audioElement.currentTime / audioElement.duration;
        progress.style.width = `${porcentaje * 100}%`;
        progressThumb.style.left = `${porcentaje * 100}%`;
        timeStart.textContent = formatTime(audioElement.currentTime);
        timeEnd.textContent = formatTime(audioElement.duration);
        const palabraActual = Math.floor(palabrasTotales * porcentaje);
        palabras.forEach((el, idx) => {
          const active = idx === palabraActual;
          el.classList.toggle('resaltado', active);
          if (active) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
      });

      audioElement.addEventListener('ended', detenerLectura);
      playPauseBtn.textContent = '‚è∏Ô∏è';
    }

    function detenerLectura() {
      if (audioElement) {
        audioElement.pause();
        audioElement = null;
      }
      stop();
      playPauseBtn.textContent = '‚ñ∂Ô∏è';
    }

    playPauseBtn.addEventListener('click', () => {
      if (!documentoActivo) return;
      if (audioElement && !audioElement.paused) {
        audioElement.pause();
        playPauseBtn.textContent = '‚ñ∂Ô∏è';
      } else if (audioElement && audioElement.paused) {
        audioElement.play();
        playPauseBtn.textContent = '‚è∏Ô∏è';
      } else {
        iniciarLectura();
      }
    });

    backBtn.addEventListener('click', () => {
      if (audioElement) audioElement.currentTime = Math.max(0, audioElement.currentTime - 10);
    });
    forwardBtn.addEventListener('click', () => {
      if (audioElement) audioElement.currentTime = Math.min(audioElement.duration || 0, audioElement.currentTime + 10);
    });

    progressBar.addEventListener('click', (e) => {
      if (!audioElement || !audioElement.duration) return;
      const rect = progressBar.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const porcentaje = clickX / rect.width;
      audioElement.currentTime = porcentaje * audioElement.duration;
    });

    let isDragging = false;
    progressThumb.addEventListener('mousedown', (e) => {
      isDragging = true;
      e.preventDefault();
    });
    document.addEventListener('mousemove', (e) => {
      if (!isDragging || !audioElement || !audioElement.duration) return;
      const rect = progressBar.getBoundingClientRect();
      let x = e.clientX - rect.left;
      x = Math.max(0, Math.min(x, rect.width));
      const porcentaje = x / rect.width;
      audioElement.currentTime = porcentaje * audioElement.duration;
    });
    document.addEventListener('mouseup', () => {
      isDragging = false;
    });

    playerBackBtn.addEventListener('click', () => {
      detenerLectura();
      switchPage('library');
    });

    function abrirEnReproductor(doc) {
      documentoActivo = doc;
      playerTitle.textContent = doc.titulo;
      highlightTexto(doc.texto);
      setSpeed(doc.velocidad || velocidadActual);
      vozSeleccionada = doc.vozSeleccionada || vozSeleccionada;
      actualizarAvatarVoz(vozSeleccionada);
      switchPage('player');
    }

    function abrirMenuDocumento(doc) {
      documentoActivo = doc;
      docMenuTitle.textContent = doc.titulo;
      docMenuType.textContent = doc.tipo;
      docVoiceLabel.textContent = doc.vozSeleccionada;
      docPreview.src = doc.miniatura || 'https://placehold.co/60x60';
      openModal(docMenu);
    }

    docMenu.querySelectorAll('.opciones-menu button').forEach((btn) => {
      btn.addEventListener('click', async () => {
        if (!documentoActivo) return;
        const action = btn.dataset.action;
        if (action === 'download') {
          const apiKey = localStorage.getItem('googleTTSKey') || prompt('Ingresa API Key de Google TTS');
          if (apiKey) {
            localStorage.setItem('googleTTSKey', apiKey.trim());
            await descargarAudio(documentoActivo, apiKey.trim());
          } else {
            alert('Se requiere API Key para descargar audio.');
          }
        }
        if (action === 'notas') {
          const note = notas[documentoActivo.id] || '';
          notesArea.value = note;
          notesEmpty.style.display = note ? 'none' : 'block';
          openModal(notesModal);
        }
        if (action === 'resumir') {
          const resumen = resumirTexto(documentoActivo.texto);
          alert(resumen);
        }
        if (action === 'finalizar') {
          await updateDocumento(documentoActivo.id, { estado: 'finalizado' });
          renderDocumentos();
        }
        if (action === 'favorito') {
          await updateDocumento(documentoActivo.id, { favorito: !documentoActivo.favorito });
          renderDocumentos();
        }
        if (action === 'temporizador') {
          const minutos = Number(prompt('Minutos para detener reproducci√≥n', '5'));
          if (minutos) setTimeout(detenerLectura, minutos * 60000);
        }
        if (action === 'eliminar') {
          await deleteDocumento(documentoActivo.id);
          renderDocumentos();
        }
        closeModals();
      });
    });

    function resumirTexto(texto, porcentaje = 30) {
      texto = texto.replace(/\n+/g, ' ').trim();
      const oraciones = texto.match(/[^.!?]+[.!?]+/g);
      if (!oraciones || oraciones.length < 3) return texto;

      const cantidad = Math.max(3, Math.ceil(oraciones.length * (porcentaje / 100)));
      const oracionesPuntuadas = oraciones.map((oracion, indice) => {
        const palabras = oracion.split(/\s+/).filter((p) => p.length > 3);
        let puntuacion = palabras.length;
        if (indice < 2) puntuacion += 10;
        if (indice >= oraciones.length - 2) puntuacion += 5;
        ['importante', 'fundamental', 'principal', 'resumen', 'conclusi√≥n', 'finalmente'].forEach((kw) => {
          if (oracion.toLowerCase().includes(kw)) puntuacion += 15;
        });
        return { texto: oracion, indice, puntuacion };
      });

      const seleccionadas = oracionesPuntuadas
        .sort((a, b) => b.puntuacion - a.puntuacion)
        .slice(0, cantidad)
        .sort((a, b) => a.indice - b.indice);

      return seleccionadas.map((o) => o.texto).join(' ');
    }

    async function descargarAudio(doc, apiKey) {
      const voiceMapping = {
        'Sasha': 'es-ES-Neural2-C',
        'Selena': 'es-ES-Neural2-A',
        'Ariel': 'es-ES-Wavenet-B',
        'Alex': 'es-ES-Wavenet-C',
        'Sam': 'en-US-Neural2-D',
        'Robin': 'en-GB-Neural2-C',
        'Emery': 'en-US-Neural2-F',
      };
      const voiceId = voiceMapping[doc.vozSeleccionada || 'Sasha'] || 'es-ES-Neural2-A';
      const response = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          input: { text: doc.texto },
          voice: { languageCode: voiceId.substring(0, 5), name: voiceId },
          audioConfig: { audioEncoding: 'MP3', speakingRate: doc.velocidad || 1.0 },
        }),
      });
      const data = await response.json();
      const blob = base64ToBlob(data.audioContent, 'audio/mp3');
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${doc.titulo}.mp3`; a.click();
    }

    function base64ToBlob(base64, mime) {
      const byteChars = atob(base64);
      const byteNumbers = new Array(byteChars.length);
      for (let i = 0; i < byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
      return new Blob([new Uint8Array(byteNumbers)], { type: mime });
    }

    const cards = document.querySelectorAll('.tarjeta-acceso');
    cards.forEach((card) => {
      card.addEventListener('click', () => handleAction(card.dataset.action));
    });

    fab.addEventListener('click', () => handleAction('texto'));

    async function handleAction(action) {
      if (action === 'archivo') fileInput.click();
      if (action === 'escanear') imageInput.click();
      if (action === 'url') {
        const url = prompt('Ingresa la URL');
        if (url) {
          const texto = await extraerTextoURL(url);
          await crearDocumentoDesdeTexto('Enlace Web', texto, 'url');
        }
      }
      if (action === 'texto') {
        const texto = prompt('Escribe o pega tu texto');
        if (texto) await crearDocumentoDesdeTexto('Texto pegado', texto, 'texto');
      }
      if (action === 'correo') {
        const texto = prompt('Pega el contenido del correo');
        if (texto) await crearDocumentoDesdeTexto('Correo', texto, 'correo');
      }
    }

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        let texto = '';
        let tipo = 'archivo';

        if (file.name.endsWith('.pdf')) {
          texto = await extraerTextoPDF(file);
          tipo = 'pdf';
        } else if (file.name.endsWith('.docx')) {
          texto = await extraerTextoDOCX(file);
          tipo = 'docx';
        } else if (file.name.endsWith('.txt')) {
          texto = await file.text();
          tipo = 'texto';
        } else {
          throw new Error('Formato no soportado');
        }

        if (!texto || texto.trim().length < 10) {
          throw new Error('El archivo no contiene texto v√°lido');
        }

        await crearDocumentoDesdeTexto(file.name, texto, tipo);
      } catch (error) {
        alert(`‚ùå Error procesando archivo: ${error.message}`);
        console.error(error);
      } finally {
        fileInput.value = '';
      }
    });

    imageInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const loading = document.createElement('div');
      loading.textContent = 'üîÑ Escaneando texto...';
      loading.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#FFF;padding:20px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.2);z-index:999;';
      document.body.appendChild(loading);

      try {
        const texto = await escanearImagen(file, 'spa');

        if (!texto || texto.trim().length < 5) {
          throw new Error('No se detect√≥ texto en la imagen');
        }

        await crearDocumentoDesdeTexto('Escaneo - ' + new Date().toLocaleDateString(), texto, 'escaneo');
      } catch (error) {
        alert(`‚ùå Error escaneando imagen: ${error.message}`);
        console.error(error);
      } finally {
        document.body.removeChild(loading);
        imageInput.value = '';
      }
    });

    function generarMiniaturaTexto(texto) {
      return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        canvas.width = 120;
        canvas.height = 120;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, 120, 120);
        ctx.strokeStyle = '#E5E5E5';
        ctx.lineWidth = 2;
        ctx.strokeRect(0, 0, 120, 120);
        ctx.fillStyle = '#666';
        ctx.font = '10px Inter, sans-serif';
        const lineas = texto.substring(0, 100).split('\n').slice(0, 8);
        lineas.forEach((linea, i) => {
          ctx.fillText(linea.substring(0, 20), 5, 15 + (i * 12));
        });
        resolve(canvas.toDataURL());
      });
    }

    async function crearDocumentoDesdeTexto(titulo, texto, tipo) {
      let miniatura = 'https://placehold.co/60x60/F5F5F5/666?text=üìÑ';
      if (tipo === 'pdf' || tipo === 'archivo' || tipo === 'docx') {
        miniatura = await generarMiniaturaTexto(texto);
      } else if (tipo === 'escaneo') {
        miniatura = 'https://placehold.co/60x60/F5F5F5/666?text=üì∑';
      } else if (tipo === 'url') {
        miniatura = 'https://placehold.co/60x60/F5F5F5/666?text=üîó';
      }

      const doc = {
        titulo,
        texto,
        tipo,
        duracion: calcularDuracion(texto),
        miniatura,
        vozSeleccionada,
        velocidad: velocidadActual,
      };
      await addDocumento(doc);
      renderDocumentos();
      switchPage('library');
    }

    notesArea.addEventListener('input', () => {
      notesEmpty.style.display = notesArea.value ? 'none' : 'block';
    });

    document.getElementById('save-note').addEventListener('click', () => {
      if (documentoActivo) {
        notas[documentoActivo.id] = notesArea.value;
        closeModals();
      }
    });

    function renderIdiomas() {
      const container = document.getElementById('language-list');
      container.innerHTML = '';
      IDIOMAS.forEach((idioma) => {
        const item = document.createElement('div');
        item.className = 'idioma-item' + (idioma.activo ? ' activo' : '');
        item.innerHTML = `<img src="${idioma.flag}" alt="${idioma.nombre}" /><span>${idioma.nombre}</span>`;
        item.addEventListener('click', () => {
          IDIOMAS.forEach((i) => i.activo = false);
          idioma.activo = true;
          renderIdiomas();
        });
        container.appendChild(item);
      });
    }

    requestForm.addEventListener('submit', (e) => {
      e.preventDefault();
      alert('¬°Gracias por tu sugerencia!');
      closeModals();
    });

    ideaInfo.addEventListener('input', () => {
      charCounter.textContent = `${ideaInfo.value.length}/1000`;
      sendIdea.classList.toggle('activo', ideaInfo.value.length > 0);
    });

    document.querySelectorAll('[data-action="idioma"]').forEach((el) => el.addEventListener('click', () => {
      renderIdiomas();
      openModal(languageModal);
    }));

    document.querySelectorAll('[data-action="solicitar"]').forEach((el) => el.addEventListener('click', () => openModal(requestForm)));

    document.querySelectorAll('[data-action="cambiar-voz"]').forEach((el) => el.addEventListener('click', () => {
      renderVoices();
      openModal(voiceModal);
    }));

    document.querySelectorAll('[data-action="compartir"]').forEach((el) => el.addEventListener('click', () => {
      navigator.share ? navigator.share({ title: 'Listen AI', text: 'Prueba este clon de Listen AI', url: location.href }) : alert('Compartir no soportado');
    }));

    window.addEventListener('DOMContentLoaded', () => {
      const apiKey = localStorage.getItem('googleTTSKey');
      if (!apiKey) {
        const mensaje = `
      üéôÔ∏è VOCES NATURALES DISPONIBLES
      
      Esta app usa Google Cloud Text-to-Speech para voces ultra-naturales.
      
      ‚úÖ Es GRATIS: 1 mill√≥n de caracteres/mes
      ‚úÖ Sin tarjeta de cr√©dito requerida
      
      Pasos:
      1. Ve a: https://cloud.google.com/text-to-speech
      2. Crea proyecto gratis
      3. Habilita Text-to-Speech API
      4. Genera API Key
      5. P√©gala aqu√≠ abajo
      
      (Tambi√©n funciona sin API Key pero con voces menos naturales)
    `;
        const key = prompt(mensaje);
        if (key) {
          localStorage.setItem('googleTTSKey', key.trim());
          alert('‚úÖ API Key guardada. ¬°Disfruta de voces ultra-naturales!');
        } else {
          alert('‚ö†Ô∏è Sin API Key se usar√°n voces del sistema (menos naturales)');
        }
      }

      loadVoices(() => renderVoices());
      setSpeed(velocidadActual);
      actualizarAvatarVoz(vozSeleccionada);
      renderDocumentos();
      renderIdiomas();
    });
  </script>
</body>
</html>
