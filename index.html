<!--
  README DE USO RÃPIDO
  1. Al cargar la app se pedirÃ¡ tu API Key de Google Cloud Text-to-Speech (gratis 1M caracteres/mes). GuÃ¡rdala para voces naturales.
  2. Puedes cargar PDF/DOCX/TXT, escanear imÃ¡genes, pegar texto, URL o correos y se guardarÃ¡n en IndexedDB.
  3. El reproductor sincroniza el resaltado de palabras, la barra de progreso es clickeable/arrastrable y puedes cambiar velocidad/voz.
  4. Todas las funciones estÃ¡n habilitadas y las voces muestran avatares realistas.
-->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Listen AI Clone</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.cdnfonts.com/css/open-dyslexic" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    :root {
      --amarillo-principal: #FFB800;
      --amarillo-dorado: #FFB800;
      --naranja-botones: #FF9500;
      --fondo-blanco: #FFFFFF;
      --fondo-gris-claro: #F5F5F5;
      --fondo-rosa-pastel: linear-gradient(180deg, #FFE8E6 0%, #FFDAB9 100%);
      --texto-negro: #1A1A1A;
      --texto-gris: #666666;
      --texto-gris-claro: #999999;
      --borde-gris: #E5E5E5;
      --azul-icono: #5BA3F5;
      --sombra-suave: rgba(0,0,0,0.08);
      font-family: 'Inter', 'SF Pro Display', system-ui, -apple-system, sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--fondo-rosa-pastel); color: var(--texto-negro); }
    #app { min-height: 100vh; padding-bottom: 80px; display: none; }

    .page { display: none; padding: 16px; }
    .page.active { display: block; }

    /* --- Auth Screen --- */
    #auth-screen {
      display: none;
      min-height: 100vh;
      background: var(--fondo-rosa-pastel);
      padding: 32px 16px 24px;
      color: var(--texto-negro);
      align-items: center;
      justify-content: center;
    }
    .auth-card {
      width: min(420px, 100%);
      background: #fff;
      border-radius: 20px;
      padding: 28px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
      border: 1px solid #FFE0B2;
      display: flex;
      flex-direction: column;
      gap: 16px;
      animation: fadeIn 0.4s ease;
    }
    .auth-logo {
      width: 64px;
      height: 64px;
      border-radius: 18px;
      background: linear-gradient(135deg, var(--amarillo-principal), var(--naranja-botones));
      color: #fff;
      display: grid;
      place-items: center;
      font-size: 26px;
      font-weight: 800;
      margin: 0 auto;
      box-shadow: 0 10px 28px rgba(255, 149, 0, 0.32);
    }
    .auth-toggle {
      display: flex;
      background: #f9f9f9;
      padding: 6px;
      border-radius: 14px;
      border: 1px solid #f0f0f0;
      gap: 6px;
    }
    .auth-toggle button {
      flex: 1;
      border: none;
      padding: 10px 12px;
      border-radius: 10px;
      background: transparent;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .auth-toggle button.active { background: #fff; color: var(--texto-negro); box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
    .auth-title { text-align: center; font-size: 24px; font-weight: 800; }
    .auth-subtitle { text-align: center; color: var(--texto-gris); font-size: 14px; }
    .auth-form { display: flex; flex-direction: column; gap: 12px; }
    .auth-form label { font-weight: 700; font-size: 14px; color: var(--texto-gris); }
    .auth-form input[type="email"], .auth-form input[type="password"] {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: 1.5px solid #E5E5E5;
      font-size: 16px;
      transition: border 0.2s ease;
    }
    .auth-form input:focus { border-color: var(--amarillo-principal); outline: none; box-shadow: 0 0 0 3px rgba(255, 184, 0, 0.18); }
    .auth-actions { display: flex; align-items: center; justify-content: space-between; }
    .auth-button {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--amarillo-principal), var(--naranja-botones));
      color: #fff;
      font-weight: 800;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(255, 149, 0, 0.28);
      transition: transform 0.15s ease, box-shadow 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .auth-button-ghost {
      background: transparent;
      color: var(--naranja-botones);
      border: 2px solid var(--naranja-botones);
      box-shadow: none;
    }
    .auth-button-ghost:hover { background: rgba(255, 149, 0, 0.08); }
    .auth-button:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; transform: none; }
    .auth-links { display: flex; justify-content: space-between; font-size: 14px; color: var(--texto-gris); }
    .auth-links a { color: var(--naranja-botones); text-decoration: none; font-weight: 700; }
    .auth-error { background: #FFE8E6; color: #C0392B; padding: 12px; border-radius: 12px; border: 1px solid #F5B7B1; font-weight: 600; display: none; }
    .auth-success { background: #E7F9EF; color: #1B8E5A; padding: 12px; border-radius: 12px; border: 1px solid #C9F0D7; font-weight: 600; display: none; }
    .remember-me { display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--texto-gris); }
    .auth-loader { width: 16px; height: 16px; border: 3px solid #fff; border-top-color: rgba(255,255,255,0.2); border-radius: 50%; animation: spin 0.8s linear infinite; }

    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity:1; transform: translateY(0);} }

    .promo-banner {
      background: linear-gradient(135deg, #FFF6F2, #FFE7D1);
      border-radius: 20px;
      padding: 20px;
      min-height: 190px;
      position: relative;
      box-shadow: 0 6px 18px rgba(255, 149, 0, 0.15);
      overflow: hidden;
    }
    .promo-illustration {
      position: absolute;
      inset: 0;
    }
    .btn-secondary {
      position: absolute;
      top: 16px;
      right: 16px;
      background: #fff;
      border: 1px solid #FFE0B2;
      border-radius: 20px;
      padding: 10px 20px;
      font-weight: 700;
      cursor: pointer;
      color: var(--texto-negro);
      box-shadow: 0 6px 12px rgba(0,0,0,0.06);
    }
    .carousel-dots { position: absolute; bottom: 16px; left: 20px; display: flex; gap: 6px; }
    .carousel-dots span { width: 8px; height: 8px; border-radius: 50%; background: #FFD9A0; opacity: 0.5; }
    .carousel-dots span.active { width: 18px; border-radius: 10px; opacity: 1; background: var(--naranja-botones); }
    .section-header h2 { font-size: 22px; font-weight: 700; margin: 24px 0 16px; }
    .access-cards { display: flex; flex-direction: column; gap: 12px; }
    .tarjeta-acceso {
      background: #fff;
      border-radius: 16px;
      padding: 18px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: transform 0.15s ease, box-shadow 0.2s ease;
    }
    .tarjeta-acceso:active { transform: translateY(1px) scale(0.995); box-shadow: 0 6px 16px rgba(255,149,0,0.18); }
    .tarjeta-acceso .ripple {
      position: absolute;
      border-radius: 50%;
      transform: scale(0);
      animation: ripple 0.5s linear;
      background: rgba(91, 163, 245, 0.25);
      pointer-events: none;
    }
    @keyframes ripple {
      to { transform: scale(4); opacity: 0; }
    }
    @keyframes blinkWarning {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.35; }
    }
    .icon-card {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: #FFF3E0;
      display: grid;
      place-items: center;
      font-size: 20px;
    }
    .tarjeta-acceso h3 { font-size: 17px; font-weight: 600; }
    .tarjeta-acceso p { font-size: 14px; color: var(--texto-gris); }

    .library-header { display: flex; align-items: center; justify-content: space-between; margin: 16px 0; gap: 12px; }
    .lib-left { display: flex; align-items: center; gap: 12px; }
    .ai-chip { width: 44px; height: 44px; border-radius: 14px; background: #E7F1FF; color: #2F80ED; display: grid; place-items: center; font-weight: 800; box-shadow: 0 4px 10px rgba(91,163,245,0.25); }
    .library-header h1 { font-size: 30px; font-weight: 800; margin-left: 4px; }
    .lib-icons { display: flex; gap: 10px; align-items: center; }
    .progress-circle { width: 42px; height: 42px; border-radius: 50%; border: 3px solid var(--azul-icono); display: grid; place-items: center; background: #fff; }
    .circle-text { color: var(--azul-icono); font-weight: 700; }
    .circle-text.blink-danger { color: #FF3B30; animation: blinkWarning 1s infinite; }
    .star-counter { background: #FFF3E0; padding: 6px 10px; border-radius: 12px; color: var(--amarillo-principal); font-weight: 700; border: 1px solid #FFE0B2; }

    .tabs { display: flex; gap: 8px; margin: 16px 0; overflow-x: auto; }
    .tab { border: none; padding: 10px 20px; border-radius: 24px; background: #F0F0F0; color: var(--texto-gris); font-weight: 600; cursor: pointer; }
    .tab.active { background: var(--texto-negro); color: #fff; }
    .guest-warning { background: #fff3cd; color: #8a6d3b; border: 1px solid #ffeeba; padding: 12px 14px; border-radius: 12px; margin-bottom: 12px; font-weight: 600; }

    #document-list { display: flex; flex-direction: column; gap: 12px; }
    .documento-item { background: #fff; border-radius: 14px; padding: 12px; display: flex; align-items: center; gap: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #FFE0B2; }
    .documento-item .miniatura { width: 64px; height: 64px; border-radius: 12px; background: #fff3e0; display: grid; place-items: center; font-size: 24px; color: var(--naranja-botones); overflow: hidden; box-shadow: inset 0 0 0 1px #FFE0B2; }
    .documento-item h3 { font-size: 16px; font-weight: 700; color: var(--texto-negro); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .documento-item .meta { font-size: 13px; color: var(--texto-gris); margin-top: 4px; display: flex; gap: 8px; align-items: center; }
    .documento-item .meta span { background: #F9F9F9; padding: 4px 8px; border-radius: 10px; border: 1px solid #EEE; }
    .menu-puntos { margin-left: auto; border: none; background: transparent; font-size: 24px; color: var(--texto-gris); cursor: pointer; padding: 8px; }

    .player-toolbar { height: 56px; display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #fff; position: sticky; top: 0; }
    .icon-btn { width: 40px; height: 40px; border: none; background: transparent; font-size: 20px; cursor: pointer; }
    .player-body { background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    #player-title { font-size: 20px; font-weight: 700; text-align: center; margin-bottom: 12px; }
    .text-reader-wrapper { position: relative; }
    .text-container {
      max-height: 320px;
      overflow-y: auto;
      background: var(--texto-lector-bg, #fff);
      padding: 12px;
      line-height: var(--texto-lector-line-height, 1.6);
      font-size: var(--texto-lector-size, 18px);
      color: var(--texto-lector-color, var(--texto-negro));
      border: 1px solid var(--borde-gris);
      border-radius: 12px;
      letter-spacing: var(--texto-lector-letter, 0);
      word-spacing: var(--texto-lector-word, 0);
      text-align: var(--texto-lector-align, left);
      max-width: var(--column-width, 800px);
      margin: 0 auto;
      transition: background 0.2s ease, color 0.2s ease, font-size 0.2s ease, line-height 0.2s ease, letter-spacing 0.2s ease, word-spacing 0.2s ease, max-width 0.2s ease;
    }
    .text-container .texto-parrafo { margin-bottom: var(--texto-lector-paragraph, 1em); }
    .text-container .palabra { padding: 0 2px; border-radius: 4px; }
    .text-container .palabra.resaltado,
    .text-container .palabra.highlight-word { background: #FFB74D; color: #1A1A1A; transition: background 0.2s ease; }
    .text-container .palabra.highlight-sentence { background: #FFF59D; }
    .text-config-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.25); display: none; z-index: 60; }
    .text-config-overlay.active { display: block; }
    .text-config-panel {
      position: fixed;
      right: 12px;
      top: 72px;
      width: min(420px, 94%);
      background: #fff;
      border: 1px solid var(--borde-gris);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.12);
      z-index: 80;
      display: none;
      flex-direction: column;
      gap: 12px;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
    }
    .text-config-panel.open { display: flex; }
    .text-config-panel.docked { top: 12px; bottom: 12px; max-height: none; }
    .text-config-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; position: sticky; top: 0; background: #fff; padding-bottom: 8px; z-index: 2; }
    .text-config-title { font-size: 18px; font-weight: 800; display: flex; align-items: center; gap: 8px; }
    .text-config-actions { display: flex; gap: 8px; }
    .text-config-actions button { border: 1px solid var(--borde-gris); border-radius: 10px; padding: 6px 10px; background: #F9F9F9; cursor: pointer; font-weight: 700; }
    .config-section { background: #FFFDF7; border: 1px solid #FFE0B2; border-radius: 12px; padding: 10px; }
    .config-section summary { font-weight: 700; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center; }
    .config-section[open] summary::after { content: 'âˆ’'; }
    .config-section summary::after { content: '+'; font-size: 18px; }
    .config-controls { margin-top: 8px; display: flex; flex-direction: column; gap: 8px; }
    .control-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; }
    .chip { border: 1px solid var(--borde-gris); background: #fff; padding: 10px; border-radius: 10px; cursor: pointer; font-weight: 700; text-align: center; }
    .chip.active { border-color: var(--naranja-botones); box-shadow: 0 4px 12px rgba(255,149,0,0.2); }
    .slider-row { display: flex; align-items: center; gap: 8px; }
    .slider-row input[type="range"] { flex: 1; accent-color: var(--naranja-botones); }
    .color-presets { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 8px; }
    .color-preset { border: 1px solid var(--borde-gris); border-radius: 10px; padding: 8px; display: flex; align-items: center; gap: 10px; cursor: pointer; background: #fff; font-weight: 600; }
    .swatch { width: 32px; height: 32px; border-radius: 10px; border: 1px solid #E0E0E0; box-shadow: inset 0 0 0 2px #fff; }
    .dual-swatches { display: flex; gap: 6px; }
    .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .input-row label { font-size: 13px; color: var(--texto-gris); font-weight: 700; }
    .input-row input { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid var(--borde-gris); }
    .preview-box { border: 1px solid var(--borde-gris); background: #FFFDF7; padding: 12px; border-radius: 12px; }
    .preview-box h4 { margin-bottom: 6px; }
    .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; border: 1px solid var(--borde-gris); border-radius: 10px; background: #fff; }
    .column-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; }
    .text-config-footer { display: flex; gap: 10px; position: sticky; bottom: 0; background: #fff; padding-top: 8px; }
    .text-config-footer button { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: 800; cursor: pointer; }
    .btn-reset { background: #FFE8E6; color: #B23B3B; border: 1px solid #FFC2BD; }
    .btn-save { background: linear-gradient(135deg, #FFB800, #FF9500); color: #fff; box-shadow: 0 6px 18px rgba(255,149,0,0.25); }
    .font-select { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid var(--borde-gris); }
    .pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; background: #F7F9FD; border-radius: 999px; font-size: 13px; border: 1px solid #E1E8FF; }
    .highlight-legend { display: flex; gap: 8px; flex-wrap: wrap; }

    .progress-area { position: relative; margin: 20px 0; }
    .progress-bar { height: 4px; background: #E5E5E5; border-radius: 4px; position: relative; }
    .progress { height: 100%; width: 0; background: linear-gradient(90deg, var(--naranja-botones), var(--amarillo-principal)); border-radius: 4px; }
    .thumb { width: 16px; height: 16px; border-radius: 50%; background: var(--naranja-botones); position: absolute; top: -6px; left: 0; transform: translateX(-50%); }
    .time { position: absolute; top: -18px; font-size: 14px; color: var(--texto-gris-claro); }
    .time.start { left: 0; }
    .time.end { right: 0; }

    .controles { display: flex; justify-content: center; align-items: center; gap: 32px; margin: 28px 0; }
    .ctrl-btn { width: 48px; height: 48px; border-radius: 50%; border: none; background: #fff; font-size: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); cursor: pointer; }
    .play-btn { width: 72px; height: 72px; border-radius: 50%; border: none; background: linear-gradient(180deg, var(--amarillo-dorado), var(--naranja-botones)); color: #fff; font-size: 32px; box-shadow: 0 6px 20px rgba(255,165,0,0.3); cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 6px; transition: opacity 0.2s ease; }
    .play-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .play-btn .inline-spinner { width: 18px; height: 18px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.4); border-top-color: #fff; animation: spin 0.9s linear infinite; }
    .footer-player { display: flex; justify-content: space-between; align-items: center; padding: 0 12px; }
    .speed-control button { background: #FFF3E0; border: 1px solid var(--amarillo-principal); border-radius: 24px; padding: 8px 14px; font-weight: 600; cursor: pointer; }
    .voice-control { display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; }
    .voice-control .avatar { width: 64px; height: 64px; border-radius: 50%; overflow: hidden; }
    .voice-control img { width: 100%; height: 100%; object-fit: cover; }
    .voice-control small { font-size: 14px; font-weight: 600; }

    .voice-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #ddd;
      transition: transform 0.3s ease, border-color 0.3s ease;
    }

    .voice-avatar:hover {
      transform: scale(1.1);
      border-color: var(--naranja-principal);
    }

    .voice-item.selected .voice-avatar {
      border-color: var(--naranja-principal);
      box-shadow: 0 0 0 4px rgba(255, 152, 0, 0.2);
    }

    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: #fff; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-around; align-items: center; z-index: 20; }
    .nav-item { flex: 1; background: none; border: none; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: #999; font-size: 12px; padding-top: 4px; position: relative; }
    .nav-item .icon { font-size: 24px; }
    .nav-item.active { color: var(--amarillo-principal); }
    .nav-item.active::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--amarillo-principal); }

    .fab { position: fixed; bottom: 84px; right: 24px; width: 64px; height: 64px; border-radius: 50%; border: none; background: linear-gradient(180deg, var(--amarillo-dorado), var(--naranja-botones)); color: #fff; font-size: 32px; box-shadow: 0 4px 16px rgba(255,165,0,0.4); cursor: pointer; z-index: 10; }

    .settings-page { padding: 16px; display: flex; flex-direction: column; gap: 14px; }
    .config-seccion { background: #fff; border-radius: 16px; padding: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #FFE0B2; }
    .titulo-seccion { font-size: 14px; color: #999; text-transform: uppercase; margin: 12px 0 6px 12px; letter-spacing: 0.5px; }
    .config-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-top: 1px solid var(--borde-gris); cursor: pointer; transition: background 0.2s; }
    .config-item:hover { background: #FFF8EC; }
    .config-item:first-of-type { border-top: none; }
    .icono-config { width: 42px; height: 42px; border-radius: 50%; background: #FFF3E0; display: grid; place-items: center; font-size: 18px; color: var(--naranja-botones); box-shadow: inset 0 0 0 1px #FFE0B2; }
    .config-item span { font-size: 16px; font-weight: 600; }
    .valor-actual, .flecha { margin-left: auto; color: #666; font-size: 14px; font-weight: 600; }
    .cuenta-item { display: flex; align-items: center; gap: 10px; padding: 12px; border-top: 1px solid var(--borde-gris); }
    .icono-servicio { width: 28px; height: 28px; }
    .btn-desconectar { margin-left: auto; background: #FF3B30; color: #fff; border: none; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 700; cursor: pointer; box-shadow: 0 6px 12px rgba(255,59,48,0.22); }
    .descripcion-cuenta { color: var(--texto-gris); font-size: 14px; padding: 0 12px 12px; }

    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.25); z-index: 30; }
    .modal-overlay.active { display: block; }
    .modal-voz, .modal-velocidad, .modal-documento, .modal-notas, .modal-idioma, .formulario-solicitud, .modal-editar { display: none; position: fixed; z-index: 40; left: 0; right: 0; }
    .modal-voz { bottom: 0; background: #fff; border-radius: 24px 24px 0 0; padding: 24px 20px; max-height: 85vh; overflow-y: auto; }
    .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .modal-header h3 { font-size: 22px; font-weight: 700; }
    .btn-cerrar, .btn-info { background: none; border: none; font-size: 20px; cursor: pointer; }
    .lista-voces { display: flex; flex-direction: column; gap: 12px; }
    .voz-card { display: flex; align-items: center; gap: 12px; padding: 16px; border-radius: 16px; background: linear-gradient(180deg, #FFFDFC, #FFF6EA); border: 2.5px solid transparent; box-shadow: 0 4px 12px rgba(0,0,0,0.04); }
    .voz-card.activa { border-color: var(--amarillo-dorado); box-shadow: 0 6px 16px rgba(255,184,0,0.18); }
    .voice-avatar-wrapper { display: flex; flex-direction: column; align-items: center; gap: 6px; min-width: 80px; }
    .voice-language { display: inline-flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 800; color: #fff; background: #2C3E50; padding: 4px 8px; border-radius: 999px; box-shadow: 0 6px 14px rgba(0,0,0,0.08); letter-spacing: 0.3px; }
    .voice-name { font-size: 14px; font-weight: 700; color: var(--texto-negro); text-align: center; }
    .info-voz { flex: 1; }
    .info-voz h4 { font-size: 17px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .info-voz p { font-size: 13px; color: var(--texto-gris); margin-top: 2px; }
    .onda-sonido { color: #FFC766; letter-spacing: 1px; margin-top: 4px; font-weight: 700; }
    .btn-play { margin-left: auto; width: 42px; height: 42px; border-radius: 50%; background: var(--amarillo-principal); border: none; cursor: pointer; font-size: 18px; color: #fff; box-shadow: 0 6px 14px rgba(255,184,0,0.35); }
    .btn-guardar { width: calc(100% - 40px); height: 54px; background: #1A1A1A; color: #fff; border: none; border-radius: 27px; font-size: 18px; font-weight: 700; position: sticky; bottom: 20px; margin: 20px auto 0; display: block; box-shadow: 0 10px 24px rgba(0,0,0,0.18); }

    .modal-velocidad { bottom: 0; background: #fff; border-radius: 24px 24px 0 0; padding: 24px 20px; max-height: 70vh; box-shadow: 0 -8px 24px rgba(0,0,0,0.08); }
    .velocidad-actual { font-size: 26px; font-weight: 800; margin-bottom: 12px; text-align: center; }
    .slider-velocidad { width: 100%; accent-color: var(--naranja-botones); }
    .marcas-velocidad { display: flex; justify-content: space-between; color: var(--texto-gris); margin-top: 6px; font-weight: 600; }
    .velocidades-rapidas { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }

    .modal-editar {
      background: #fff;
      border-radius: 20px;
      padding: 20px;
      max-width: 520px;
      width: 92%;
      margin: 80px auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    .modal-editar h3 { font-size: 20px; font-weight: 800; margin-bottom: 12px; }
    .modal-editar label { display: block; margin: 8px 0 4px; font-weight: 600; color: #444; }
    .modal-editar input, .modal-editar textarea {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #E5E5E5;
      font-size: 15px;
      font-family: 'Inter', sans-serif;
      background: #fafafa;
    }
    .modal-editar textarea { min-height: 140px; resize: vertical; line-height: 1.5; }
    .editar-acciones { display: flex; gap: 10px; margin-top: 14px; justify-content: flex-end; }
    .btn-secundario { background: #F5F5F5; color: #444; border: none; padding: 12px 16px; border-radius: 12px; font-weight: 700; cursor: pointer; }
    .btn-primario { background: linear-gradient(135deg, #FFB800, #FF9500); color: #fff; border: none; padding: 12px 18px; border-radius: 12px; font-weight: 800; cursor: pointer; box-shadow: 0 8px 18px rgba(255,149,0,0.25); }

    .loader-proceso {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.15);
      z-index: 45;
      align-items: center;
      justify-content: center;
    }
    .loader-card {
      background: #fff;
      padding: 18px 20px;
      border-radius: 16px;
      box-shadow: 0 10px 28px rgba(0,0,0,0.18);
      display: flex;
      gap: 12px;
      align-items: center;
      min-width: 260px;
    }
    .loader-spinner {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 4px solid #FFE2AE;
      border-top-color: #FF9500;
      animation: girar 0.9s linear infinite;
    }
    .loader-card strong { display: block; font-size: 15px; }
    .loader-card small { color: #666; }
    @keyframes girar { to { transform: rotate(360deg); } }
    .velocidades-rapidas button { padding: 10px 14px; border-radius: 16px; border: 1px solid #FFE0B2; background: #FFF8EC; cursor: pointer; font-weight: 700; color: var(--texto-negro); min-width: 64px; }

    .selector-documento { bottom: 0; background: #fff; border-radius: 24px 24px 0 0; padding: 24px; position: fixed; left: 0; right: 0; z-index: 45; box-shadow: 0 -10px 30px rgba(0,0,0,0.14); }
    .selector-documento h3 { font-size: 20px; font-weight: 800; margin-bottom: 12px; text-align: center; }
    .selector-opciones { display: grid; gap: 12px; }
    .selector-opciones button { padding: 14px; border-radius: 14px; border: 1px solid var(--borde-gris); background: #FFF8EC; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 12px; box-shadow: 0 4px 14px rgba(255,184,0,0.12); }
    .selector-opciones button span { font-size: 22px; }
    .selector-opciones button.secondary { background: #F6F8FF; border-color: #DFE7FF; box-shadow: 0 4px 14px rgba(91,163,245,0.12); }
    .selector-opciones small { color: var(--texto-gris); font-weight: 500; display: block; }

    .modal-documento { top: 8%; bottom: 8%; margin: 0 14px; background: #fff; border-radius: 18px; padding: 16px; overflow-y: auto; box-shadow: 0 8px 30px rgba(0,0,0,0.08); }
    .header-menu { display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--borde-gris); padding-bottom: 10px; }
    .header-menu .acciones { margin-left: auto; display: flex; align-items: center; gap: 8px; }
    .btn-editar { background: #FFF3E0; border: 1px solid #FFE0B2; border-radius: 10px; padding: 8px 10px; cursor: pointer; font-weight: 700; }
    .preview-mini { width: 60px; height: 60px; border-radius: 12px; object-fit: cover; background: #fff3e0; box-shadow: inset 0 0 0 1px #FFE0B2; }
    .opciones-menu { display: flex; flex-direction: column; gap: 8px; padding-top: 12px; }
    .opciones-menu button { text-align: left; padding: 12px; border-radius: 12px; border: 1px solid var(--borde-gris); background: #fff; cursor: pointer; display: flex; gap: 10px; align-items: center; font-weight: 600; }
    .opciones-menu button p { margin: 4px 0 0; color: var(--texto-gris); font-weight: 500; }
    .opciones-menu .eliminar { color: #FF3B30; border-color: #FFD1CF; }
    .opciones-menu .separador { height: 1px; background: var(--borde-gris); margin: 6px 0; }

    .modal-notas { top: 8%; bottom: 8%; margin: 0 14px; background: #fff; border-radius: 18px; padding: 16px; display: flex; flex-direction: column; gap: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); position: relative; }
    .modal-notas h2 { font-size: 20px; font-weight: 800; text-align: center; }
    .contenido-vacio { display: grid; place-items: center; gap: 8px; text-align: center; color: var(--texto-gris); }
    .modal-notas textarea { width: 100%; min-height: 160px; border: 1px solid var(--borde-gris); border-radius: 12px; padding: 12px; font-size: 16px; }
    .btn-fab-nota { align-self: center; width: 56px; height: 56px; border-radius: 50%; border: none; background: var(--amarillo-principal); color: #fff; font-size: 28px; box-shadow: 0 6px 16px rgba(255,184,0,0.35); cursor: pointer; position: sticky; bottom: 12px; }
    .btn-borrar-nota { background: #FFE8E6; border: 1px solid #FFC2BD; color: #FF3B30; border-radius: 12px; padding: 10px 12px; font-weight: 700; cursor: pointer; }

    .modal-idioma { top: 0; bottom: 0; background: #fff; padding: 16px; overflow-y: auto; }
    .modal-idioma header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
    .modal-idioma h2 { font-size: 20px; font-weight: 800; }
    .lista-idiomas { display: flex; flex-direction: column; gap: 10px; }
    .idioma-item { display: flex; align-items: center; gap: 12px; padding: 14px; border-radius: 14px; border: 1px solid var(--borde-gris); cursor: pointer; background: #fff; font-weight: 700; }
    .idioma-item img { width: 32px; height: 20px; object-fit: cover; }
    .idioma-item.activo { border: 2px solid var(--amarillo-dorado); background: #FFFDF6; box-shadow: 0 6px 14px rgba(255,184,0,0.2); }

    .formulario-solicitud { top: 0; bottom: 0; background: #fff; padding: 16px; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; }
    .formulario-solicitud h2 { font-size: 20px; font-weight: 700; }
    .formulario-solicitud .descripcion { color: var(--texto-gris); line-height: 1.4; }
    .input-titulo { border: none; border-bottom: 2px solid var(--borde-gris); padding: 10px 6px; font-size: 16px; }
    .textarea-info { border: 1px solid var(--borde-gris); border-radius: 12px; padding: 16px; min-height: 200px; font-size: 16px; }
    .contador { text-align: right; color: var(--texto-gris-claro); }
    .btn-enviar { background: #F0F0F0; border: none; padding: 14px; border-radius: 12px; font-weight: 600; font-size: 16px; cursor: pointer; }
    .btn-enviar.activo { background: var(--naranja-botones); color: #fff; }

    .hidden { display: none !important; }

    /* --- Popups y toasts personalizados --- */
    .popup-toast {
      position: fixed;
      bottom: -100px;
      left: 50%;
      transform: translateX(-50%);
      background: #1A1A1A;
      color: #FFF;
      padding: 16px 24px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      z-index: 9999;
      transition: bottom 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      max-width: 90%;
    }

    .popup-toast.show { bottom: 100px; }
    .popup-toast.success { background: #34C759; }
    .popup-toast.error { background: #FF3B30; }

    .popup-icon { font-size: 24px; }

    .popup-confirmacion,
    .popup-input {
      background: #FFF;
      border-radius: 20px;
      padding: 28px;
      max-width: 400px;
      width: 90%;
      margin: auto;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .popup-confirmacion h3,
    .popup-input h3 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 12px;
      text-align: center;
    }

    .popup-confirmacion p { font-size: 15px; color: #666; line-height: 1.5; text-align: center; margin-bottom: 24px; }

    .popup-input input {
      width: 100%;
      padding: 14px;
      border: 2px solid #E5E5E5;
      border-radius: 12px;
      font-size: 16px;
      margin-bottom: 20px;
    }

    .popup-input input:focus { outline: none; border-color: #FFB800; }

    .popup-actions { display: flex; gap: 12px; }
    .popup-actions button {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-cancel { background: #F5F5F5; color: #666; }
    .btn-confirm, .btn-submit { background: linear-gradient(135deg, #FFB800, #FF9500); color: #FFF; }

    /* --- Popup API Key --- */
    .modal-api-key {
      background: #FFFFFF;
      border-radius: 24px;
      max-width: 480px;
      width: 90%;
      margin: auto;
      padding: 32px 28px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes scaleIn {
      from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }

    .api-header { text-align: center; margin-bottom: 24px; }

    .api-icon {
      width: 72px;
      height: 72px;
      background: linear-gradient(135deg, #FFB800, #FF9500);
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 36px;
      margin: 0 auto 16px;
      box-shadow: 0 4px 16px rgba(255, 165, 0, 0.3);
    }

    .api-header h2 { font-size: 24px; font-weight: 700; margin-bottom: 8px; color: #1A1A1A; }
    .api-subtitle { font-size: 15px; color: #666; line-height: 1.5; }

    .api-benefits {
      background: #F9FAFB;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
    }

    .benefit-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
      font-size: 15px;
    }

    .benefit-icon { font-size: 20px; }

    .api-input-section { margin-bottom: 20px; }
    .api-input-section label { display: block; font-size: 14px; font-weight: 600; color: #333; margin-bottom: 8px; }

    .input-wrapper { position: relative; display: flex; align-items: center; }
    .input-wrapper input {
      width: 100%;
      padding: 14px 50px 14px 16px;
      border: 2px solid #E5E5E5;
      border-radius: 12px;
      font-size: 15px;
      font-family: 'Courier New', monospace;
      transition: border-color 0.3s;
    }

    .input-wrapper input:focus { outline: none; border-color: #FFB800; }
    .input-wrapper input.input-error { border-color: #FF3B30; animation: shake 0.3s; }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }

    .toggle-btn {
      position: absolute;
      right: 12px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 4px;
    }

    .error-message {
      display: block;
      color: #FF3B30;
      font-size: 13px;
      margin-top: 8px;
      font-weight: 500;
    }

    .api-help {
      text-align: center;
      margin-bottom: 24px;
      padding: 16px;
      background: #FFF9EB;
      border-radius: 12px;
      border: 1px solid #FFE4A3;
    }

    .api-help p { font-size: 14px; color: #666; margin-bottom: 8px; }

    .btn-get-api {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #1A1A1A;
      color: #FFF;
      text-decoration: none;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      transition: background 0.3s;
    }

    .btn-get-api:hover { background: #333; }

    .api-actions { display: flex; flex-direction: column; gap: 12px; }
    .api-actions .btn-primary {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #FFB800, #FF9500);
      color: #FFF;
      border: none;
      border-radius: 12px;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .api-actions .btn-primary:hover { transform: translateY(-2px); }
    .api-actions .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

    .api-actions .btn-secondary {
      width: 100%;
      padding: 14px;
      background: #F5F5F5;
      color: #666;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }

    .api-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 20px;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 24px;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #E5E5E5;
      border-top-color: #FFB800;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* --- ClonaciÃ³n de voz --- */
    .modal-clonacion {
      background: #FFF;
      border-radius: 24px 24px 0 0;
      max-height: 90vh;
      overflow-y: auto;
      padding: 24px;
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
    }

    .clonacion-content { padding: 20px 0; }
    .clonacion-info { text-align: center; margin-bottom: 32px; }

    .steps { display: flex; flex-direction: column; gap: 16px; margin-top: 24px; text-align: left; }
    .step {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: #F9FAFB;
      border-radius: 12px;
    }

    .step-number {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #FFB800, #FF9500);
      color: #FFF;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-weight: 700;
      font-size: 18px;
    }

    .recording-section { text-align: center; }
    .btn-record {
      background: linear-gradient(135deg, #FFB800, #FF9500);
      color: #FFF;
      border: none;
      padding: 16px 32px;
      border-radius: 50px;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .record-icon { font-size: 20px; animation: pulse 1.5s infinite; }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    #recording-timer { display: flex; flex-direction: column; align-items: center; gap: 16px; }
    .timer-display { font-size: 48px; font-weight: 700; color: #FF3B30; }

    .btn-stop {
      background: #FF3B30;
      color: #FFF;
      border: none;
      padding: 12px 24px;
      border-radius: 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }

    #audio-preview { display: flex; flex-direction: column; gap: 16px; align-items: center; margin-top: 20px; }
    #audio-preview audio { width: 100%; max-width: 400px; }

    .progress-bar-voice {
      width: 100%;
      height: 8px;
      background: #E5E5E5;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .progress-fill-voice {
      height: 100%;
      background: linear-gradient(90deg, #FFB800, #FF9500);
      width: 0%;
      transition: width 0.3s;
    }

    .elevenlabs-note {
      text-align: center;
      margin-top: 24px;
      padding: 16px;
      background: #F0F9FF;
      border-radius: 12px;
      border: 1px solid #D0E7FF;
    }

    .elevenlabs-note a { color: #007AFF; text-decoration: none; font-weight: 600; }

    /* --- OCR modal --- */
    .ocr-progress-modal {
      background: #FFF;
      border-radius: 24px;
      max-width: 440px;
      width: 90%;
      padding: 32px 24px;
      margin: auto;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      text-align: center;
    }

    .ocr-icon {
      width: 72px;
      height: 72px;
      background: linear-gradient(135deg, #FFB800, #FF9500);
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 36px;
      margin: 0 auto 20px;
    }

    .ocr-progress-modal h3 { font-size: 20px; font-weight: 700; margin-bottom: 20px; }

    .ocr-preview {
      width: 100%;
      max-height: 200px;
      overflow: hidden;
      border-radius: 12px;
      margin-bottom: 20px;
      background: #F5F5F5;
    }

    .ocr-preview img { width: 100%; height: auto; object-fit: contain; }

    .progress-bar-ocr {
      width: 100%;
      height: 8px;
      background: #E5E5E5;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .progress-fill-ocr {
      height: 100%;
      background: linear-gradient(90deg, #FFB800, #FF9500);
      width: 0%;
      transition: width 0.3s;
    }

    #ocr-status { font-size: 15px; color: #666; margin-bottom: 4px; }
    #ocr-percent { font-size: 32px; font-weight: 700; color: #FFB800; }

    /* --- Responsive --- */
    @media (min-width: 769px) {
      #app { max-width: 1200px; margin: 0 auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
      #main-content { order: 1; }

      .bottom-nav { position: relative; order: 0; height: auto; box-shadow: none; display: flex; gap: 12px; background: transparent; justify-content: flex-start; margin-bottom: 12px; }
      .nav-item { flex: 0 0 auto; padding: 12px 24px; border-radius: 12px; background: #FFF; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06); }
      .nav-item.active { background: linear-gradient(135deg, #FFB800, #FF9500); color: #FFF; }
      .nav-item.active::before { display: none; }

      .fab { bottom: 40px; right: 40px; }
      .promo-banner { height: 240px; }
      .library-header h1 { font-size: 40px; }
      .document-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; }
      .player-body { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; align-items: start; }
      .text-container { max-height: 500px; }
      .text-config-panel { right: 32px; width: 420px; }
      .text-config-panel.docked { right: 32px; }

      .modal-voz, .modal-velocidad, .modal-documento { bottom: auto; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 24px; max-width: 600px; max-height: 80vh; }
    }

    @media (max-width: 768px) and (min-width: 481px) {
      .document-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
      .access-cards { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    }

    @media (max-width: 480px) {
      .promo-banner { height: 160px; }
      .library-header h1 { font-size: 28px; }
      .player-title { font-size: 18px; }
      .text-container { font-size: 16px; max-height: 280px; }
      .text-config-panel { left: 12px; right: 12px; width: auto; top: 64px; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
</head>
<body>
  <div id="auth-screen">
    <div class="auth-card">
      <div class="auth-logo">AI</div>
      <div class="auth-toggle">
        <button id="login-tab" class="active">Iniciar SesiÃ³n</button>
        <button id="signup-tab">Crear Cuenta</button>
      </div>
      <div class="auth-title" id="auth-title">Bienvenido de vuelta</div>
      <div class="auth-subtitle" id="auth-subtitle">Inicia sesiÃ³n para acceder a tu biblioteca</div>

      <div class="auth-error" id="auth-error"></div>
      <div class="auth-success" id="auth-success"></div>

      <form id="login-form" class="auth-form">
        <div>
          <label for="login-email">Email</label>
          <input type="email" id="login-email" placeholder="tu@email.com" required />
        </div>
        <div>
          <label for="login-password">ContraseÃ±a</label>
          <input type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" required />
        </div>
        <div class="auth-actions">
          <label class="remember-me">
            <input type="checkbox" id="remember-me" /> Recordarme
          </label>
          <a href="#" id="forgot-password">Â¿Olvidaste tu contraseÃ±a?</a>
        </div>
        <button type="submit" class="auth-button" id="login-button">Iniciar SesiÃ³n</button>
        <button type="button" class="auth-button auth-button-ghost" id="guest-button">Continuar como Invitado</button>
      </form>

      <form id="signup-form" class="auth-form" style="display:none;">
        <div>
          <label for="signup-email">Email</label>
          <input type="email" id="signup-email" placeholder="tu@email.com" required />
        </div>
        <div>
          <label for="signup-password">ContraseÃ±a</label>
          <input type="password" id="signup-password" placeholder="MÃ­nimo 6 caracteres" minlength="6" required />
        </div>
        <div>
          <label for="signup-confirm">Confirmar contraseÃ±a</label>
          <input type="password" id="signup-confirm" placeholder="Repite tu contraseÃ±a" minlength="6" required />
        </div>
        <div>
          <label for="signup-api-key">API Key de Google TTS (opcional)</label>
          <input type="password" id="signup-api-key" placeholder="Puedes agregarla ahora o despuÃ©s" />
        </div>
        <button type="submit" class="auth-button" id="signup-button">Crear Cuenta</button>
      </form>
    </div>
  </div>
  <div id="app">
    <main id="main-content">
      <section id="home" class="page active">
        <div class="promo-banner">
          <svg class="promo-illustration" viewBox="0 0 320 180">
            <defs>
              <linearGradient id="docGrad" x1="0" x2="1" y1="0" y2="1">
                <stop offset="0%" stop-color="#FFF" />
                <stop offset="100%" stop-color="#FFF3E0" />
              </linearGradient>
              <linearGradient id="aiGrad" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="#5BA3F5" />
                <stop offset="100%" stop-color="#357AE8" />
              </linearGradient>
            </defs>
            <rect x="26" y="40" width="72" height="90" rx="12" fill="url(#docGrad)" stroke="#F0C27B" stroke-width="2"/>
            <line x1="42" y1="62" x2="86" y2="62" stroke="#FFB800" stroke-width="3" stroke-linecap="round"/>
            <line x1="42" y1="76" x2="82" y2="76" stroke="#E0A437" stroke-width="2.5" stroke-linecap="round"/>
            <line x1="42" y1="92" x2="88" y2="92" stroke="#FFD580" stroke-width="3" stroke-linecap="round"/>
            <circle cx="150" cy="85" r="26" fill="#FFF8EC" stroke="#FFD27F" stroke-width="3"/>
            <text x="150" y="92" text-anchor="middle" fill="#FFB800" font-size="16" font-weight="800">â†’ AI</text>
            <path d="M100 85 Q125 55 150 85" fill="none" stroke="#FFB800" stroke-width="3" stroke-linecap="round"/>
            <path d="M150 85 Q175 115 200 85" fill="none" stroke="#FF9500" stroke-width="3" stroke-linecap="round"/>
            <rect x="210" y="35" width="84" height="100" rx="18" fill="#fff" stroke="#DCE8FF" stroke-width="3"/>
            <circle cx="252" cy="70" r="26" fill="url(#aiGrad)" opacity="0.18"/>
            <text x="252" y="76" text-anchor="middle" fill="#357AE8" font-size="22" font-weight="800">AI</text>
            <rect x="226" y="88" width="52" height="10" rx="6" fill="#FFB800"/>
            <rect x="226" y="106" width="44" height="10" rx="6" fill="#FFE6A9"/>
          </svg>
          <div class="promo-text" style="position: absolute; bottom: 28px; left: 20px; right: 120px;">
            <p style="font-size: 16px; font-weight: 700; color: #1A1A1A; line-height: 1.4;">
              Documento â†’ Inteligencia Artificial â†’ Resumen listo para escuchar
            </p>
          </div>
          <div class="carousel-dots">
            <span class="active"></span><span></span><span></span><span></span><span></span><span></span><span></span>
          </div>
        </div>
        <div class="section-header">
          <h2>Â¿QuÃ© quieres escuchar hoy?</h2>
        </div>
        <div class="access-cards">
          <div class="tarjeta-acceso" data-action="archivo">
            <div class="icon-card">ðŸ“„</div>
            <div>
              <h3>Documento</h3>
              <p>Sube archivos desde Drive o dispositivo</p>
            </div>
          </div>
          <div class="tarjeta-acceso" data-action="escanear">
            <div class="icon-card">{ }</div>
            <div>
              <h3>Escanear Texto</h3>
              <p>Documentos escaneados o imÃ¡genes</p>
            </div>
          </div>
          <div class="tarjeta-acceso" data-action="url">
            <div class="icon-card">ðŸ”—</div>
            <div>
              <h3>Enlace Web</h3>
              <p>Convierte URLs en audio</p>
            </div>
          </div>
          <div class="tarjeta-acceso" data-action="texto">
            <div class="icon-card">T</div>
            <div>
              <h3>Escribir o Pegar Texto</h3>
              <p>Introduce o pega texto para escuchar</p>
            </div>
          </div>
          <div class="tarjeta-acceso" data-action="correo">
            <div class="icon-card">âœ‰ï¸</div>
            <div>
              <h3>Correo</h3>
              <p>Escucha los correos electrÃ³nicos fÃ¡cilmente</p>
            </div>
          </div>
        </div>
      </section>

      <section id="library" class="page">
        <header class="library-header">
          <div class="lib-left">
            <div class="ai-chip">AI</div>
              <div>
                <h1>Mi Biblioteca</h1>
              <div class="lib-icons">
                <div class="star-counter">â­ <span>0</span></div>
              </div>
              </div>
            </div>
          <div class="lib-icons">
            <div class="progress-circle" id="btn-api-status" title="Configurar API Key" style="cursor: pointer; transition: all 0.3s;">
              <span class="circle-text">ðŸ¤–</span>
            </div>
          </div>
        </header>
        <div class="tabs">
          <button class="tab active" data-filter="todo">Todo</button>
          <button class="tab" data-filter="continuar">Continuar</button>
          <button class="tab" data-filter="finalizado">Finalizado</button>
          <button class="tab" data-filter="favorito">â™¥ Favoritos</button>
        </div>
        <div id="document-list"></div>
      </section>

      <section id="player" class="page">
        <header class="player-toolbar">
          <button class="icon-btn" data-action="back">â†</button>
          <button class="icon-btn" id="open-text-config" title="ConfiguraciÃ³n de lectura" aria-label="Abrir configuraciÃ³n de lectura">âš™ï¸</button>
          <button class="icon-btn" title="Resaltar">â‰¡</button>
          <button class="icon-btn" title="TamaÃ±o">Aa</button>
          <button class="icon-btn" title="IA">ðŸ”</button>
          <button class="icon-btn" title="Compartir">â†‘</button>
          <button class="icon-btn" title="Opciones">â‹¯</button>
        </header>
        <div class="player-body">
          <h3 id="player-title">Documento</h3>
          <div class="text-reader-wrapper">
            <div class="text-container" id="player-text" aria-live="polite"></div>
          </div>
          <div class="progress-area">
            <div class="time start" id="time-start">0:00</div>
            <div class="time end" id="time-end">0:00</div>
            <div class="progress-bar" id="progress-bar">
              <div class="progress" id="progress"></div>
              <div class="thumb" id="progress-thumb"></div>
            </div>
          </div>
          <div class="controles">
            <button class="ctrl-btn" id="backward">âª10</button>
            <button class="play-btn" id="play-pause">â–¶ï¸</button>
            <button class="ctrl-btn" id="forward">â©10</button>
          </div>
          <div class="footer-player">
            <div class="speed-control">
              <button id="speed-btn">1.0 x</button>
              <small>Velocidad</small>
            </div>
            <div class="voice-control" id="voice-btn">
              <div class="avatar">
                <img class="voice-avatar" src="https://i.pravatar.cc/256?img=32" alt="Sasha" onerror="this.src='https://placehold.co/64x64'" />
              </div>
              <small>Sasha</small>
            </div>
          </div>
        </div>
      </section>
    </main>

    <nav class="bottom-nav">
      <button class="nav-item active" data-target="home">
        <div class="icon">ðŸ </div>
        <span>Inicio</span>
      </button>
      <button class="nav-item" data-target="library">
        <div class="icon">ðŸ“„</div>
        <span>Mi Biblioteca</span>
      </button>
      <button class="nav-item" data-target="settings">
        <div class="icon">âš™ï¸</div>
        <span>Configuraciones</span>
      </button>
    </nav>

    <button class="fab" id="add-btn">+</button>

      <section id="settings" class="page">
        <div class="settings-page">
          <section class="config-seccion">
            <h3 class="titulo-seccion">Preferencias</h3>
            <div class="config-item" data-action="clonacion">
              <div class="icono-config">ðŸŽ™ï¸</div>
              <span>ClonaciÃ³n de Voz</span>
              <span class="flecha">â€º</span>
            </div>
            <div class="config-item" data-action="config-api">
              <div class="icono-config">ðŸ”</div>
              <span>API Key de Google TTS</span>
              <span class="valor-actual" id="api-status-label">Sin configurar</span>
            </div>
            <div class="config-item" data-action="config-firebase">
              <div class="icono-config">â˜ï¸</div>
              <span>Proyecto Firebase</span>
              <span class="valor-actual" id="firebase-status-label">Sin configurar</span>
            </div>
            <div class="config-item" data-action="cambiar-voz">
              <div class="icono-config">ðŸ”Š</div>
              <span>Cambiar Voz</span>
              <span class="valor-actual" id="voz-actual">Sasha</span>
            </div>
            <div class="config-item" data-action="idioma">
              <div class="icono-config">ðŸŒ</div>
              <span>Idioma de la aplicaciÃ³n</span>
              <span class="valor-actual">EspaÃ±ol</span>
            </div>
            <div class="config-item" data-action="solicitar">
              <div class="icono-config">âœï¸</div>
              <span>Solicitar FunciÃ³n</span>
              <span class="flecha">â€º</span>
            </div>
          </section>

          <section id="api-key-settings" class="config-seccion" style="display:none;">
            <h3 class="titulo-seccion">API Keys</h3>
            <div class="config-item">
              <div class="icono-config">ðŸ”‘</div>
              <div style="display:flex; flex-direction:column; gap:4px;">
                <label style="font-weight:600;">Google TTS API Key:</label>
                <span id="current-api-key" style="font-weight:700; color:#1A1A1A;">Sin configurar</span>
              </div>
              <button class="btn-primario" style="margin-left:auto;" onclick="editAPIKey()">Cambiar</button>
            </div>
          </section>

        <section class="config-seccion">
          <h3 class="titulo-seccion">Tu cuenta</h3>
          <div class="config-item">
            <div class="icono-config">ðŸ“§</div>
            <div style="display:flex; flex-direction:column; gap:4px;">
              <span id="user-email-display">Sin sesiÃ³n</span>
              <small id="email-verified-badge" style="color:#666; font-weight:600;">Email no verificado</small>
            </div>
          </div>
          <div class="config-item" id="logout-action">
            <div class="icono-config" style="background:#FFE8E6; color:#C0392B;">ðŸšª</div>
            <span style="color:#C0392B;">Cerrar SesiÃ³n</span>
            <span class="flecha">â€º</span>
          </div>
        </section>

        <section class="config-seccion">
          <h3 class="titulo-seccion">Cuentas vinculadas</h3>
          <div class="cuenta-item">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="icono-servicio" alt="Google" />
            <span>Google</span>
            <button class="btn-desconectar">Desconectar</button>
          </div>
          <p class="descripcion-cuenta">Conecta tus cuentas y convierte tus archivos y correos en audio.</p>
        </section>

        <section class="config-seccion">
          <h3 class="titulo-seccion">Compartir</h3>
          <div class="config-item" data-action="compartir">
            <div class="icono-config">ðŸ“¤</div>
            <span>Compartir Listen AI</span>
            <span class="flecha">â€º</span>
          </div>
        </section>

        <section class="config-seccion">
          <h3 class="titulo-seccion">Soporte</h3>
          <div class="config-item" data-action="calificar">
            <div class="icono-config">â¤ï¸</div>
            <span>Â¿Te gusta? CalifÃ­canos</span>
            <span class="flecha">â€º</span>
          </div>
          <div class="config-item" data-action="ayuda">
            <div class="icono-config">ðŸ’¬</div>
            <span>Soporte y ayuda</span>
            <span class="flecha">â€º</span>
          </div>
        </section>
      </div>
    </section>
  </div>

  <div class="text-config-overlay" id="text-config-overlay"></div>
  <aside class="text-config-panel" id="text-config-panel" role="dialog" aria-modal="true" aria-labelledby="text-config-title">
    <div class="text-config-header">
      <div class="text-config-title" id="text-config-title">âš™ï¸ ConfiguraciÃ³n de lectura</div>
      <div class="text-config-actions">
        <button id="dock-text-config" aria-label="Anclar o soltar panel">Fijar</button>
        <button id="close-text-config" aria-label="Cerrar panel">Cerrar</button>
      </div>
    </div>

    <details class="config-section" open>
      <summary>TamaÃ±o y familia de fuente</summary>
      <div class="config-controls">
        <div class="slider-row">
          <label for="font-size-slider" style="min-width:120px; font-weight:700;">TamaÃ±o: <span id="font-size-value">16px</span></label>
          <input type="range" id="font-size-slider" min="12" max="48" step="1" value="16" aria-label="TamaÃ±o de fuente" />
        </div>
        <div class="control-grid" id="font-quick-buttons" aria-label="Atajos de tamaÃ±o de fuente"></div>
        <select id="font-family-select" class="font-select" aria-label="Familia tipogrÃ¡fica">
          <option value="Inter, system-ui, -apple-system, sans-serif">Inter (Predeterminado)</option>
          <option value="Arial, Helvetica, sans-serif">Arial</option>
          <option value="Helvetica, Arial, sans-serif">Helvetica</option>
          <option value="Verdana, Arial, sans-serif">Verdana</option>
          <option value="Tahoma, Arial, sans-serif">Tahoma</option>
          <option value="Georgia, serif">Georgia</option>
          <option value="'Times New Roman', serif">Times New Roman</option>
          <option value="Garamond, serif">Garamond</option>
          <option value="'Courier New', monospace">Courier New</option>
          <option value="Consolas, monospace">Consolas</option>
          <option value="'OpenDyslexic', 'Arial', sans-serif">OpenDyslexic</option>
        </select>
      </div>
    </details>

    <details class="config-section" open>
      <summary>Espaciado y alineaciÃ³n</summary>
      <div class="config-controls">
        <div class="control-grid" id="line-height-options" aria-label="Altura de lÃ­nea"></div>
        <div class="control-grid" id="letter-spacing-options" aria-label="Espaciado entre letras"></div>
        <div class="control-grid" id="word-spacing-options" aria-label="Espaciado entre palabras"></div>
        <div class="control-grid" id="paragraph-spacing-options" aria-label="Espaciado entre pÃ¡rrafos"></div>
        <div class="control-grid" id="text-align-options" aria-label="AlineaciÃ³n del texto"></div>
        <div class="column-options" id="column-width-options" aria-label="Ancho de columna"></div>
      </div>
    </details>

    <details class="config-section" open>
      <summary>Colores y contraste</summary>
      <div class="config-controls">
        <div class="color-presets" id="color-presets" aria-label="Esquemas de color"></div>
        <div class="input-row">
          <label for="text-color-picker">Color del texto
            <input type="color" id="text-color-picker" aria-label="Color de texto personalizado">
          </label>
          <label for="bg-color-picker">Color de fondo
            <input type="color" id="bg-color-picker" aria-label="Color de fondo personalizado">
          </label>
        </div>
        <div class="highlight-legend">
          <span class="pill" style="background:#FFF9C4; border-color:#FFECB3;">Frase actual</span>
          <span class="pill" style="background:#FFB74D; border-color:#FFA726;">Palabra actual</span>
          <span class="pill" style="background:#F7F9FD; border-color:#E1E8FF;">Contraste mÃ­nimo AA</span>
        </div>
      </div>
    </details>

    <details class="config-section" open>
      <summary>Resaltado y accesibilidad</summary>
      <div class="config-controls">
        <label class="toggle-row" for="highlight-sentence-toggle">
          <span>Resaltar frase actual</span>
          <input type="checkbox" id="highlight-sentence-toggle" checked />
        </label>
        <label class="toggle-row" for="highlight-word-toggle">
          <span>Resaltar palabra actual</span>
          <input type="checkbox" id="highlight-word-toggle" checked />
        </label>
        <label class="toggle-row" for="high-contrast-toggle">
          <span>Forzar alto contraste</span>
          <input type="checkbox" id="high-contrast-toggle" />
        </label>
      </div>
    </details>

    <div class="preview-box" id="text-preview-box">
      <h4>Vista previa en tiempo real</h4>
      <p id="text-preview">
        Este es un ejemplo de cÃ³mo se verÃ¡ tu texto con la configuraciÃ³n actual.
        Puedes ajustar el tamaÃ±o de fuente, espaciado, colores y mÃ¡s opciones para
        que la lectura sea lo mÃ¡s cÃ³moda posible para tus ojos.
      </p>
      <small id="contrast-warning" style="display:none; color:#C0392B; font-weight:700;">Ajusta los colores para mejorar el contraste.</small>
    </div>

    <div class="text-config-footer">
      <button class="btn-reset" id="reset-text-config">Restablecer</button>
      <button class="btn-save" id="save-text-config">Guardar preferencias</button>
    </div>
  </aside>

  <div class="modal-overlay" id="modal-overlay"></div>

  <div class="modal-voz" id="voice-modal">
    <div class="modal-header">
      <button class="btn-cerrar" data-close>Ã—</button>
      <h3>Seleccionar Voz</h3>
      <button class="btn-info">â“˜</button>
    </div>
    <div class="lista-voces" id="voice-list"></div>
    <button class="btn-guardar" id="save-voice">Guardar</button>
  </div>

  <div class="modal-velocidad" id="speed-modal">
    <div class="modal-header">
      <h3>Velocidad</h3>
      <button class="btn-cerrar" data-close>Ã—</button>
    </div>
    <div class="velocidad-actual" id="velocidad-actual">1.0 x</div>
    <input type="range" min="0.7" max="3.0" step="0.1" value="1.0" class="slider-velocidad" id="speed-slider" />
    <div class="marcas-velocidad">
      <span>0.7</span><span>1.0</span><span>2.0</span><span>3.0</span>
    </div>
    <div class="velocidades-rapidas" id="speed-buttons"></div>
  </div>

  <div class="modal-documento" id="doc-menu">
    <div class="header-menu">
      <img src="" class="preview-mini" id="doc-preview" alt="preview" />
      <div>
        <h4 id="doc-menu-title"></h4>
        <span id="doc-menu-type"></span>
      </div>
      <div class="acciones">
        <button class="btn-editar" title="Editar">âœï¸</button>
        <button class="btn-cerrar" data-close>Ã—</button>
      </div>
    </div>
    <div class="opciones-menu">
      <button data-action="download">
        <span class="icono">â¬‡ï¸</span>
        <div>
          <strong>Descargar Audio (con voz)</strong>
          <small id="doc-voice">Sasha</small>
          <p>Permite escuchar sin conexiÃ³n dentro de la aplicaciÃ³n.</p>
        </div>
      </button>
      <button data-action="edit"><span>âœï¸</span> Editar texto o tÃ­tulo</button>
      <button data-action="share"><span>ðŸ“¤</span> Compartir</button>
      <button data-action="notas"><span>ðŸ“</span> Notas</button>
      <button data-action="resumir"><span>ðŸ“‹</span> Resumir</button>
      <button data-action="cola"><span>âž•</span> AÃ±adir a la cola</button>
      <button data-action="finalizar"><span>âœ“</span> Marcar como Finalizado</button>
      <button data-action="favorito"><span>â™¥</span> Agregar a Favoritos</button>
      <div class="separador"></div>
      <button data-action="saltar"><span>ðŸ”„</span> Saltar contenido</button>
      <button data-action="temporizador"><span>â°</span> Temporizador de SueÃ±o</button>
      <button data-action="exportar"><span>â†—ï¸</span> Exportar audio<p>Guarda el audio en el dispositivo o compÃ¡rtelo directamente.</p></button>
      <div class="separador"></div>
      <button class="eliminar" data-action="eliminar"><span>ðŸ—‘ï¸</span> Eliminar Archivo</button>
    </div>
  </div>

  <div class="modal-notas" id="notes-modal">
    <h2>Mis Notas</h2>
    <button class="btn-cerrar" data-close>Ã—</button>
    <div class="contenido-vacio" id="notes-empty">
      <img src="https://placehold.co/200x140" alt="Notas vacÃ­as" />
      <h3>Nada para anotar</h3>
      <p>Mente despejada, pÃ¡gina en blanco.<br>Â¡Tus notas te esperan!</p>
    </div>
    <textarea id="notes-area" placeholder="Escribe tus notas"></textarea>
    <button class="btn-borrar-nota" id="delete-note">Eliminar nota</button>
    <button class="btn-fab-nota" id="save-note">+</button>
  </div>

  <div class="modal-idioma" id="language-modal">
    <header>
      <button class="btn-volver" data-close>&lt;</button>
      <h2>Cambiar idioma de la aplicaciÃ³n</h2>
    </header>
    <div class="lista-idiomas" id="language-list"></div>
  </div>

  <form class="formulario-solicitud" id="request-form" style="display: none;">
    <header>
      <button class="btn-volver" data-close>â€¹</button>
      <h2>Solicitar FunciÃ³n</h2>
    </header>
    <p class="descripcion">Sugerir una nueva funciÃ³n para ayudarnos a<br>mejorar aÃºn mÃ¡s Listen AI!</p>
    <label>TÃ­tulo</label>
    <input type="text" placeholder="TÃ­tulo de tu idea (opcional)" class="input-titulo" id="idea-title" />
    <label>InformaciÃ³n</label>
    <textarea placeholder="ExplicaciÃ³n de tu idea" maxlength="1000" class="textarea-info" id="idea-info"></textarea>
    <span class="contador" id="char-counter">0/1000</span>
    <button type="submit" class="btn-enviar" id="send-idea">Enviar</button>
  </form>

  <div class="selector-documento" id="file-source-modal" style="display:none;">
    <h3>Â¿Desde dÃ³nde quieres importar?</h3>
    <div class="selector-opciones">
      <button id="pick-from-device"><span>ðŸ“</span><div><strong>Dispositivo</strong><small>PDF, DOC, DOCX o TXT</small></div></button>
      <button class="secondary" id="pick-from-drive"><span>â˜ï¸</span><div><strong>Google Drive</strong><small>Pega el enlace compartido para importarlo</small></div></button>
    </div>
  </div>

  <input type="file" id="file-input" accept=".pdf,.doc,.docx,.txt" style="display:none" />
  <input type="file" id="image-input" accept="image/*" multiple style="display:none" />

  <div class="modal-editar" id="edit-modal">
    <div class="modal-header" style="margin-bottom:6px;">
      <h3 style="margin:0;">Editar documento</h3>
      <button class="btn-cerrar" data-close="edit">Ã—</button>
    </div>
    <label for="edit-title">TÃ­tulo</label>
    <input id="edit-title" type="text" maxlength="120" />
    <label for="edit-content">Contenido</label>
    <textarea id="edit-content"></textarea>
    <div class="editar-acciones">
      <button class="btn-secundario" id="cancel-edit">Cancelar</button>
      <button class="btn-primario" id="save-edit">Guardar cambios</button>
    </div>
  </div>

  <div class="loader-proceso" id="loader-proceso">
    <div class="loader-card">
      <div class="loader-spinner"></div>
      <div>
        <strong id="loader-titulo">Procesando...</strong>
        <small id="loader-mensaje">Esto puede tardar unos segundos</small>
      </div>
    </div>
  </div>

  <div id="api-key-setup-modal" class="modal-overlay" style="display:none; align-items: center; justify-content: center;">
    <div class="modal-api-key" style="background:#fff; padding:24px; border-radius:16px; max-width:460px; width:90%; box-shadow:0 10px 40px rgba(0,0,0,0.15); position: relative;">
      <button class="btn-cerrar" id="close-api-key-setup" style="position:absolute; right:12px; top:12px;">Ã—</button>
      <h3 style="margin-top:0; margin-bottom:12px;">ConfiguraciÃ³n de API Key</h3>
      <p style="margin-top:0; color:#555;">Para usar las voces de Google Text-to-Speech, necesitas configurar tu propia API key.</p>
      <label for="google-tts-api-key-input" style="display:block; font-weight:600; margin-top:12px;">API Key de Google TTS:</label>
      <input type="text" id="google-tts-api-key-input" placeholder="AIzaSy..." style="width:100%; padding:10px 12px; margin-top:6px; border-radius:10px; border:1px solid #ddd;">
      <a href="https://cloud.google.com/text-to-speech/docs/before-you-begin" target="_blank" style="display:inline-block; margin:10px 0; color:#1a73e8;">Â¿CÃ³mo obtener una API key?</a>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px; align-items:center;">
        <div id="api-key-inline-loader" style="display:none; align-items:center; gap:6px; color:#FF9500; font-weight:700;">
          <span class="inline-spinner" style="border-color: rgba(255,149,0,0.35); border-top-color:#FF9500;"></span>
          <span>Validando API Key...</span>
        </div>
        <button class="btn-secundario" type="button" id="cancel-api-key-setup">Omitir (usar voces del sistema)</button>
        <button class="btn-primario" type="button" id="save-api-key-btn" onclick="saveAPIKey()">Guardar</button>
      </div>
    </div>
  </div>

  <script type="module">
    let userGoogleTTSKey = null;
    const DEBUG_MODE = localStorage.getItem('debugMode') === 'true';
    const FIREBASE_CONFIG_STORAGE_KEY = 'listen_ai_firebase_config_v1';
    const GUEST_MODE_KEY = 'isGuestMode';
    const GUEST_API_KEY_STORAGE_KEY = 'googleTTSKey_guest';
    const GUEST_SKIP_API_KEY_KEY = 'skipAPIKey_guest';

    const LEGACY_FIREBASE_CONFIG = {
      apiKey: "AIzaSyAsp5EL1SMvbD80F2bcJim9p62ceYwfgqc",
      authDomain: "listen-ai-tts-app.firebaseapp.com",
      projectId: "listen-ai-tts-app",
      storageBucket: "listen-ai-tts-app.firebasestorage.app",
      messagingSenderId: "135347023896",
      appId: "1:135347023896:web:6e04b1499695fe358a936d",
      measurementId: "G-NZ97696F1F"
    };

    const DEFAULT_FIREBASE_CONFIG = {
      apiKey: '',
      authDomain: '',
      projectId: '',
      storageBucket: '',
      messagingSenderId: '',
      appId: '',
      measurementId: ''
    };

    let firebaseAppInitialized = false;
    let firebaseConfigInUse = null;
    let lastFirebaseInitError = null;
    let isGuestMode = localStorage.getItem(GUEST_MODE_KEY) === 'true';

    function sanitizeFirebaseConfig(rawConfig = {}) {
      const clean = { ...DEFAULT_FIREBASE_CONFIG, ...rawConfig };
      Object.keys(clean).forEach((key) => {
        if (typeof clean[key] === 'string') {
          clean[key] = clean[key].trim();
        }
      });
      return clean;
    }

    function validateFirebaseConfig(config) {
      if (!config) return false;
      const required = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];
      return required.every((field) => typeof config[field] === 'string' && config[field].trim().length > 0);
    }

    function loadStoredFirebaseConfig() {
      try {
        const raw = localStorage.getItem(FIREBASE_CONFIG_STORAGE_KEY);
        if (!raw) return null;
        return sanitizeFirebaseConfig(JSON.parse(raw));
      } catch (error) {
        console.error('âŒ Error cargando config de Firebase guardada', error);
        return null;
      }
    }

    function saveStoredFirebaseConfig(config) {
      try {
        localStorage.setItem(FIREBASE_CONFIG_STORAGE_KEY, JSON.stringify(sanitizeFirebaseConfig(config)));
      } catch (error) {
        console.error('âŒ No se pudo guardar la configuraciÃ³n de Firebase', error);
      }
    }

    function getGuestAPIKey() {
      return localStorage.getItem(GUEST_API_KEY_STORAGE_KEY) || null;
    }

    function setGuestAPIKey(key) {
      if (key) {
        localStorage.setItem(GUEST_API_KEY_STORAGE_KEY, key);
      } else {
        localStorage.removeItem(GUEST_API_KEY_STORAGE_KEY);
      }
    }

    function getActiveFirebaseConfig() {
      const stored = loadStoredFirebaseConfig();
      if (validateFirebaseConfig(stored)) return stored;
      if (validateFirebaseConfig(LEGACY_FIREBASE_CONFIG)) {
        console.warn('âš ï¸ Usando configuraciÃ³n legacy de Firebase. Se recomienda cambiarla cuanto antes.');
        return LEGACY_FIREBASE_CONFIG;
      }
      return null;
    }

    function ensureFirebaseReady(context = 'operaciÃ³n') {
      if (isGuestMode) return false;
      if (firebaseAppInitialized) return true;
      console.warn(`â„¹ï¸ Firebase no estÃ¡ configurado o disponible para ${context}.`);
      lastFirebaseInitError = lastFirebaseInitError || new Error('Firebase no inicializado');
      return false;
    }

    function handleFirebaseOperationError(context, error) {
      console.error(`âŒ Firebase error en ${context}`, error);
      const message = error?.message || 'Error desconocido en Firebase';
      if (typeof message === 'string' && message.toLowerCase().includes('permission')) {
        mostrarPopupError('Permiso denegado en Firebase. Revisa las reglas y la configuraciÃ³n del proyecto.');
        return;
      }
      mostrarPopupError('No pudimos completar la acciÃ³n. Verifica tu conexiÃ³n o configuraciÃ³n de Firebase.');
    }

    function initializeFirebaseApp() {
      if (isGuestMode) {
        firebaseAppInitialized = false;
        updateFirebaseStatusLabel('Modo invitado');
        return;
      }
      const config = getActiveFirebaseConfig();
      firebaseConfigInUse = config;

      if (!validateFirebaseConfig(config)) {
        firebaseAppInitialized = false;
        updateFirebaseStatusLabel('Sin configurar');
        lastFirebaseInitError = new Error('Faltan credenciales de Firebase');
        return;
      }

      if (!firebase.apps.length) {
        try {
          firebase.initializeApp(config);
          firebaseAppInitialized = true;
          lastFirebaseInitError = null;
          console.log('ðŸ”¥ Firebase inicializado', {
            apiKeyPresent: !!config.apiKey,
            authDomain: config.authDomain,
            projectId: config.projectId,
            storageBucket: config.storageBucket
          });
          updateFirebaseStatusLabel(config.projectId || 'Listo');
        } catch (error) {
          firebaseAppInitialized = false;
          lastFirebaseInitError = error;
          console.error('âŒ No se pudo inicializar Firebase', error);
          updateFirebaseStatusLabel('Error');
        }
      }
    }

    initializeFirebaseApp();

    const errorMessages = {
      'auth/email-already-in-use': 'Este email ya tiene cuenta. Â¿Deseas iniciar sesiÃ³n?',
      'auth/invalid-email': 'Email invÃ¡lido',
      'auth/invalid-credential': 'Email o contraseÃ±a incorrectos. IntÃ©ntalo de nuevo.',
      'auth/invalid-login-credentials': 'Email o contraseÃ±a incorrectos. IntÃ©ntalo de nuevo.',
      'auth/weak-password': 'ContraseÃ±a muy dÃ©bil (mÃ­nimo 6 caracteres)',
      'auth/user-not-found': 'No existe una cuenta con este email. Â¿Deseas crear una cuenta?',
      'auth/wrong-password': 'ContraseÃ±a incorrecta. IntÃ©ntalo de nuevo.',
      'auth/user-disabled': 'Esta cuenta ha sido deshabilitada',
      'auth/too-many-requests': 'Demasiados intentos fallidos. Intenta mÃ¡s tarde.',
      'auth/network-request-failed': 'Error de conexiÃ³n. Verifica tu internet.'
    };

    const TEXT_CONFIG_DEFAULTS = {
      fontSize: 16,
      fontFamily: "Inter, system-ui, -apple-system, sans-serif",
      lineHeight: 1.5,
      textColor: "#1A1A1A",
      backgroundColor: "#FFFFFF",
      letterSpacing: 0,
      wordSpacing: 0,
      paragraphSpacing: 1,
      textAlign: "left",
      columnWidth: "800px",
      highlightSentence: true,
      highlightWord: true,
      highContrast: false
    };

    const FONT_PRESETS = [
      { label: 'PequeÃ±a', value: 14 },
      { label: 'Mediana', value: 18 },
      { label: 'Grande', value: 24 },
      { label: 'Extra Grande', value: 32 }
    ];

    const LINE_HEIGHT_PRESETS = [
      { label: 'Compacto (1.2)', value: 1.2 },
      { label: 'Normal (1.5)', value: 1.5 },
      { label: 'Relajado (1.8)', value: 1.8 },
      { label: 'Muy amplio (2.2)', value: 2.2 }
    ];

    const LETTER_SPACING_PRESETS = [
      { label: 'Normal', value: 0 },
      { label: 'Amplio (0.05em)', value: 0.05 },
      { label: 'Muy amplio (0.1em)', value: 0.1 }
    ];

    const WORD_SPACING_PRESETS = [
      { label: 'Normal', value: 0 },
      { label: 'Amplio (0.3em)', value: 0.3 },
      { label: 'Muy amplio (0.5em)', value: 0.5 }
    ];

    const PARAGRAPH_SPACING_PRESETS = [
      { label: 'Compacto (0.5em)', value: 0.5 },
      { label: 'Normal (1em)', value: 1 },
      { label: 'Relajado (1.5em)', value: 1.5 }
    ];

    const TEXT_ALIGN_PRESETS = [
      { label: 'Izquierda', value: 'left' },
      { label: 'Centrado', value: 'center' },
      { label: 'Justificado', value: 'justify' }
    ];

    const COLUMN_WIDTH_PRESETS = [
      { label: 'Estrecho (600px)', value: '600px' },
      { label: 'Medio (800px)', value: '800px' },
      { label: 'Ancho (1000px)', value: '1000px' },
      { label: 'Completo', value: '100%' }
    ];

    const HIGH_CONTRAST_BACKGROUND = '#FFFF00';
    const HIGH_CONTRAST_TEXT = '#000000';

    const COLOR_PRESETS = [
      { label: 'Negro sobre blanco', text: '#000000', bg: '#FFFFFF' },
      { label: 'Gris oscuro sobre crema', text: '#333333', bg: '#FFF8DC' },
      { label: 'Blanco sobre oscuro', text: '#FFFFFF', bg: '#1A1A1A' },
      { label: 'Alto contraste', text: HIGH_CONTRAST_TEXT, bg: HIGH_CONTRAST_BACKGROUND }
    ];

    let currentUser = null;
    let authInitialized = false;
    let firestoreUnsubscribe = null;

    const logDebug = (...args) => {
      if (DEBUG_MODE) console.log('[DEBUG]', ...args);
    };

    const authLog = (...args) => console.log('ðŸ” [AUTH]', ...args);
    const authStateLog = (...args) => console.log('ðŸ‘¤ [AUTH STATE]', ...args);
    const normalizeEmail = (email = '') => email.trim().toLowerCase();
    const maskPassword = (password = '') => '*'.repeat(Math.min(password.length, 12));
    const wait = (ms) => new Promise((resolve) => setTimeout(resolve, ms));
    const retryableAuthErrors = ['auth/network-request-failed', 'auth/internal-error', 'auth/too-many-requests'];

    const TRANSLATIONS = {
      'es': {
        'appTitle': 'Listen AI Clone',
        'languageUpdated': 'Idioma actualizado',
        'nav.home': 'Inicio',
        'nav.library': 'Mi Biblioteca',
        'nav.settings': 'Configuraciones',
        'home.banner.title': 'ObtÃ©n un resumen rÃ¡pido de un archivo o pregunta al AI cualquier cosa',
        'home.section.title': 'Â¿QuÃ© quieres escuchar hoy?',
        'home.document.title': 'Documento',
        'home.document.subtitle': 'Sube archivos desde Drive o dispositivo',
        'home.scan.title': 'Escanear Texto',
        'home.scan.subtitle': 'Documentos escaneados o imÃ¡genes',
        'home.url.title': 'Enlace Web',
        'home.url.subtitle': 'Convierte URLs en audio',
        'home.text.title': 'Escribir o Pegar Texto',
        'home.text.subtitle': 'Introduce o pega texto para escuchar',
        'home.email.title': 'Correo',
        'home.email.subtitle': 'Escucha los correos electrÃ³nicos fÃ¡cilmente',
        'library.title': 'Mi Biblioteca',
        'library.tab.all': 'Todo',
        'library.tab.continue': 'Continuar',
        'library.tab.finished': 'Finalizado',
        'library.tab.favorites': 'Favoritos',
        'settings.title': 'Configuraciones',
        'settings.language': 'Idioma de la aplicaciÃ³n'
      },
      'en': {
        'appTitle': 'Listen AI Clone',
        'languageUpdated': 'Language updated',
        'nav.home': 'Home',
        'nav.library': 'My Library',
        'nav.settings': 'Settings',
        'home.banner.title': 'Get a quick summary of a file or ask AI anything',
        'home.section.title': 'What do you want to listen to today?',
        'home.document.title': 'Document',
        'home.document.subtitle': 'Upload files from Drive or device',
        'home.scan.title': 'Scan Text',
        'home.scan.subtitle': 'Scanned documents or images',
        'home.url.title': 'Web Link',
        'home.url.subtitle': 'Convert URLs to audio',
        'home.text.title': 'Write or Paste Text',
        'home.text.subtitle': 'Enter or paste text to listen',
        'home.email.title': 'Email',
        'home.email.subtitle': 'Listen to emails easily',
        'library.title': 'My Library',
        'library.tab.all': 'All',
        'library.tab.continue': 'Continue',
        'library.tab.finished': 'Finished',
        'library.tab.favorites': 'Favorites',
        'settings.title': 'Settings',
        'settings.language': 'App Language'
      },
      'pt': {
        'appTitle': 'Listen AI Clone',
        'languageUpdated': 'Idioma atualizado',
        'nav.home': 'InÃ­cio',
        'nav.library': 'Minha Biblioteca',
        'nav.settings': 'ConfiguraÃ§Ãµes',
        'home.banner.title': 'Obtenha um resumo rÃ¡pido de um arquivo ou pergunte qualquer coisa Ã  IA',
        'home.section.title': 'O que vocÃª quer ouvir hoje?',
        'library.title': 'Minha Biblioteca',
        'settings.title': 'ConfiguraÃ§Ãµes',
        'settings.language': 'Idioma do aplicativo'
      },
      'fr': {
        'appTitle': 'Listen AI Clone',
        'languageUpdated': 'Langue mise Ã  jour',
        'nav.home': 'Accueil',
        'nav.library': 'Ma BibliothÃ¨que',
        'nav.settings': 'ParamÃ¨tres',
        'home.banner.title': 'Obtenez un rÃ©sumÃ© rapide d\'un fichier ou posez n\'importe quelle question Ã  l\'IA',
        'library.title': 'Ma BibliothÃ¨que',
        'settings.title': 'ParamÃ¨tres',
        'settings.language': 'Langue de l\'application'
      }
    };

    // Fallbacks rÃ¡pidos para los nuevos idiomas desbloqueados
    TRANSLATIONS['en-US'] = TRANSLATIONS['en'];
    TRANSLATIONS['en-GB'] = TRANSLATIONS['en'];
    TRANSLATIONS['pt-BR'] = TRANSLATIONS['pt'] || TRANSLATIONS['es'];
    TRANSLATIONS['pt-PT'] = TRANSLATIONS['pt'] || TRANSLATIONS['es'];
    TRANSLATIONS['it'] = TRANSLATIONS['en'];
    TRANSLATIONS['de'] = TRANSLATIONS['en'];
    TRANSLATIONS['tr'] = TRANSLATIONS['en'];
    TRANSLATIONS['zh'] = TRANSLATIONS['en'];

    let currentLanguage = localStorage.getItem('appLanguage') || 'es';
    document.documentElement.lang = currentLanguage;

    function t(key) {
      return TRANSLATIONS[currentLanguage]?.[key] || TRANSLATIONS['es'][key] || key;
    }

    function getTranslation(key, lang = currentLanguage) {
      const languageKey = TRANSLATIONS[lang] ? lang : lang?.split('-')?.[0];
      const translations = TRANSLATIONS[languageKey] || TRANSLATIONS['es'] || {};

      if (translations[key]) return translations[key];

      if (key.includes('.')) {
        const parts = key.split('.');
        let value = translations;
        for (const part of parts) {
          value = value?.[part];
        }
        if (typeof value === 'string') return value;
      }

      return TRANSLATIONS['es']?.[key] || null;
    }

    function updateUITranslations(lang = currentLanguage) {
      document.querySelectorAll('[data-i18n]').forEach((element) => {
        const key = element.getAttribute('data-i18n');
        const translation = getTranslation(key, lang);
        if (translation) {
          element.textContent = translation;
        }
      });

      document.querySelectorAll('[data-i18n-placeholder]').forEach((element) => {
        const key = element.getAttribute('data-i18n-placeholder');
        const translation = getTranslation(key, lang);
        if (translation) {
          element.placeholder = translation;
        }
      });

      const pageTitle = document.querySelector('title');
      const translatedTitle = getTranslation('appTitle', lang);
      if (pageTitle && translatedTitle) {
        pageTitle.textContent = translatedTitle;
      }

      if (typeof actualizarTextos === 'function') {
        actualizarTextos();
      }
    }

    function updateLanguage(lang) {
      try {
        if (!TRANSLATIONS[lang]) {
          console.error('âŒ Idioma no soportado:', lang);
          return;
        }

        currentLanguage = lang;
        document.documentElement.lang = lang;
        localStorage.setItem('appLanguage', lang);

        updateUITranslations(lang);

        if (typeof renderVoices === 'function') {
          renderVoices();
        }

        const successMessage = getTranslation('languageUpdated', lang) || 'Idioma actualizado';
        mostrarPopupExito(successMessage);
        console.log(`Idioma actualizado a: ${lang}`);
      } catch (error) {
        console.error('Error al actualizar idioma:', error);
        mostrarPopupError('Error al actualizar idioma');
      }
    }

    // --- Utilidades de popups y dependencias ---
    function mostrarPopupExito(mensaje, duracion = 2000) {
      const popup = document.createElement('div');
      popup.className = 'popup-toast success';
      popup.style.cssText = `
        position: fixed;
        bottom: -100px;
        left: 50%;
        transform: translateX(-50%);
        background: #34C759;
        color: #FFF;
        padding: 16px 24px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        transition: bottom 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        max-width: 90%;
        font-weight: 500;
      `;
      popup.innerHTML = `<span style="font-size: 24px;">âœ…</span><span>${mensaje}</span>`;
      
      document.body.appendChild(popup);
      setTimeout(() => popup.style.bottom = '100px', 10);
      
      setTimeout(() => {
        popup.style.bottom = '-100px';
        setTimeout(() => popup.remove(), 400);
      }, duracion);
    }

    function mostrarPopupError(mensaje) {
      const popup = document.createElement('div');
      popup.className = 'popup-toast error';
      popup.style.cssText = `
        position: fixed;
        bottom: -100px;
        left: 50%;
        transform: translateX(-50%);
        background: #FF3B30;
        color: #FFF;
        padding: 16px 24px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        transition: bottom 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        max-width: 90%;
        font-weight: 500;
      `;
      popup.innerHTML = `<span style="font-size: 24px;">âŒ</span><span>${mensaje}</span>`;
      
      document.body.appendChild(popup);
      setTimeout(() => popup.style.bottom = '100px', 10);
      
      setTimeout(() => {
        popup.style.bottom = '-100px';
        setTimeout(() => popup.remove(), 400);
      }, 3000);
    }

    function mostrarPopupConfirmacion(titulo, mensaje, onConfirm, onCancel = null) {
      const popup = document.createElement('div');
      popup.className = 'modal-overlay active';
      popup.innerHTML = `
        <div class="popup-confirmacion">
          <h3>${titulo}</h3>
          <p>${mensaje}</p>
          <div class="popup-actions">
            <button class="btn-cancel">Cancelar</button>
            <button class="btn-confirm">Confirmar</button>
          </div>
        </div>
      `;

      document.body.appendChild(popup);

      popup.querySelector('.btn-confirm').addEventListener('click', () => {
        if (onConfirm) onConfirm();
        popup.remove();
      });

      popup.querySelector('.btn-cancel').addEventListener('click', () => {
        if (onCancel) onCancel();
        popup.remove();
      });
    }

    function toggleLoader(mostrar, titulo = 'Procesando...', mensaje = 'Esto puede tardar unos segundos') {
      if (!loaderProceso) return;
      loaderTitulo.textContent = titulo;
      loaderMensaje.textContent = mensaje;
      loaderProceso.style.display = mostrar ? 'flex' : 'none';
    }

    function actualizarTextos() {
      // NavegaciÃ³n
      const navHome = document.querySelector('[data-target="home"] span');
      const navLibrary = document.querySelector('[data-target="library"] span');
      const navSettings = document.querySelector('[data-target="settings"] span');
      if (navHome) navHome.textContent = t('nav.home');
      if (navLibrary) navLibrary.textContent = t('nav.library');
      if (navSettings) navSettings.textContent = t('nav.settings');

      // Banner
      const bannerText = document.querySelector('.promo-text p');
      if (bannerText) bannerText.textContent = t('home.banner.title');

      // TÃ­tulo secciÃ³n
      const sectionTitle = document.querySelector('.section-header h2');
      if (sectionTitle) sectionTitle.textContent = t('home.section.title');
      
      // Tarjetas
      const cards = document.querySelectorAll('.tarjeta-acceso');
      if (cards[0]) {
        cards[0].querySelector('h3').textContent = t('home.document.title');
        cards[0].querySelector('p').textContent = t('home.document.subtitle');
      }
      if (cards[1]) {
        cards[1].querySelector('h3').textContent = t('home.scan.title');
        cards[1].querySelector('p').textContent = t('home.scan.subtitle');
      }
      if (cards[2]) {
        cards[2].querySelector('h3').textContent = t('home.url.title');
        cards[2].querySelector('p').textContent = t('home.url.subtitle');
      }
      if (cards[3]) {
        cards[3].querySelector('h3').textContent = t('home.text.title');
        cards[3].querySelector('p').textContent = t('home.text.subtitle');
      }
      if (cards[4]) {
        cards[4].querySelector('h3').textContent = t('home.email.title');
        cards[4].querySelector('p').textContent = t('home.email.subtitle');
      }
      
      // Biblioteca
      const libTitle = document.querySelector('.library-header h1');
      if (libTitle) libTitle.textContent = t('library.title');
      
      // Tabs
      const tabs = document.querySelectorAll('.tab');
      if (tabs[0]) tabs[0].textContent = t('library.tab.all');
      if (tabs[1]) tabs[1].textContent = t('library.tab.continue');
      if (tabs[2]) tabs[2].textContent = t('library.tab.finished');
      if (tabs[3]) tabs[3].textContent = t('library.tab.favorites');
      
      // Configuraciones
      const settingsTitle = document.querySelector('#settings .settings-page h1');
      if (!settingsTitle) {
        const settingsHeader = document.querySelector('#settings');
        if (settingsHeader) {
          let h1 = settingsHeader.querySelector('h1');
          if (!h1) {
            h1 = document.createElement('h1');
            settingsHeader.insertBefore(h1, settingsHeader.firstChild);
          }
          h1.textContent = t('settings.title');
        }
      } else {
        settingsTitle.textContent = t('settings.title');
      }
    }

    function cambiarIdioma(nuevoIdioma) {
      updateLanguage(nuevoIdioma);
    }
    
    function abrirModalIdiomas() {
      console.log('ðŸŒ Abriendo modal de idiomas');
      const languageList = document.getElementById('language-list');

      if (!languageList || !languageModal) {
        console.error('âŒ No se encontrÃ³ el contenedor de idiomas');
        return;
      }

      languageList.innerHTML = '';

      const idiomas = [
        { code: 'en-US', nombre: 'InglÃ©s (EE.UU) - en-US', flag: 'ðŸ‡ºðŸ‡¸' },
        { code: 'en-GB', nombre: 'InglÃ©s (Reino Unido) - en-GB', flag: 'ðŸ‡¬ðŸ‡§' },
        { code: 'es', nombre: 'EspaÃ±ol - es', flag: 'ðŸ‡ªðŸ‡¸' },
        { code: 'pt-BR', nombre: 'BrasileÃ±o - pt-BR', flag: 'ðŸ‡§ðŸ‡·' },
        { code: 'pt-PT', nombre: 'PortuguÃ©s - pt-PT', flag: 'ðŸ‡µðŸ‡¹' },
        { code: 'fr', nombre: 'FrancÃ©s - fr', flag: 'ðŸ‡«ðŸ‡·' },
        { code: 'it', nombre: 'Italiano - it', flag: 'ðŸ‡®ðŸ‡¹' },
        { code: 'de', nombre: 'AlemÃ¡n - de', flag: 'ðŸ‡©ðŸ‡ª' },
        { code: 'tr', nombre: 'Turco - tr', flag: 'ðŸ‡¹ðŸ‡·' },
        { code: 'zh', nombre: 'Chino simplificado - zh', flag: 'ðŸ‡¨ðŸ‡³' }
      ];

      idiomas.forEach((idioma) => {
        const item = document.createElement('div');
        item.className = 'idioma-item';
        if (currentLanguage === idioma.code) {
          item.classList.add('activo');
        }

        item.innerHTML = `
          <span style="font-size: 32px; margin-right: 12px;">${idioma.flag}</span>
          <div style="display:flex; flex-direction:column; gap:2px;">
            <span style="font-weight:800;">${idioma.nombre}</span>
            <small style="color:#666;">${idioma.code}</small>
          </div>
        `;

        item.addEventListener('click', () => {
          console.log('ðŸŒ Cambiando idioma a:', idioma.code);
          cambiarIdioma(idioma.code);
          closeModals();
        });

        languageList.appendChild(item);
      });

      openModal(languageModal);
    }

    function mostrarPopupInput(titulo, placeholder, onSubmit) {
      const popup = document.createElement('div');
      popup.className = 'modal-overlay active';
      popup.innerHTML = `
        <div style="background: #FFF; border-radius: 20px; padding: 28px; max-width: 400px; width: 90%; margin: auto; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);">
          <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 16px; text-align: center;">${titulo}</h3>
          <input type="text" placeholder="${placeholder}" id="popup-input-field" style="width: 100%; padding: 14px; border: 2px solid #E5E5E5; border-radius: 12px; font-size: 16px; margin-bottom: 20px;" />
          <div style="display: flex; gap: 12px;">
            <button class="btn-cancel" style="flex: 1; padding: 14px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; background: #F5F5F5; color: #666;">Cancelar</button>
            <button class="btn-submit" style="flex: 1; padding: 14px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #FFB800, #FF9500); color: #FFF;">Enviar</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(popup);
      
      const input = popup.querySelector('#popup-input-field');
      input.focus();
      
      popup.querySelector('.btn-submit').addEventListener('click', () => {
        const value = input.value.trim();
        if (value && onSubmit) {
          onSubmit(value);
          popup.remove();
        }
      });
      
      popup.querySelector('.btn-cancel').addEventListener('click', () => {
        popup.remove();
      });
      
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          popup.querySelector('.btn-submit').click();
        }
      });
    }

    const tesseractScript = document.createElement('script');
    tesseractScript.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js';
    document.head.appendChild(tesseractScript);

    // --- TTS Engine ---
    let voices = [];
    let utterance = null;

    function loadVoices(onReady) {
      const synth = window.speechSynthesis;
      const populate = () => {
        voices = synth.getVoices();
        if (voices.length && onReady) onReady(voices);
      };
      populate();
      synth.onvoiceschanged = populate;
    }

    function speak(text, voiceName, rate, onStart, onEnd) {
      const synth = window.speechSynthesis;
      if (synth.speaking) synth.cancel();
      utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = rate;
      utterance.pitch = 1;
      const voice = voices.find((v) => v.name.includes(voiceName)) || voices[0];
      utterance.voice = voice;
      utterance.onstart = () => onStart && onStart();
      utterance.onend = () => onEnd && onEnd();
      synth.speak(utterance);
      return null;
    }

    function dividirEnChunks(texto, limite = 4800) {
      const palabras = texto.split(/\s+/);
      const chunks = [];
      let actual = '';

      palabras.forEach((palabra) => {
        const candidato = actual ? `${actual} ${palabra}` : palabra;
        if (candidato.length > limite) {
          chunks.push(actual.trim());
          actual = palabra;
        } else {
          actual = candidato;
        }
      });

      if (actual.trim()) chunks.push(actual.trim());
      return chunks;
    }

    function delay(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    }

    async function fetchWithTimeout(url, options = {}, timeoutMs = 60000, controller) {
      const abortController = controller || new AbortController();
      let timedOut = false;
      const timeoutId = setTimeout(() => {
        timedOut = true;
        abortController.abort('timeout');
      }, timeoutMs);

      try {
        const response = await fetch(url, { ...options, signal: abortController.signal });
        clearTimeout(timeoutId);
        return response;
      } catch (error) {
        clearTimeout(timeoutId);
        if (timedOut || abortController.signal?.reason === 'timeout') {
          const timeoutError = new Error(`Tiempo de espera de ${timeoutMs / 1000}s excedido`);
          timeoutError.name = 'TimeoutError';
          throw timeoutError;
        }
        throw error;
      }
    }

    async function generateGoogleTTS(text, voiceName, apiKey, speakingRate = 1.0, controller) {
      const url = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${apiKey}`;
      const voiceId = voiceName || 'es-ES-Neural2-A';
      const [langPart, regionPart] = voiceId.split('-');
      const languageCode = (langPart && regionPart) ? `${langPart}-${regionPart}` : 'es-ES';
      const payload = {
        input: { text },
        voice: { languageCode, name: voiceId },
        audioConfig: {
          audioEncoding: 'MP3',
          speakingRate: Math.max(0.25, Math.min(4.0, speakingRate)),
        }
      };

      const maxRetries = 2;
      let attempt = 0;
      let backoff = 500;

      while (attempt <= maxRetries) {
        try {
          const response = await fetchWithTimeout(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }, 60000, controller);

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData?.error?.message || `HTTP ${response.status}`);
          }

          const data = await response.json();
          if (!data.audioContent) throw new Error('Google TTS no devolviÃ³ audio');

          return base64ToBlob(data.audioContent, 'audio/mp3');
        } catch (error) {
          const isAbort = error.name === 'AbortError';
          const isTimeout = error.name === 'TimeoutError';
          const isNetworkError = error instanceof TypeError && !isAbort;

          if ((isNetworkError || isTimeout) && attempt < maxRetries) {
            attempt += 1;
            const attemptLabel = `${attempt + 1}/${maxRetries + 1}`;
            console.warn(`âš ï¸ FallÃ³ la generaciÃ³n de audio (intento ${attemptLabel}). Reintentando en ${backoff}ms...`, error);
            await delay(backoff);
            backoff *= 2;
            continue;
          }

          throw error;
        }
      }
    }

    async function speakNatural(texto, vozNombre, velocidad = 1.0, options = {}) {
      const { silenciarErrores = false } = options;

      if (currentTTSAbortController) {
        currentTTSAbortController.abort();
      }
      currentTTSAbortController = new AbortController();

      // VALIDACIÃ“N ESTRICTA DE API KEY
      let apiKey = userGoogleTTSKey;
      if (!apiKey && currentUser?.uid && isFirebaseAvailable()) {
        apiKey = await getUserAPIKey(currentUser.uid);
        if (apiKey) {
          await setStoredApiKey(apiKey);
        }
      }
      
      // SI NO HAY API KEY, MOSTRAR ERROR Y DETENER
      if (!apiKey) {
        if (!silenciarErrores) {
          mostrarPopupError('ðŸ”‘ Configura tu API Key de Google Cloud TTS para usar voces naturales');
          setTimeout(() => mostrarApiKeySetupModal(), 500);
        }
        console.error('âŒ No se puede reproducir: falta API Key de Google Cloud TTS');
        return null;
      }
      
      const vozConfig = VOICE_CONFIG[vozNombre] || getAvailableVoices().find((v) => v.nombre === vozNombre);
      
      if (!vozConfig) {
        console.error('âŒ Voz no configurada:', vozNombre);
        if (!silenciarErrores) {
          mostrarPopupError(`âŒ Voz "${vozNombre}" no disponible`);
        }
        return null;
      }
      
      try {
        const textoLimpio = (texto ?? '').replace(/[\u0000-\u001F\u007F-\u009F]/g, '').trim();
        const chunks = dividirEnChunks(textoLimpio);
        
        if (!chunks.length) {
          if (!silenciarErrores) mostrarPopupError('No hay texto para reproducir.');
          return null;
        }
        
        const audioBuffers = [];
        console.log('ðŸŽ™ï¸ Generando audio con Google Cloud TTS Neural2:', vozConfig.googleVoice);
        
        for (const parte of chunks) {
          console.log('ðŸ“ Procesando chunk:', parte.substring(0, 50) + '...');
          try {
            const blob = await generateGoogleTTS(parte, vozConfig.googleVoice, apiKey, velocidad, currentTTSAbortController);
            audioBuffers.push(blob);
          } catch (error) {
            console.error('âŒ Google TTS Error:', error);
            const message = error?.message || 'Error desconocido';
            let popupMessage = `âŒ Error con Google Cloud TTS: ${message}. Verifica tu API Key.`;

            if (error.name === 'AbortError') {
              console.warn('âš ï¸ GeneraciÃ³n de audio cancelada');
              return null;
            }

            if (error.name === 'TimeoutError') {
              popupMessage = 'â³ Tiempo de espera agotado al generar audio tras varios intentos. Intenta de nuevo.';
              if (!silenciarErrores) {
                mostrarPopupError(popupMessage);
              }
              return null;
            }

            // ERRORES ESPECÃFICOS CON MENSAJES CLAROS
            if (message.includes('403') || message.includes('permission')) {
              await setStoredApiKey(null);
              actualizarEstadoAPIKeyUI(false);
              if (!silenciarErrores) {
                popupMessage = 'âŒ API Key sin permisos. Verifica que estÃ© habilitada la API de Text-to-Speech en Google Cloud.';
                mostrarPopupError(popupMessage);
                setTimeout(() => mostrarApiKeySetupModal(), 1000);
              }
            } else if (message.includes('429') || message.includes('quota')) {
              if (!silenciarErrores) {
                popupMessage = 'âš ï¸ LÃ­mite de cuota de Google Cloud TTS excedido. Intenta mÃ¡s tarde.';
                mostrarPopupError(popupMessage);
              }
            } else if (message.includes('401') || message.includes('invalid')) {
              await setStoredApiKey(null);
              actualizarEstadoAPIKeyUI(false);
              if (!silenciarErrores) {
                popupMessage = 'âŒ API Key invÃ¡lida. Verifica tu clave de Google Cloud.';
                mostrarPopupError(popupMessage);
                setTimeout(() => mostrarApiKeySetupModal(), 1000);
              }
            } else {
              if (!silenciarErrores) {
                mostrarPopupError(popupMessage);
              }
            }
            
            // NO HACER FALLBACK - Retornar null
            return null;
          }
        }

        const audioBlob = new Blob(audioBuffers, { type: 'audio/mp3' });
        const audioUrl = URL.createObjectURL(audioBlob);
        const audio = new Audio(audioUrl);
        audio.addEventListener('ended', () => URL.revokeObjectURL(audioUrl), { once: true });
        
        console.log('âœ… Audio generado exitosamente con Google Cloud TTS Neural2');
        setVoiceSystem('google', vozConfig?.nombre || vozNombre);
        return audio;
        
      } catch (error) {
        console.error('âŒ Error en sÃ­ntesis de voz:', error);
        if (!silenciarErrores) {
          mostrarPopupError(`âŒ Error inesperado: ${error.message}`);
        }
        return null;
      } finally {
        currentTTSAbortController = null;
      }
    }

    function base64ToBlob(base64, mimeType) {
      const byteCharacters = atob(base64);
      const byteNumbers = new Array(byteCharacters.length);

      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }

      const byteArray = new Uint8Array(byteNumbers);
      return new Blob([byteArray], { type: mimeType });
    }

    function usarVozNavegador(texto, vozConfig, velocidad) {
      return new Promise((resolve) => {
        const synth = window.speechSynthesis;
        const utterance = new SpeechSynthesisUtterance(texto);

        const voices = synth.getVoices();
        const lang = vozConfig?.languageCode || 'es-ES';

        let selectedVoice = voices.find(v => v.lang === lang);
        if (!selectedVoice) selectedVoice = voices.find(v => v.lang.startsWith(lang.split('-')[0]));
        if (!selectedVoice) selectedVoice = voices[0];

        const voiceLabel = selectedVoice?.name || vozConfig?.nombre || vozSeleccionada;
        if (!userGoogleTTSKey) {
          vozSeleccionada = voiceLabel;
          localStorage.setItem('vozSeleccionada', vozSeleccionada);
        }
        setVoiceSystem('browser', voiceLabel);
        actualizarAvatarVoz(vozSeleccionada);

        utterance.voice = selectedVoice;
        utterance.rate = velocidad;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;

        console.log('ðŸ”Š Usando voz del navegador:', selectedVoice?.name);

        const duracionEstimada = calcularDuracion(texto);
        let startTime = 0;
        let intervaloProgreso;

        const audioMock = {
          paused: true,
          currentTime: 0,
          duration: duracionEstimada,
          play: () => {
            synth.cancel();
            startTime = performance.now();
            audioMock.paused = false;
            synth.speak(utterance);
            intervaloProgreso = setInterval(() => {
              const elapsed = (performance.now() - startTime) / 1000;
              audioMock.currentTime = Math.min(elapsed, duracionEstimada);
              audioMock._timeupdate?.forEach(cb => cb());
              if (!synth.speaking) clearInterval(intervaloProgreso);
            }, 250);
          },
          pause: () => {
            synth.pause();
            audioMock.paused = true;
          },
          addEventListener: (event, callback) => {
            if (event === 'ended') utterance.onend = callback;
            if (event === 'timeupdate') {
              audioMock._timeupdate = audioMock._timeupdate || [];
              audioMock._timeupdate.push(callback);
            }
          }
        };

        resolve(audioMock);
      });
    }


    function stop() {
      const synth = window.speechSynthesis;
      if (synth.speaking) synth.cancel();
    }

    function isSpeaking() {
      return window.speechSynthesis.speaking;
    }

    // --- File Processor ---
    async function extraerTextoPDF(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let textoCompleto = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map((item) => item.str).join(' ');
        textoCompleto += pageText + '\n';
      }
      return textoCompleto.trim();
    }

    async function extraerTextoDOCX(file) {
      const arrayBuffer = await file.arrayBuffer();
      const result = await window.mammoth.extractRawText({ arrayBuffer });
      return result.value;
    }

    async function extraerTextoURL(url) {
      const sanitizeDoc = (html) => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        ['script', 'style', 'nav', 'header', 'footer', 'aside'].forEach((tag) => {
          doc.querySelectorAll(tag).forEach((el) => el.remove());
        });
        return doc.body.innerText.trim();
      };

      const fuentes = [
        (u) => `https://r.jina.ai/${u.replace(/^https?:\/\//, '')}`,
        (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
        (u) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`
      ];

      let ultimoError = null;
      for (const builder of fuentes) {
        try {
          const endpoint = builder(url);
          const response = await fetch(endpoint);
          if (!response.ok) throw new Error(`Status ${response.status}`);
          const text = await response.text();
          const contenido = text?.includes('<') ? sanitizeDoc(text) : text?.trim();
          if (contenido) return contenido;
        } catch (error) {
          ultimoError = error;
          console.warn('âš ï¸ Fallback CORS proxy fallÃ³', error);
          continue;
        }
      }

      throw new Error(ultimoError?.message || 'No se pudo obtener el contenido de la URL');
    }

    // --- Database ---
    const dbName = 'ListenAIDB';
    const dbVersion = 1;
    const generateId = () => (crypto.randomUUID ? crypto.randomUUID() : `doc_${Date.now()}_${Math.random().toString(16).slice(2)}`);

    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(dbName, dbVersion);
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('documentos')) {
            const store = db.createObjectStore('documentos', { keyPath: 'id', autoIncrement: true });
            store.createIndex('fecha', 'fecha', { unique: false });
            store.createIndex('tipo', 'tipo', { unique: false });
            store.createIndex('estado', 'estado', { unique: false });
          }
        };
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    async function addDocumento(doc) {
      const db = await openDB();
      const tx = db.transaction('documentos', 'readwrite');
      const store = tx.objectStore('documentos');
      const payload = {
        ...doc,
        id: doc.id || generateId(),
        fecha: doc.fecha || new Date().toISOString(),
        estado: doc.estado || 'todo',
        favorito: !!doc.favorito,
        posicionReproduccion: doc.posicionReproduccion || 0,
        vozSeleccionada: doc.vozSeleccionada || doc.voz || 'Sasha',
        velocidad: doc.velocidad || doc.speed || 1.0,
      };
      const req = store.put(payload);
      return new Promise((resolve, reject) => {
        req.onsuccess = () => tx.oncomplete = () => resolve(payload.id);
        req.onerror = () => reject(req.error);
      });
    }

    async function getDocumentos(userId = null) {
      const db = await openDB();
      const tx = db.transaction('documentos', 'readonly');
      const store = tx.objectStore('documentos');
      return new Promise((resolve, reject) => {
        const req = store.getAll();
        req.onsuccess = () => {
          const docs = req.result || [];
          resolve(userId ? docs.filter((doc) => doc.userId === userId) : docs);
        };
        req.onerror = () => reject(req.error);
      });
    }

    async function updateDocumento(id, updates) {
      const db = await openDB();
      const tx = db.transaction('documentos', 'readwrite');
      const store = tx.objectStore('documentos');
      const current = await new Promise((resolve, reject) => {
        const req = store.get(id);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
      if (!current) return;
      const putReq = store.put({ ...current, ...updates });
      const shouldSync = isAuthenticated() && current.userId === currentUser.uid;
      return new Promise((resolve, reject) => {
        putReq.onsuccess = () => tx.oncomplete = async () => {
          if (shouldSync) {
            try {
              await updateFirestoreDocument(current.userId || currentUser?.uid, id, updates);
            } catch (error) {
              console.error('No se pudo sincronizar con Firestore', error);
            }
          }
          resolve(current);
        };
        putReq.onerror = () => reject(putReq.error);
      });
    }

    async function deleteDocumento(id) {
      const db = await openDB();
      const tx = db.transaction('documentos', 'readwrite');
      const delReq = tx.objectStore('documentos').delete(id);
      const shouldSync = isAuthenticated() && !!id;
      return new Promise((resolve, reject) => {
        delReq.onsuccess = () => tx.oncomplete = async () => {
          if (shouldSync) {
            try {
              await deleteFirestoreDocument(currentUser?.uid, id);
            } catch (error) {
              console.error('No se pudo eliminar en Firestore', error);
            }
          }
          resolve();
        };
        delReq.onerror = () => reject(delReq.error);
      });
    }

    async function clearLocalDocumentos() {
      const db = await openDB();
      const tx = db.transaction('documentos', 'readwrite');
      const clearReq = tx.objectStore('documentos').clear();
      return new Promise((resolve, reject) => {
        clearReq.onsuccess = () => tx.oncomplete = () => resolve();
        clearReq.onerror = () => reject(clearReq.error);
      });
    }

    async function getDocumento(id) {
      const db = await openDB();
      const tx = db.transaction('documentos', 'readonly');
      const store = tx.objectStore('documentos');
      return new Promise((resolve) => {
        const req = store.get(id);
        req.onsuccess = () => resolve(req.result);
      });
    }

    // --- Main App Logic ---
    const appContainer = document.getElementById('app');
    const authScreen = document.getElementById('auth-screen');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const loginTab = document.getElementById('login-tab');
    const signupTab = document.getElementById('signup-tab');
    const authError = document.getElementById('auth-error');
    const authSuccess = document.getElementById('auth-success');
    const loginButton = document.getElementById('login-button');
    const guestButton = document.getElementById('guest-button');
    const signupButton = document.getElementById('signup-button');
    const rememberMe = document.getElementById('remember-me');
    const forgotPassword = document.getElementById('forgot-password');
    const userEmailDisplay = document.getElementById('user-email-display');
    const emailVerifiedBadge = document.getElementById('email-verified-badge');
    const logoutAction = document.getElementById('logout-action');
    const pages = document.querySelectorAll('.page');
    const navItems = document.querySelectorAll('.nav-item');
    const modalOverlay = document.getElementById('modal-overlay');
    const voiceModal = document.getElementById('voice-modal');
    const speedModal = document.getElementById('speed-modal');
    const docMenu = document.getElementById('doc-menu');
    const notesModal = document.getElementById('notes-modal');
    const languageModal = document.getElementById('language-modal');
    const requestForm = document.getElementById('request-form');
    const docList = document.getElementById('document-list');
    const voiceBtn = document.getElementById('voice-btn');
    const speedBtn = document.getElementById('speed-btn');
    const speedSlider = document.getElementById('speed-slider');
    const speedButtons = document.getElementById('speed-buttons');
    const voiceList = document.getElementById('voice-list');
    const saveVoiceBtn = document.getElementById('save-voice');
    const playerBackBtn = document.querySelector('[data-action="back"]');
    const fab = document.getElementById('add-btn');
    const fileInput = document.getElementById('file-input');
    const imageInput = document.getElementById('image-input');
    const fileSourceModal = document.getElementById('file-source-modal');
    const pickFromDevice = document.getElementById('pick-from-device');
    const pickFromDrive = document.getElementById('pick-from-drive');
    const playerTitle = document.getElementById('player-title');
    const playerText = document.getElementById('player-text');
    const playPauseBtn = document.getElementById('play-pause');
    const backBtn = document.getElementById('backward');
    const forwardBtn = document.getElementById('forward');
    const progressBar = document.getElementById('progress-bar');
    const progress = document.getElementById('progress');
    const progressThumb = document.getElementById('progress-thumb');
    const timeStart = document.getElementById('time-start');
    const timeEnd = document.getElementById('time-end');
    const openTextConfigBtn = document.getElementById('open-text-config');
    const textConfigOverlay = document.getElementById('text-config-overlay');
    const textConfigPanel = document.getElementById('text-config-panel');
    const closeTextConfigBtn = document.getElementById('close-text-config');
    const dockTextConfigBtn = document.getElementById('dock-text-config');
    const fontSizeSlider = document.getElementById('font-size-slider');
    const fontSizeValue = document.getElementById('font-size-value');
    const fontQuickButtons = document.getElementById('font-quick-buttons');
    const fontFamilySelect = document.getElementById('font-family-select');
    const lineHeightOptions = document.getElementById('line-height-options');
    const letterSpacingOptions = document.getElementById('letter-spacing-options');
    const wordSpacingOptions = document.getElementById('word-spacing-options');
    const paragraphSpacingOptions = document.getElementById('paragraph-spacing-options');
    const textAlignOptions = document.getElementById('text-align-options');
    const columnWidthOptions = document.getElementById('column-width-options');
    const colorPresetsContainer = document.getElementById('color-presets');
    const textColorPicker = document.getElementById('text-color-picker');
    const bgColorPicker = document.getElementById('bg-color-picker');
    const highlightSentenceToggle = document.getElementById('highlight-sentence-toggle');
    const highlightWordToggle = document.getElementById('highlight-word-toggle');
    const highContrastToggle = document.getElementById('high-contrast-toggle');
    const textPreview = document.getElementById('text-preview');
    const contrastWarning = document.getElementById('contrast-warning');
    const saveTextConfigBtn = document.getElementById('save-text-config');
    const resetTextConfigBtn = document.getElementById('reset-text-config');
    const textPreviewBox = document.getElementById('text-preview-box');
    const docMenuTitle = document.getElementById('doc-menu-title');
    const docMenuType = document.getElementById('doc-menu-type');
    const docPreview = document.getElementById('doc-preview');
    const docVoiceLabel = document.getElementById('doc-voice');
    const notesArea = document.getElementById('notes-area');
    const notesEmpty = document.getElementById('notes-empty');
    const deleteNoteBtn = document.getElementById('delete-note');
    const charCounter = document.getElementById('char-counter');
    const sendIdea = document.getElementById('send-idea');
    const ideaInfo = document.getElementById('idea-info');
    const editModal = document.getElementById('edit-modal');
    const editTitle = document.getElementById('edit-title');
    const editContent = document.getElementById('edit-content');
    const saveEdit = document.getElementById('save-edit');
    const cancelEdit = document.getElementById('cancel-edit');
    const loaderProceso = document.getElementById('loader-proceso');
    const loaderTitulo = document.getElementById('loader-titulo');
    const loaderMensaje = document.getElementById('loader-mensaje');
    const vozActualLabel = document.getElementById('voz-actual');

    let documentos = [];
    let filtroActual = 'todo';
    let documentoActivo = null;
    let vozSeleccionada = localStorage.getItem('vozSeleccionada') || 'Sasha';
    let velocidadActual = Number(localStorage.getItem('velocidadActual') || 1.0);
    let voiceSystem = 'browser';
    let lecturaTimer = null;
    let lecturaInicio = null;
    let palabrasTotales = 0;
    let palabraElements = [];
    let currentSentenceId = null;
    let textConfig = { ...TEXT_CONFIG_DEFAULTS };
    let dockedConfigPanel = false;
    let notas = JSON.parse(localStorage.getItem('notasApp') || '{}');
    let audioDuration = 0;

    const getTextConfigKey = () => `textConfig_${currentUser?.uid || 'guest'}`;

    function loadTextConfig() {
      try {
        const stored = localStorage.getItem(getTextConfigKey());
        return stored ? { ...TEXT_CONFIG_DEFAULTS, ...JSON.parse(stored) } : { ...TEXT_CONFIG_DEFAULTS };
      } catch (error) {
        console.warn('No se pudo cargar la configuraciÃ³n de lectura', error);
        return { ...TEXT_CONFIG_DEFAULTS };
      }
    }

    function persistTextConfig(config = textConfig) {
      localStorage.setItem(getTextConfigKey(), JSON.stringify(config));
    }

    function contrastRatio(hex1, hex2) {
      const parse = (hex) => hex.replace('#', '').match(/.{1,2}/g).map((c) => parseInt(c, 16) / 255);
      const [r1, g1, b1] = parse(hex1);
      const [r2, g2, b2] = parse(hex2);
      const lum = (r, g, b) => {
        const channel = (v) => (v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4));
        return 0.2126 * channel(r) + 0.7152 * channel(g) + 0.0722 * channel(b);
      };
      const L1 = lum(r1, g1, b1) + 0.05;
      const L2 = lum(r2, g2, b2) + 0.05;
      return L1 > L2 ? L1 / L2 : L2 / L1;
    }

    function updateContrastWarning(config) {
      const ratio = contrastRatio(config.textColor, config.backgroundColor);
      const meetsAa = ratio >= 4.5;
      contrastWarning.style.display = meetsAa ? 'none' : 'block';
      textPreviewBox.style.borderColor = meetsAa ? 'var(--borde-gris)' : '#FFB800';
      return meetsAa;
    }

    function markActiveChip(container, value) {
      container?.querySelectorAll('.chip').forEach((chip) => {
        chip.classList.toggle('active', `${chip.dataset.value}` === `${value}`);
      });
    }

    function renderChips(container, options, currentValue, onSelect) {
      if (!container) return;
      container.innerHTML = '';
      options.forEach((opt) => {
        const btn = document.createElement('button');
        btn.className = 'chip';
        btn.textContent = opt.label;
        btn.dataset.value = opt.value;
        if (`${opt.value}` === `${currentValue}`) btn.classList.add('active');
        btn.addEventListener('click', () => {
          onSelect(opt.value);
          markActiveChip(container, opt.value);
        });
        container.appendChild(btn);
      });
    }

    function applyTextConfig(save = false) {
      let cfg = { ...TEXT_CONFIG_DEFAULTS, ...textConfig };

      if (cfg.highContrast) {
        cfg = { ...cfg, textColor: HIGH_CONTRAST_TEXT, backgroundColor: HIGH_CONTRAST_BACKGROUND };
      }

      if (contrastRatio(cfg.textColor, cfg.backgroundColor) < 4.5 && !cfg.highContrast) {
        cfg = { ...cfg, textColor: '#1A1A1A', backgroundColor: '#FFFFFF' };
      }

      textConfig = cfg;

      fontSizeSlider.value = cfg.fontSize;
      fontSizeValue.textContent = `${cfg.fontSize}px`;
      fontFamilySelect.value = cfg.fontFamily;
      textColorPicker.value = cfg.textColor;
      bgColorPicker.value = cfg.backgroundColor;
      highlightSentenceToggle.checked = cfg.highlightSentence;
      highlightWordToggle.checked = cfg.highlightWord;
      highContrastToggle.checked = cfg.highContrast;

      playerText.style.setProperty('--texto-lector-size', `${cfg.fontSize}px`);
      playerText.style.setProperty('--texto-lector-line-height', cfg.lineHeight);
      playerText.style.setProperty('--texto-lector-letter', `${cfg.letterSpacing}em`);
      playerText.style.setProperty('--texto-lector-word', `${cfg.wordSpacing}em`);
      playerText.style.setProperty('--texto-lector-paragraph', `${cfg.paragraphSpacing}em`);
      playerText.style.setProperty('--texto-lector-align', cfg.textAlign);
      playerText.style.setProperty('--texto-lector-bg', cfg.backgroundColor);
      playerText.style.setProperty('--texto-lector-color', cfg.textColor);
      playerText.style.setProperty('--column-width', cfg.columnWidth);
      playerText.style.fontFamily = cfg.fontFamily;

      textPreview.style.fontSize = `${cfg.fontSize}px`;
      textPreview.style.lineHeight = cfg.lineHeight;
      textPreview.style.letterSpacing = `${cfg.letterSpacing}em`;
      textPreview.style.wordSpacing = `${cfg.wordSpacing}em`;
      textPreview.style.textAlign = cfg.textAlign;
      textPreview.style.fontFamily = cfg.fontFamily;
      textPreviewBox.style.maxWidth = cfg.columnWidth;
      textPreviewBox.style.background = cfg.backgroundColor;
      textPreviewBox.style.color = cfg.textColor;

      markActiveChip(fontQuickButtons, cfg.fontSize);
      markActiveChip(lineHeightOptions, cfg.lineHeight);
      markActiveChip(letterSpacingOptions, cfg.letterSpacing);
      markActiveChip(wordSpacingOptions, cfg.wordSpacing);
      markActiveChip(paragraphSpacingOptions, cfg.paragraphSpacing);
      markActiveChip(textAlignOptions, cfg.textAlign);
      markActiveChip(columnWidthOptions, cfg.columnWidth);

      updateContrastWarning(cfg);

      if (save) persistTextConfig(cfg);
    }

    function hydrateTextConfigUI() {
      renderChips(fontQuickButtons, FONT_PRESETS, textConfig.fontSize, (value) => {
        textConfig.fontSize = Number(value);
        applyTextConfig(true);
      });

      renderChips(lineHeightOptions, LINE_HEIGHT_PRESETS, textConfig.lineHeight, (value) => {
        textConfig.lineHeight = Number(value);
        applyTextConfig(true);
      });

      renderChips(letterSpacingOptions, LETTER_SPACING_PRESETS, textConfig.letterSpacing, (value) => {
        textConfig.letterSpacing = Number(value);
        applyTextConfig(true);
      });

      renderChips(wordSpacingOptions, WORD_SPACING_PRESETS, textConfig.wordSpacing, (value) => {
        textConfig.wordSpacing = Number(value);
        applyTextConfig(true);
      });

      renderChips(paragraphSpacingOptions, PARAGRAPH_SPACING_PRESETS, textConfig.paragraphSpacing, (value) => {
        textConfig.paragraphSpacing = Number(value);
        applyTextConfig(true);
      });

      renderChips(textAlignOptions, TEXT_ALIGN_PRESETS, textConfig.textAlign, (value) => {
        textConfig.textAlign = value;
        applyTextConfig(true);
      });

      renderChips(columnWidthOptions, COLUMN_WIDTH_PRESETS, textConfig.columnWidth, (value) => {
        textConfig.columnWidth = value;
        applyTextConfig(true);
      });

      if (colorPresetsContainer) {
        colorPresetsContainer.innerHTML = '';
        COLOR_PRESETS.forEach((preset) => {
          const btn = document.createElement('button');
          btn.className = 'color-preset';
          btn.dataset.text = preset.text;
          btn.dataset.bg = preset.bg;
          btn.innerHTML = `<div class="dual-swatches"><span class="swatch" style="background:${preset.text};"></span><span class="swatch" style="background:${preset.bg};"></span></div><span>${preset.label}</span>`;
          btn.addEventListener('click', () => {
            textConfig.textColor = preset.text;
            textConfig.backgroundColor = preset.bg;
            textConfig.highContrast = preset.label.toLowerCase().includes('alto');
            applyTextConfig(true);
          });
          colorPresetsContainer.appendChild(btn);
        });
      }

      applyTextConfig();
    }
    textConfig = loadTextConfig();
    hydrateTextConfigUI();
    let audioElement = null;
    let audioObjectUrl = null;
    let isGeneratingAudio = false;
    let currentTTSAbortController = null;

    const setGuestMode = (value) => {
      isGuestMode = value;
      localStorage.setItem(GUEST_MODE_KEY, value ? 'true' : 'false');
      if (value) {
        currentUser = null;
        stopFirestoreListener();
        userGoogleTTSKey = getGuestAPIKey();
        actualizarEstadoAPIKeyUI(!!userGoogleTTSKey);
        updateApiKeySettingsUI();
      }
    };

    const isAuthenticated = () => firebaseAppInitialized && !!firebase.auth().currentUser;
    const isGuestSession = () => !isAuthenticated() || isGuestMode;
    const isFirebaseAvailable = () => !isGuestMode && firebaseAppInitialized;

    function showLoginScreen(message = '') {
      if (authScreen) authScreen.style.display = 'flex';
      if (appContainer) appContainer.style.display = 'none';
      if (message) {
        showAuthErrorMessage(message, true);
      }
    }

    function showMainApp() {
      if (authScreen) authScreen.style.display = 'none';
      if (appContainer) appContainer.style.display = 'block';
      switchPage('home');
      if (isGuestMode) {
        updateAccountInfo(null);
        updateFirebaseStatusLabel('Modo invitado');
      }
    }

    function toggleAuthForms(showSignup) {
      if (!loginForm || !signupForm) return;
      loginForm.style.display = showSignup ? 'none' : 'flex';
      signupForm.style.display = showSignup ? 'flex' : 'none';
      loginTab.classList.toggle('active', !showSignup);
      signupTab.classList.toggle('active', showSignup);
      const title = document.getElementById('auth-title');
      const subtitle = document.getElementById('auth-subtitle');
      if (title) title.textContent = showSignup ? 'Crea tu cuenta' : 'Bienvenido de vuelta';
      if (subtitle) subtitle.textContent = showSignup ? 'RegÃ­strate para guardar tus documentos en la nube' : 'Inicia sesiÃ³n para acceder a tu biblioteca';
      authError.style.display = 'none';
      authSuccess.style.display = 'none';
    }

    function showAuthErrorMessage(message, options = {}) {
      if (!authError) return;
      const normalizedOptions = typeof options === 'boolean' ? { includeSignupLink: options } : options;
      const { includeSignupLink = false, includeLoginLink = false, loginEmail = '', errorCode = '' } = normalizedOptions;

      const signupLink = includeSignupLink
        ? ` <button id="switch-to-signup" style="border:none;background:none;color:var(--naranja-botones);font-weight:800;cursor:pointer;text-decoration:underline;">Crear cuenta</button>`
        : '';
      const loginLink = includeLoginLink
        ? ` <button id="switch-to-login" style="border:none;background:none;color:var(--naranja-botones);font-weight:800;cursor:pointer;text-decoration:underline;">Iniciar sesiÃ³n</button>`
        : '';
      const codeLabel = errorCode ? `<div style="margin-top:6px;font-size:12px;color:#8e44ad;">CÃ³digo: ${errorCode}</div>` : '';

      authError.innerHTML = `${message}${codeLabel}${signupLink}${loginLink}`;
      authError.style.display = 'block';
      authSuccess.style.display = 'none';

      if (includeSignupLink) {
        const switchBtn = document.getElementById('switch-to-signup');
        switchBtn?.addEventListener('click', (e) => {
          e.preventDefault();
          toggleAuthForms(true);
          document.getElementById('signup-email')?.focus();
        });
      }

      if (includeLoginLink) {
        const switchLoginBtn = document.getElementById('switch-to-login');
        switchLoginBtn?.addEventListener('click', (e) => {
          e.preventDefault();
          toggleAuthForms(false);
          const loginEmailInput = document.getElementById('login-email');
          if (loginEmailInput && loginEmail) {
            loginEmailInput.value = loginEmail;
          }
          loginEmailInput?.focus();
        });
      }
    }

    function setButtonLoading(button, isLoading, label) {
      if (!button) return;
      if (!button.dataset.defaultLabel) button.dataset.defaultLabel = button.textContent;
      button.disabled = isLoading;
      button.innerHTML = isLoading ? `<div class="auth-loader"></div> ${label || 'Cargando...'}` : button.dataset.defaultLabel;
    }

    function validateEmailFormat(email) {
      const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return regex.test(email);
    }

    function updateAccountInfo(user) {
      const emailText = isGuestMode ? 'Modo invitado' : (user?.email || 'Sin sesiÃ³n');
      if (userEmailDisplay) userEmailDisplay.textContent = emailText;
      if (emailVerifiedBadge) {
        const verified = user?.emailVerified;
        emailVerifiedBadge.textContent = isGuestMode
          ? 'SesiÃ³n local sin verificaciÃ³n'
          : verified
            ? 'Email verificado âœ…'
            : 'Verifica tu email para continuar';
        emailVerifiedBadge.style.color = verified ? '#1B8E5A' : '#C0392B';
      }
    }

    async function signupUser(email, password, googleTTSKey = '') {
      if (!ensureFirebaseReady('crear cuenta')) {
        return { success: false, message: 'Firebase no estÃ¡ disponible. Usa modo invitado o intenta mÃ¡s tarde.', code: 'firebase/unavailable' };
      }
      const normalizedEmail = normalizeEmail(email);
      const plainPassword = password ?? '';
      authLog('ðŸ†• Intentando registro', { normalizedEmail, passwordLength: plainPassword.length, maskedPassword: maskPassword(plainPassword) });
      try {
        const userCredential = await firebase.auth().createUserWithEmailAndPassword(normalizedEmail, plainPassword);
        const user = userCredential.user;
        authLog('âœ… Cuenta creada', { uid: user.uid, emailVerified: user.emailVerified });
        await user.sendEmailVerification();
        authLog('ðŸ“§ Email de verificaciÃ³n enviado', { to: normalizedEmail });
        const userDocRef = firebase.firestore().collection('users').doc(user.uid);
        await userDocRef.set({
          email: normalizedEmail,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          emailVerified: false,
          googleTTSKey: googleTTSKey || null,
          preferences: {
            voice: 'Sasha',
            speed: 1.0,
            language: 'es-ES'
          }
        });
        await ensureUserSettings(user.uid, normalizedEmail, true);
        return { success: true, message: 'Cuenta creada y sesiÃ³n iniciada. Revisa tu email para verificar.', user };
      } catch (error) {
        handleFirebaseOperationError('crear cuenta', error);
        return { success: false, message: errorMessages[error.code] || error.message, code: error.code };
      }
    }

    async function loginUser(email, password, remember) {
      if (!ensureFirebaseReady('iniciar sesiÃ³n')) {
        return { success: false, message: 'Firebase no estÃ¡ disponible. Prueba modo invitado o revisa tu conexiÃ³n.', code: 'firebase/unavailable' };
      }
      const normalizedEmail = normalizeEmail(email);
      const plainPassword = password ?? '';
      authLog('âž¡ï¸ Intento de login', {
        normalizedEmail,
        passwordLength: plainPassword.length,
        maskedPassword: maskPassword(plainPassword),
        remember,
        encodedPasswordSample: encodeURIComponent(plainPassword).slice(0, 20)
      });
      try {
        const persistence = remember ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION;
        await firebase.auth().setPersistence(persistence);
        authLog('ðŸ’¾ Persistencia configurada', { persistence: remember ? 'LOCAL' : 'SESSION' });

        const maxAttempts = 3;
        let attempt = 0;
        let lastError = null;

        while (attempt < maxAttempts) {
          attempt++;
          try {
            authLog('ðŸ”‘ signInWithEmailAndPassword', { attempt, normalizedEmail });
            const userCredential = await firebase.auth().signInWithEmailAndPassword(normalizedEmail, plainPassword);
            const user = userCredential.user;
            authLog('âœ… Login exitoso', { uid: user.uid, emailVerified: user.emailVerified });
            if (!user.emailVerified) {
              console.warn('Email no verificado, se permite acceso pero se recomienda verificar.');
            }
            await ensureUserSettings(user.uid, normalizedEmail, false);
            return {
              success: true,
              user,
              message: user.emailVerified ? 'SesiÃ³n iniciada correctamente' : 'SesiÃ³n iniciada, verifica tu email para mayor seguridad.'
            };
          } catch (error) {
            lastError = error;
            authLog('âŒ Fallo de login', { attempt, code: error.code, message: error.message });
            if (!retryableAuthErrors.includes(error.code) || attempt >= maxAttempts) {
              break;
            }
            const backoff = Math.pow(2, attempt) * 250;
            authLog('â³ Reintentando login con backoff', { nextAttempt: attempt + 1, backoffMs: backoff });
            await wait(backoff);
          }
        }

        const error = lastError || new Error('Error desconocido al iniciar sesiÃ³n');
        let message = errorMessages[error.code] || error.message || 'OcurriÃ³ un error al iniciar sesiÃ³n. IntÃ©ntalo de nuevo.';
        if (error.code === 'auth/invalid-login-credentials' || error.code === 'auth/invalid-credential') {
          message = 'Email o contraseÃ±a incorrectos. IntÃ©ntalo de nuevo.';
        } else if (error.code === 'auth/user-not-found') {
          message = 'No existe una cuenta con este email. Â¿Deseas crear una cuenta?';
        } else if (error.code === 'auth/wrong-password') {
          message = 'ContraseÃ±a incorrecta. IntÃ©ntalo de nuevo.';
        } else if (error.code === 'auth/unverified-email') {
          message = 'Tu email no estÃ¡ verificado. Revisa tu bandeja o solicita un nuevo enlace.';
        }
        return { success: false, message, code: error.code };
      } catch (error) {
        authLog('âŒ Error inesperado en loginUser', { code: error.code, message: error.message });
        return { success: false, message: errorMessages[error.code] || error.message, code: error.code };
      }
    }

    async function resetPassword(email) {
      try {
        if (!ensureFirebaseReady('recuperar contraseÃ±a')) {
          throw new Error('Firebase no disponible para recuperar contraseÃ±a');
        }
        authLog('ðŸ” Solicitud de reset de contraseÃ±a', { email });
        await firebase.auth().sendPasswordResetEmail(email);
        authError.style.display = 'none';
        authSuccess.textContent = 'Email de recuperaciÃ³n enviado. Revisa tu bandeja de entrada.';
        authSuccess.style.display = 'block';
      } catch (error) {
        authLog('âŒ Error en reset de contraseÃ±a', { code: error.code, message: error.message });
        authSuccess.style.display = 'none';
        if (error.code === 'auth/user-not-found') {
          authError.textContent = 'No existe cuenta con este email.';
        } else {
          authError.textContent = 'Error al enviar email: ' + (error.message || 'IntÃ©ntalo mÃ¡s tarde');
        }
        authError.style.display = 'block';
      }
    }

    async function logoutUser() {
      authLog('ðŸšª Cerrando sesiÃ³n manualmente');
      stopFirestoreListener();
      if (isFirebaseAvailable()) {
        try {
          await firebase.auth().signOut();
        } catch (error) {
          handleFirebaseOperationError('cerrar sesiÃ³n', error);
        }
      }
      setGuestMode(false);
      await clearLocalDocumentos();
      documentos = [];
      userGoogleTTSKey = null;
      setVoiceSystem('browser');
      updateApiKeySettingsUI();
      renderDocumentos();
      showLoginScreen();
    }

    async function createTestAccount() {
      const flagKey = 'testAccountCreated';
      if (localStorage.getItem(flagKey) === 'true') return;
      if (!isFirebaseAvailable()) return;
      try {
        ensureFirebaseReady('crear cuenta de prueba');
        if (firebase.auth().currentUser) return;
        const methods = await firebase.auth().fetchSignInMethodsForEmail('danieltrigre7@gmail.com');
        if (methods.length > 0) {
          localStorage.setItem(flagKey, 'true');
          return;
        }
        const result = await signupUser('danieltrigre7@gmail.com', 'rafadfani77');
        console.log('Test account creation result:', result.message);
        if (firebase.auth().currentUser?.email === 'danieltrigre7@gmail.com') {
          await firebase.auth().signOut();
        }
        localStorage.setItem(flagKey, 'true');
      } catch (error) {
        console.log('Test account may already exist:', error.message);
        localStorage.setItem(flagKey, 'true');
      }
    }

    async function saveUserAPIKey(userId, googleTTSKey) {
      if (!isFirebaseAvailable()) return;
      const payload = {
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        googleTTSKey: googleTTSKey || null
      };
      try {
        await firebase.firestore().collection('users').doc(userId).set(payload, { merge: true });
      } catch (error) {
        handleFirebaseOperationError('guardar API Key', error);
        throw error;
      }
    }

    async function getUserAPIKey(userId) {
      if (!isFirebaseAvailable()) return null;
      try {
        const docRef = await firebase.firestore().collection('users').doc(userId).get();
        authLog('ðŸ”Ž Consultando API key guardada', { userId, exists: docRef.exists });
        if (docRef.exists) {
          const data = docRef.data();
          return data?.googleTTSKey || null;
        }
        return null;
      } catch (error) {
        handleFirebaseOperationError('leer API Key', error);
        return null;
      }
    }

    async function ensureUserSettings(userId, email, fromSignup = false) {
      if (!isFirebaseAvailable()) return null;
      const settingsRef = firebase.firestore().collection('users').doc(userId);
      try {
        const doc = await settingsRef.get();
        if (doc.exists) {
          authLog('âš™ï¸ user document ya existe', { userId, fromSignup });
          return doc.data();
        }
        const payload = {
          email: email || null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          onboardingCompleted: false,
          preferences: {
            voice: 'Sasha',
            speed: 1.0,
            language: 'es-ES'
          }
        };
        authLog('ðŸ› ï¸ Creando documento de usuario faltante', { userId, fromSignup });
        await settingsRef.set(payload);
        return payload;
      } catch (error) {
        handleFirebaseOperationError('guardar ajustes de usuario', error);
        throw error;
      }
    }

    const getUserDocumentsCollection = (userId) => firebase.firestore().collection('users').doc(userId).collection('documents');

    function mapFirestoreDocToLocal(doc, userId) {
      const data = doc.data();
      const texto = data.content || data.text || data.texto || '';
      return {
        id: doc.id,
        userId,
        titulo: data.title || data.titulo || 'Documento',
        texto,
        vozSeleccionada: data.voice || data.voz || 'Sasha',
        velocidad: data.speed || data.velocidad || 1.0,
        duracion: data.duracion || calcularDuracion(texto),
        miniatura: data.miniatura || 'https://placehold.co/60x60/F5F5F5/666?text=ðŸ“„',
        estado: data.estado || 'todo',
        favorito: !!data.favorito,
        posicionReproduccion: data.posicionReproduccion || 0,
        fecha: data.updatedAt?.toDate?.()?.toISOString?.() || data.timestamp?.toDate?.()?.toISOString?.() || new Date().toISOString(),
        tipo: data.tipo || data.type || 'texto',
        audioUrl: data.audioUrl || null,
        imagen: data.imageData || null
      };
    }

    async function saveUserDocument(userId, docData) {
      if (!firebaseAppInitialized || !userId) return null;
      try {
        const docRef = await getUserDocumentsCollection(userId).add({
          title: docData.title,
          content: docData.text || docData.content || '',
          text: docData.text,
          voice: docData.voice || 'Selena',
          speed: docData.speed || 1.0,
          miniatura: docData.miniatura || 'https://placehold.co/60x60/F5F5F5/666?text=ðŸ“„',
          duracion: docData.duracion || 0,
          estado: docData.estado || 'todo',
          favorito: !!docData.favorito,
          posicionReproduccion: docData.posicionReproduccion || 0,
          tipo: docData.tipo || 'texto',
          audioUrl: docData.audioUrl || docData.audio || null,
          imageData: docData.imageData || null,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        return docRef.id;
      } catch (error) {
        handleFirebaseOperationError('guardar documento', error);
        throw error;
      }
    }

    async function loadUserDocuments(userId) {
      if (!firebaseAppInitialized || !userId) return [];
      try {
        authLog('ðŸ“‚ Descargando documentos de usuario', { userId });
        const snapshot = await getUserDocumentsCollection(userId)
          .orderBy('updatedAt', 'desc')
          .get();

        const documents = snapshot.docs.map((doc) => mapFirestoreDocToLocal(doc, userId));
        authLog('ðŸ“š Documentos cargados', { total: documents.length });
        return documents;
      } catch (error) {
        handleFirebaseOperationError('cargar documentos', error);
        return [];
      }
    }

    async function updateFirestoreDocument(userId, id, updates) {
      if (!firebaseAppInitialized || !userId) return null;
      const payload = { ...updates, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
      try {
        return await getUserDocumentsCollection(userId).doc(id).update(payload);
      } catch (error) {
        handleFirebaseOperationError('actualizar documento', error);
        throw error;
      }
    }

    async function deleteFirestoreDocument(userId, id) {
      if (!firebaseAppInitialized || !userId) return null;
      try {
        return await getUserDocumentsCollection(userId).doc(id).delete();
      } catch (error) {
        handleFirebaseOperationError('eliminar documento', error);
        throw error;
      }
    }

    function stopFirestoreListener() {
      if (firestoreUnsubscribe) {
        firestoreUnsubscribe();
        firestoreUnsubscribe = null;
      }
    }

    function subscribeToUserDocuments(userId) {
      if (!firebaseAppInitialized || !userId) return;
      stopFirestoreListener();
      firestoreUnsubscribe = getUserDocumentsCollection(userId)
        .orderBy('updatedAt', 'desc')
        .onSnapshot(async (snapshot) => {
          const docs = snapshot.docs.map((doc) => mapFirestoreDocToLocal(doc, userId));
          await clearLocalDocumentos();
          for (const doc of docs) {
            await addDocumento(doc);
          }
          documentos = await getDocumentos(userId);
          renderDocumentos();
        }, (error) => {
          console.error('Error en sincronizaciÃ³n en tiempo real:', error);
          mostrarPopupError('No pudimos sincronizar tus documentos en tiempo real.');
        });
    }

    async function syncUserDocuments(userId) {
      try {
        if (!isAuthenticated()) return;
        toggleLoader(true, 'Cargando tu biblioteca', 'Sincronizando documentos de tu cuenta...');
        const docs = await loadUserDocuments(userId);
        await clearLocalDocumentos();
        for (const doc of docs) {
          await addDocumento(doc);
        }
        documentos = await getDocumentos(userId);
        renderDocumentos();
        subscribeToUserDocuments(userId);
      } catch (error) {
        console.error('Error sincronizando documentos:', error);
        mostrarPopupError('No pudimos cargar tus documentos. Intenta de nuevo.');
      } finally {
        toggleLoader(false);
      }
    }

    async function migrateGuestDocumentsToFirestore(userId) {
      if (!isAuthenticated() || !userId) return;
      const localGuestDocs = await getDocumentos('guest');
      if (!localGuestDocs.length) return;

      for (const doc of localGuestDocs) {
        const payload = {
          title: doc.titulo,
          text: doc.texto,
          voice: doc.vozSeleccionada || 'Sasha',
          speed: doc.velocidad || 1.0,
          miniatura: doc.miniatura,
          duracion: doc.duracion,
          estado: doc.estado || 'todo',
          favorito: doc.favorito || false,
          posicionReproduccion: doc.posicionReproduccion || 0,
          tipo: doc.tipo || 'texto',
          audioUrl: doc.audioUrl || null
        };
        await saveUserDocument(userId, payload);
      }

      await clearLocalDocumentos();
    }

    async function guardarDocumentoUsuario(doc) {
      const userId = currentUser?.uid || 'guest';
      const docData = {
        userId: userId,
        title: doc.titulo,
        text: doc.texto,
        voice: doc.vozSeleccionada || vozSeleccionada,
        speed: doc.velocidad || velocidadActual,
        miniatura: doc.miniatura,
        duracion: doc.duracion,
        estado: doc.estado || 'todo',
        favorito: doc.favorito || false,
        posicionReproduccion: doc.posicionReproduccion || 0,
        tipo: doc.tipo || 'texto',
        audioUrl: doc.audioUrl || null,
        imageData: doc.imagen || doc.imageData || null
      };

      try {
        if (isAuthenticated() && currentUser?.uid) {
          const firestoreId = await saveUserDocument(currentUser.uid, docData);
          const localDoc = { ...doc, id: firestoreId, userId: currentUser.uid };
          await addDocumento(localDoc);
          documentos = await getDocumentos(currentUser.uid);
          renderDocumentos();
          mostrarPopupExito('Documento guardado en tu cuenta');
          return firestoreId;
        }

        const localDoc = { ...doc, id: doc.id || generateId(), userId };
        await addDocumento(localDoc);
        documentos = await getDocumentos(userId);
        renderDocumentos();
        mostrarPopupExito('Documento guardado localmente');
        return localDoc.id;
      } catch (error) {
        if (isGuestSession()) {
          console.error('âŒ Error guardando documento local', error);
          mostrarPopupError('No se pudo guardar el documento localmente. Intenta de nuevo.');
          return null;
        }
        handleFirebaseOperationError('guardar documento de usuario', error);
        return null;
      }
    }

    function setupAuthListeners() {
      if (loginTab && signupTab) {
        loginTab.addEventListener('click', () => toggleAuthForms(false));
        signupTab.addEventListener('click', () => toggleAuthForms(true));
      }

      if (signupForm) {
        signupForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const rawEmail = document.getElementById('signup-email').value;
          const email = normalizeEmail(rawEmail);
          const password = document.getElementById('signup-password').value;
          const confirm = document.getElementById('signup-confirm').value;
          const apiKey = document.getElementById('signup-api-key').value.trim();
          authLog('âœ‰ï¸ Email normalizado en signup', { rawEmail, normalizedEmail: email });
          setGuestMode(false);
          initializeFirebaseApp();

          if (!validateEmailFormat(email)) {
            showAuthErrorMessage('Email invÃ¡lido');
            return;
          }

          if (password.length < 6) {
            showAuthErrorMessage('ContraseÃ±a muy dÃ©bil (mÃ­nimo 6 caracteres)');
            return;
          }

          if (password !== confirm) {
            showAuthErrorMessage('Las contraseÃ±as no coinciden');
            return;
          }

          if (apiKey) {
            const { valid, message } = await validarAPIKey(apiKey);
            if (!valid) {
              showAuthErrorMessage(message || 'API Key invÃ¡lida');
              return;
            }
          }

          setButtonLoading(signupButton, true, 'Creando cuenta');
          const { success, message, code } = await signupUser(email, password, apiKey);
          setButtonLoading(signupButton, false);
          if (success) {
            setGuestMode(false);
            signupForm.reset();
            authError.style.display = 'none';
            authSuccess.textContent = message;
            authSuccess.style.display = 'block';
            toggleAuthForms(false);
            showMainApp();
          } else {
            authSuccess.style.display = 'none';
            const emailExists = code === 'auth/email-already-in-use';
            showAuthErrorMessage(
              message,
              emailExists
                ? { includeLoginLink: true, loginEmail: email, errorCode: code }
                : { includeSignupLink: true, errorCode: code }
            );
          }
        });
      }

      if (loginForm) {
        loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const rawEmail = document.getElementById('login-email').value;
          const email = normalizeEmail(rawEmail);
          const password = document.getElementById('login-password').value;
          authLog('âœ‰ï¸ Email normalizado en login', { rawEmail, normalizedEmail: email });
          setGuestMode(false);
          initializeFirebaseApp();

          if (!validateEmailFormat(email)) {
            showAuthErrorMessage('Email invÃ¡lido');
            return;
          }

          setButtonLoading(loginButton, true, 'Iniciando sesiÃ³n');
          const { success, message, code } = await loginUser(email, password, rememberMe?.checked);
          setButtonLoading(loginButton, false);

          if (success) {
            setGuestMode(false);
            loginForm.reset();
            authError.style.display = 'none';
            authSuccess.textContent = message || 'Bienvenido de vuelta!';
            authSuccess.style.display = 'block';
            showMainApp();
          } else {
            authSuccess.style.display = 'none';
            const suggestSignup = ['auth/user-not-found', 'auth/invalid-credential', 'auth/invalid-login-credentials'].includes(code);
            const options = suggestSignup ? { includeSignupLink: true, errorCode: code } : { errorCode: code };
            showAuthErrorMessage(message, options);
          }
        });
      }

      if (guestButton) {
        guestButton.addEventListener('click', () => {
          authError.style.display = 'none';
          authSuccess.style.display = 'none';
          setGuestMode(true);
          updateFirebaseStatusLabel('Modo invitado');
          updateAccountInfo(null);
          showMainApp();
        });
      }

      if (forgotPassword) {
        forgotPassword.addEventListener('click', async (e) => {
          e.preventDefault();
          const rawEmail = document.getElementById('login-email').value;
          const email = normalizeEmail(rawEmail);
          if (!validateEmailFormat(email)) {
            authError.textContent = 'Ingresa un email vÃ¡lido para recuperar tu contraseÃ±a';
            authError.style.display = 'block';
            return;
          }
          await resetPassword(email);
        });
      }

      if (logoutAction) {
        logoutAction.addEventListener('click', () => {
          mostrarPopupConfirmacion('Cerrar SesiÃ³n', 'Â¿Seguro que quieres salir de tu cuenta?', logoutUser);
        });
      }
    }

    function initializeAuthWatcher() {
      if (!isFirebaseAvailable()) {
        authInitialized = true;
        if (isGuestMode) {
          showMainApp();
        }
        return;
      }
      firebase.auth().onAuthStateChanged(async (user) => {
        authStateLog('onAuthStateChanged', {
          userPresent: !!user,
          email: user?.email,
          emailVerified: user?.emailVerified,
          lastLogin: user?.metadata?.lastSignInTime
        });
        currentUser = user;
        authInitialized = true;
        if (user) setGuestMode(false);
        textConfig = loadTextConfig();
        hydrateTextConfigUI();
        applyTextConfig(true);
        updateAccountInfo(user);

        if (user) {
          showMainApp();
          try {
            await ensureUserSettings(user.uid, user.email || currentUser?.email, false);
            await migrateGuestDocumentsToFirestore(user.uid);
            await syncUserDocuments(user.uid);
            await loadUserSettings(user.uid);
            await inicializarAPIKey();
          } catch (error) {
            handleFirebaseOperationError('cargar datos de usuario', error);
          }
          mostrarPopupExito('SesiÃ³n iniciada correctamente');
          if (!user.emailVerified) {
            mostrarPopupError('Tu email aÃºn no estÃ¡ verificado. Revisa tu bandeja para mayor seguridad.');
          }
        } else {
          authStateLog('ðŸ” SesiÃ³n cerrada, limpiando estado local');
          stopFirestoreListener();
          userGoogleTTSKey = null;
          updateApiKeySettingsUI();
          showLoginScreen('Inicia sesiÃ³n para continuar');
        }
      });
    }

    const NATURAL_VOICES = [
      {
        id: 'sasha',
        nombre: 'Sasha',
        desc: 'EspaÃ±ol europeo â€¢ tono natural y claro',
        gender: 'femenino',
        languageCode: 'es-ES',
        googleVoice: 'es-ES-Neural2-A',
        avatar: 'https://i.pravatar.cc/256?img=32'
      },
      {
        id: 'selena',
        nombre: 'Selena',
        desc: 'EspaÃ±ol europeo â€¢ tono cÃ¡lido',
        gender: 'femenino',
        languageCode: 'es-ES',
        googleVoice: 'es-ES-Neural2-C',
        avatar: 'https://i.pravatar.cc/256?img=15'
      },
      {
        id: 'ariel',
        nombre: 'Ariel',
        desc: 'EspaÃ±ol europeo â€¢ tono cercano',
        gender: 'masculino',
        languageCode: 'es-ES',
        googleVoice: 'es-ES-Neural2-B',
        avatar: 'https://i.pravatar.cc/256?img=57'
      },
      {
        id: 'alex',
        nombre: 'Alexandra',
        desc: 'EspaÃ±ol europeo â€¢ tono balanceado',
        gender: 'femenino',
        languageCode: 'es-ES',
        googleVoice: 'es-ES-Neural2-D',
        avatar: 'https://i.pravatar.cc/256?img=12'
      },
      {
        id: 'lucia',
        nombre: 'Daniel',
        desc: 'EspaÃ±ol europeo â€¢ tono profesional',
        gender: 'masculino',
        languageCode: 'es-ES',
        googleVoice: 'es-ES-Neural2-F',
        avatar: 'https://i.pravatar.cc/256?img=68'
      },
      {
        id: 'carlos',
        nombre: 'Carlos',
        desc: 'EspaÃ±ol europeo â€¢ tono grave',
        gender: 'masculino',
        languageCode: 'es-ES',
        googleVoice: 'es-ES-Neural2-B',
        avatar: 'https://i.pravatar.cc/256?img=14'
      },
      {
        id: 'sofia',
        nombre: 'Sofia',
        desc: 'EspaÃ±ol latino â€¢ tono amigable',
        gender: 'femenino',
        languageCode: 'es-US',
        googleVoice: 'es-US-Neural2-A',
        avatar: 'https://i.pravatar.cc/256?img=26'
      },
      {
        id: 'diego',
        nombre: 'Diana',
        desc: 'EspaÃ±ol latino â€¢ tono dinÃ¡mico',
        gender: 'femenino',
        languageCode: 'es-US',
        googleVoice: 'es-US-Neural2-B',
        avatar: 'https://i.pravatar.cc/256?img=49'
      },
      {
        id: 'valentina',
        nombre: 'Valentina',
        desc: 'EspaÃ±ol europeo â€¢ tono juvenil',
        gender: 'femenino',
        languageCode: 'es-ES',
        googleVoice: 'es-ES-Neural2-E',
        avatar: 'https://i.pravatar.cc/256?img=5'
      },
      {
        id: 'miguel',
        nombre: 'MarÃ­a',
        desc: 'EspaÃ±ol europeo â€¢ tono maduro',
        gender: 'femenino',
        languageCode: 'es-ES',
        googleVoice: 'es-ES-Neural2-C',
        avatar: 'https://i.pravatar.cc/256?img=34'
      },
      {
        id: 'sam',
        nombre: 'Sam',
        desc: 'InglÃ©s americano â€¢ tono equilibrado',
        gender: 'masculino',
        languageCode: 'en-US',
        googleVoice: 'en-US-Neural2-J',
        avatar: 'https://i.pravatar.cc/256?img=1'
      },
      {
        id: 'robin',
        nombre: 'Robin',
        desc: 'InglÃ©s americano â€¢ tono amable',
        gender: 'femenino',
        languageCode: 'en-US',
        googleVoice: 'en-US-Neural2-H',
        avatar: 'https://i.pravatar.cc/256?img=8'
      },
      {
        id: 'emery',
        nombre: 'Emery',
        desc: 'InglÃ©s americano â€¢ tono sereno',
        gender: 'femenino',
        languageCode: 'en-US',
        googleVoice: 'en-US-Neural2-F',
        avatar: 'https://i.pravatar.cc/256?img=47'
      },
      {
        id: 'emma',
        nombre: 'Emma',
        desc: 'InglÃ©s americano â€¢ tono claro',
        gender: 'femenino',
        languageCode: 'en-US',
        googleVoice: 'en-US-Neural2-C',
        avatar: 'https://i.pravatar.cc/256?img=3'
      },
      {
        id: 'liam',
        nombre: 'Liam',
        desc: 'InglÃ©s americano â€¢ tono profesional',
        gender: 'masculino',
        languageCode: 'en-US',
        googleVoice: 'en-US-Neural2-D',
        avatar: 'https://i.pravatar.cc/256?img=58'
      },
      {
        id: 'olivia',
        nombre: 'Olivia',
        desc: 'InglÃ©s americano â€¢ tono energÃ©tico',
        gender: 'femenino',
        languageCode: 'en-US',
        googleVoice: 'en-US-Neural2-E',
        avatar: 'https://i.pravatar.cc/256?img=21'
      },
      {
        id: 'noah',
        nombre: 'Noah',
        desc: 'InglÃ©s americano â€¢ tono cÃ¡lido',
        gender: 'masculino',
        languageCode: 'en-US',
        googleVoice: 'en-US-Neural2-I',
        avatar: 'https://i.pravatar.cc/256?img=10'
      },
      {
        id: 'ava',
        nombre: 'Ava',
        desc: 'InglÃ©s britÃ¡nico â€¢ tono elegante',
        gender: 'femenino',
        languageCode: 'en-GB',
        googleVoice: 'en-GB-Neural2-A',
        avatar: 'https://i.pravatar.cc/256?img=9'
      },
      {
        id: 'james',
        nombre: 'James',
        desc: 'InglÃ©s britÃ¡nico â€¢ tono distinguido',
        gender: 'masculino',
        languageCode: 'en-GB',
        googleVoice: 'en-GB-Neural2-B',
        avatar: 'https://i.pravatar.cc/256?img=43'
      }
    ];

    const VOICE_CONFIG = NATURAL_VOICES.reduce((acc, voice) => {
      acc[voice.nombre] = {
        ...voice,
        gender: voice.gender?.toUpperCase?.() || 'NEUTRAL'
      };
      return acc;
    }, {});

    const VOICES_DATA = Object.values(VOICE_CONFIG);

    function getVoicesForLanguage(appLanguage, voicesList = Object.values(VOICE_CONFIG)) {
      const primary = (appLanguage || 'es').split('-')[0];
      const preferred = voicesList.filter((voice) => voice.languageCode?.startsWith(primary));
      const others = voicesList.filter((voice) => !voice.languageCode?.startsWith(primary));
      return preferred.concat(others);
    }

    function updateVoiceLabels(nombre = vozSeleccionada) {
      const selectedName = nombre || vozSeleccionada;
      const systemLabel = voiceSystem === 'google' && userGoogleTTSKey
        ? 'ðŸŽ™ï¸ Google Cloud TTS (Natural)'
        : 'ðŸ”Š Voces del sistema (SintÃ©ticas)';
      const voiceBtnLabel = voiceBtn?.querySelector('small');
      if (voiceBtnLabel) voiceBtnLabel.textContent = `${selectedName} Â· ${systemLabel}`;
      if (vozActualLabel) vozActualLabel.textContent = `${selectedName} Â· ${systemLabel}`;
    }

    function setVoiceSystem(system, nombre = vozSeleccionada) {
      voiceSystem = system === 'google' && userGoogleTTSKey ? 'google' : 'browser';
      updateVoiceLabels(nombre);
    }

    const getStoredApiKey = () => userGoogleTTSKey;
    const hasAPIKeySkipPreference = () => {
      const skipKey = currentUser?.uid ? `skipAPIKey_${currentUser?.uid}` : GUEST_SKIP_API_KEY_KEY;
      return localStorage.getItem(skipKey) === 'true';
    };
    const setStoredApiKey = async (key) => {
      if (!isGuestMode && currentUser?.uid && isFirebaseAvailable()) {
        await saveUserAPIKey(currentUser.uid, key);
        localStorage.setItem(`skipAPIKey_${currentUser.uid}`, 'false');
      } else {
        if (key) {
          setGuestAPIKey(key);
          localStorage.setItem(GUEST_SKIP_API_KEY_KEY, 'false');
        } else {
          setGuestAPIKey(null);
        }
      }
      userGoogleTTSKey = key;
      setVoiceSystem(key ? 'google' : 'browser');
      window.dispatchEvent(new Event('apiKeyUpdated'));
    };

    function getAvailableVoices() {
      const naturalVoices = getVoicesForLanguage(currentLanguage, Object.values(VOICE_CONFIG));

      if (!userGoogleTTSKey) {
        return naturalVoices;
      }

      return naturalVoices;
    }

    const getApiStatusLabel = () => document.getElementById('api-status-label');

    // âœ… CARGAR VOZ CLONADA SI EXISTE
    const clonedVoice = localStorage.getItem('clonedVoice');
    if (clonedVoice) {
      try {
        const voice = JSON.parse(clonedVoice);
        VOICE_CONFIG[voice.nombre] = voice;
        if (!VOICES_DATA.find(v => v.nombre === voice.nombre)) {
          VOICES_DATA.push(voice);
        }
        console.log('âœ… Voz clonada restaurada:', voice.nombre);
      } catch (e) {
        console.error('âŒ Error cargando voz clonada:', e);
      }
    }

    function actualizarEstadoAPIKeyUI(isValidKey) {
      const btnApiStatus = document.getElementById('btn-api-status');
      const icon = btnApiStatus?.querySelector('.circle-text');
      const apiLabel = getApiStatusLabel();
      const apiKey = getStoredApiKey();

      if (btnApiStatus && icon) {
        if (isValidKey && apiKey) {
          btnApiStatus.style.borderColor = '#34C759';
          btnApiStatus.style.background = '#E8F9EE';
          icon.textContent = 'âœ“';
          icon.style.color = '#34C759';
          icon.classList.remove('blink-danger');
          btnApiStatus.title = 'API Key configurada âœ“';
        } else {
          btnApiStatus.style.borderColor = '#FF3B30';
          btnApiStatus.style.background = '#FFEBEA';
          icon.textContent = 'âš ';
          icon.style.color = '#FF3B30';
          icon.classList.add('blink-danger');
          btnApiStatus.title = 'Configurar API Key';
        }
      }

      if (apiLabel) {
        apiLabel.textContent = isValidKey && apiKey ? 'Configurada' : 'âš ï¸ API Key requerida';
        apiLabel.style.color = isValidKey && apiKey ? '#1A1A1A' : '#FF3B30';
      }

      updateApiKeySettingsUI();
    }

    function updateApiKeySettingsUI() {
      const apiKeySettings = document.getElementById('api-key-settings');
      const currentKeyInput = document.getElementById('current-api-key');

      if (apiKeySettings) {
        apiKeySettings.style.display = 'block';
      }

      if (currentKeyInput) {
        currentKeyInput.textContent = userGoogleTTSKey ? '************' : 'Sin configurar';
      }
    }

    function mostrarApiKeySetupModal() {
      const modal = document.getElementById('api-key-setup-modal');
      if (!modal) return;
      const input = document.getElementById('google-tts-api-key-input');
      if (input) input.value = userGoogleTTSKey || '';
      modal.style.display = 'flex';
      toggleOverlay(true);
    }

    function cerrarApiKeySetupModal(force = false) {
      const modal = document.getElementById('api-key-setup-modal');
      if (!modal) return;
      if (!force && !getStoredApiKey() && !hasAPIKeySkipPreference()) {
        mostrarPopupError('âš ï¸ Configura una API Key o selecciona "Omitir" para usar voces sintÃ©ticas');
        toggleOverlay(true);
        modal.style.display = 'flex';
        return;
      }
      modal.style.display = 'none';
      toggleOverlay(false);
    }

    function marcarOmitirAPIKey() {
      const skipKey = currentUser?.uid ? `skipAPIKey_${currentUser?.uid}` : GUEST_SKIP_API_KEY_KEY;
      localStorage.setItem(skipKey, 'true');
      userGoogleTTSKey = null;
      setVoiceSystem('browser');
      actualizarEstadoAPIKeyUI(false);
      cerrarApiKeySetupModal(true);
      mostrarPopupError('UsarÃ¡s voces del sistema hasta que configures tu API Key de Google Cloud TTS.');
    }

    function updateFirebaseStatusLabel(value) {
      const label = document.getElementById('firebase-status-label');
      if (label) {
        const displayValue = isGuestMode ? 'Modo invitado' : (value || 'Sin configurar');
        label.textContent = displayValue;
        const available = !isGuestMode && firebaseAppInitialized;
        label.style.color = available ? '#1A1A1A' : '#FF3B30';
      }
    }

    function toggleApiKeyValidationLoading(isLoading) {
      const saveBtn = document.getElementById('save-api-key-btn');
      const cancelBtn = document.getElementById('cancel-api-key-setup');
      const inlineLoader = document.getElementById('api-key-inline-loader');

      if (inlineLoader) inlineLoader.style.display = isLoading ? 'flex' : 'none';
      if (saveBtn) saveBtn.disabled = isLoading;
      if (cancelBtn) cancelBtn.disabled = isLoading;
    }

    async function saveAPIKey() {
      const input = document.getElementById('google-tts-api-key-input');
      const apiKey = input?.value.trim();

      if (!apiKey) {
        mostrarPopupError('Ingresa una API key vÃ¡lida.');
        return;
      }

      toggleApiKeyValidationLoading(true);
      let validationResult = { valid: false, message: '' };

      try {
        validationResult = await validarAPIKey(apiKey);
      } finally {
        toggleApiKeyValidationLoading(false);
      }

      if (!validationResult.valid) {
        mostrarPopupError(validationResult.message || 'API Key invÃ¡lida o sin permisos.');
        return;
      }
      await setStoredApiKey(apiKey);
      actualizarEstadoAPIKeyUI(true);
      updateApiKeySettingsUI();
      cerrarApiKeySetupModal();
      mostrarPopupExito(isGuestMode ? 'âœ… API Key guardada localmente' : 'âœ… API Key guardada en tu cuenta');
    }

    function editAPIKey() {
      mostrarApiKeySetupModal();
    }

    async function guardarPreferenciaVoz(nombre) {
      try {
        localStorage.setItem('vozSeleccionada', nombre);
        if (currentUser?.uid && isFirebaseAvailable()) {
          await firebase.firestore().collection('users').doc(currentUser.uid).set({
            preferences: {
              voice: nombre,
              speed: velocidadActual,
              language: currentLanguage
            }
          }, { merge: true });
        }
      } catch (error) {
        console.warn('No se pudo guardar la preferencia de voz', error);
      }
    }

    async function loadUserSettings(userId) {
      try {
        authLog('ðŸ“¥ Cargando configuraciÃ³n de usuario', { userId });
        const userDoc = await firebase.firestore().collection('users').doc(userId).get();
        const data = userDoc.data() || {};
        userGoogleTTSKey = data.googleTTSKey || await getUserAPIKey(userId);
        setVoiceSystem(userGoogleTTSKey ? 'google' : 'browser');
        const prefs = data.preferences || {};
        if (prefs.voice) {
          vozSeleccionada = prefs.voice;
          updateVoiceLabels(vozSeleccionada);
        }
        if (prefs.speed) {
          velocidadActual = prefs.speed;
          document.getElementById('speed-btn').textContent = `${velocidadActual.toFixed(1)} x`;
        }
        actualizarEstadoAPIKeyUI(!!userGoogleTTSKey);
        updateApiKeySettingsUI();
        const skipAPIKey = localStorage.getItem(`skipAPIKey_${userId}`) === 'true';
        if (!userGoogleTTSKey && !skipAPIKey) {
          mostrarApiKeySetupModal();
        }
        return userGoogleTTSKey;
      } catch (error) {
        console.error('âŒ Error cargando configuraciÃ³n de usuario:', error);
        actualizarEstadoAPIKeyUI(false);
        return null;
      }
    }

    function toggleApiLoading(show, popup) {
      const loading = popup.querySelector('#api-loading');
      const actionButtons = popup.querySelectorAll('.api-actions button');
      if (loading) loading.style.display = show ? 'flex' : 'none';
      actionButtons.forEach((btn) => (btn.disabled = show));
    }

    function mostrarPopupAPIKey(force = false) {
      const skipAPIKey = currentUser?.uid
        ? localStorage.getItem(`skipAPIKey_${currentUser.uid}`) === 'true'
        : false;
      const storedKey = getStoredApiKey();
      const existingModal = document.getElementById('api-key-modal');
      if (existingModal) existingModal.remove();

      if (!force && (skipAPIKey || storedKey)) {
        logDebug('â„¹ï¸ Modal API Key omitido', { skipAPIKey, tieneAPI: !!storedKey });
        return;
      }

      const popup = document.createElement('div');
      popup.className = 'modal-overlay active';
      popup.id = 'api-key-modal';
      popup.style.zIndex = '9999';

      popup.innerHTML = `
        <div class="modal-api-key">
          <div class="api-header">
            <div class="api-icon">ðŸŽ™ï¸</div>
            <h2>Voces Naturales con IA</h2>
            <p class="api-subtitle">
              Esta aplicaciÃ³n usa Google Cloud Text-to-Speech para generar
              voces ultra-naturales y realistas.
            </p>
          </div>
          <div class="api-benefits">
            <div class="benefit-item">
              <span class="benefit-icon">âœ…</span>
              <span>Totalmente <strong>GRATIS</strong></span>
            </div>
            <div class="benefit-item">
              <span class="benefit-icon">ðŸŽ¯</span>
              <span><strong>1 millÃ³n</strong> de caracteres/mes</span>
            </div>
            <div class="benefit-item">
              <span class="benefit-icon">ðŸ”’</span>
              <span>Sin tarjeta de crÃ©dito</span>
            </div>
          </div>
          <div class="api-input-section">
            <label for="api-key-input">API Key de Google Cloud:</label>
            <div class="input-wrapper">
              <input
                type="password"
                id="api-key-input"
                placeholder="AIzaSy..."
                autocomplete="off"
              />
              <button type="button" id="toggle-visibility" class="toggle-btn">ðŸ‘ï¸</button>
            </div>
            <span class="error-message" id="api-error" style="display:none;">
              âŒ API Key invÃ¡lida. Verifica e intenta de nuevo.
            </span>
          </div>
          <div class="api-help">
            <p>Â¿No tienes una API Key?</p>
            <a
              href="https://console.cloud.google.com/apis/library/texttospeech.googleapis.com"
              target="_blank"
              class="btn-get-api"
            >
              ðŸ“– Obtener API Key (guÃ­a paso a paso)
            </a>
          </div>
          <div class="api-actions">
            <button id="validate-api-btn" class="btn-primary">Validar y Continuar</button>
            <button id="skip-api-btn" class="btn-secondary">Omitir (usar voces del sistema)</button>
          </div>
          <div class="api-loading" id="api-loading" style="display:none;">
            <div class="spinner"></div>
            <p>Validando API Key...</p>
          </div>
        </div>
      `;

      document.body.appendChild(popup);

      const input = document.getElementById('api-key-input');
      const validateBtn = document.getElementById('validate-api-btn');
      const skipBtn = document.getElementById('skip-api-btn');
      const toggleBtn = document.getElementById('toggle-visibility');
      const errorMsg = document.getElementById('api-error');

      input.value = storedKey || '';

      let isVisible = false;
      toggleBtn.addEventListener('click', () => {
        isVisible = !isVisible;
        input.type = isVisible ? 'text' : 'password';
        toggleBtn.textContent = isVisible ? 'ðŸ™ˆ' : 'ðŸ‘ï¸';
      });

      validateBtn.addEventListener('click', async () => {
        const apiKey = input.value.trim();

        if (!apiKey) {
          mostrarError('Por favor ingresa una API Key');
          return;
        }

        toggleApiLoading(true, popup);
        errorMsg.style.display = 'none';

        const { valid, message } = await validarAPIKey(apiKey);

        toggleApiLoading(false, popup);

        if (valid) {
          await setStoredApiKey(apiKey);
          actualizarEstadoAPIKeyUI(true);
          mostrarPopupExito('âœ… API Key configurada correctamente');
          popup.remove();
          toggleOverlay(false);
        } else {
          mostrarError(message || 'API Key invÃ¡lida o sin permisos. Verifica y prueba de nuevo.');
          input.select();
        }
      });

      skipBtn.addEventListener('click', () => {
        const skipKey = currentUser?.uid ? `skipAPIKey_${currentUser.uid}` : 'skipAPIKey_guest';
        localStorage.setItem(skipKey, 'true');
        console.log('â­ï¸ Usuario eligiÃ³ usar voces del sistema');
        closeModals();
        popup.remove();
        toggleOverlay(false);
        actualizarEstadoAPIKeyUI(false);
      });

      function mostrarError(mensaje) {
        errorMsg.textContent = mensaje;
        errorMsg.style.display = 'block';
        input.classList.add('input-error');
        setTimeout(() => {
          input.classList.remove('input-error');
        }, 600);
      }
    }

    async function validarAPIKey(apiKey) {
      try {
        const controller = new AbortController();
        const response = await fetchWithTimeout(`https://texttospeech.googleapis.com/v1/voices?key=${apiKey}`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        }, 10000, controller);

        const data = await response.json();

        if (!response.ok) {
          const message = data?.error?.message || 'API Key invÃ¡lida o sin permisos';
          return { valid: false, message };
        }

        const hasVoices = Array.isArray(data.voices) && data.voices.length > 0;
        return { valid: hasVoices, message: hasVoices ? '' : 'La API Key no devolviÃ³ voces disponibles' };
      } catch (error) {
        console.error('Error validando API Key:', error);
        if (error.name === 'TimeoutError') {
          return { valid: false, message: 'Tiempo de espera agotado al validar la API Key.' };
        }
        return { valid: false, message: 'No se pudo validar la API Key. Revisa tu conexiÃ³n.' };
      }
    }

    async function inicializarAPIKey() {
      const skipAPIKey = isGuestMode
        ? localStorage.getItem(GUEST_SKIP_API_KEY_KEY) === 'true'
        : localStorage.getItem(`skipAPIKey_${currentUser?.uid}`) === 'true';
      let candidateKey = isGuestMode ? getGuestAPIKey() : getStoredApiKey();

      if (!candidateKey && currentUser?.uid && isFirebaseAvailable()) {
        candidateKey = await getUserAPIKey(currentUser.uid);
        if (candidateKey) {
          userGoogleTTSKey = candidateKey;
        }
      }

      if (candidateKey && isGuestMode) {
        userGoogleTTSKey = candidateKey;
        actualizarEstadoAPIKeyUI(true);
        return true;
      }

      if (candidateKey) {
        const { valid, message } = await validarAPIKey(candidateKey);
        if (valid) {
          await setStoredApiKey(candidateKey);
          actualizarEstadoAPIKeyUI(true);
          setVoiceSystem('google');
          logDebug('API Key vÃ¡lida e inicializada');
          return true;
        }

        logDebug('API Key invÃ¡lida en inicializaciÃ³n', message);
        await setStoredApiKey(null);
      }

      actualizarEstadoAPIKeyUI(false);
      setVoiceSystem('browser');
      if (!skipAPIKey) {
        mostrarApiKeySetupModal();
        toggleOverlay(true);
      }
      return false;
    }

    window.saveAPIKey = saveAPIKey;
    window.editAPIKey = editAPIKey;

    function switchPage(target) {
      pages.forEach((p) => p.classList.remove('active'));
      document.getElementById(target).classList.add('active');
      navItems.forEach((n) => n.classList.remove('active'));
      navItems.forEach((n) => {
        if (n.dataset.target === target) n.classList.add('active');
      });
    }

    navItems.forEach((item) => {
      item.addEventListener('click', () => switchPage(item.dataset.target));
    });

    function toggleOverlay(show) {
      modalOverlay.classList.toggle('active', show);
    }

    function openModal(modal) {
      toggleOverlay(true);
      modal.style.display = 'block';
    }

    function closeModals() {
      const apiModal = document.getElementById('api-key-setup-modal');
      const apiModalVisible = apiModal && apiModal.style.display !== 'none' && apiModal.style.display !== '';
      if (apiModalVisible && !getStoredApiKey() && !hasAPIKeySkipPreference()) {
        mostrarPopupError('âš ï¸ Configura tu API Key o selecciona "Omitir" para cerrar este diÃ¡logo.');
        toggleOverlay(true);
        apiModal.style.display = 'flex';
        return;
      }
      toggleOverlay(false);
      [voiceModal, speedModal, docMenu, notesModal, languageModal, requestForm, fileSourceModal, editModal, apiModal]
        .forEach((m) => m && (m.style.display = 'none'));
      toggleLoader(false);
    }

    modalOverlay.addEventListener('click', closeModals);
    document.querySelectorAll('[data-close]').forEach((btn) => btn.addEventListener('click', closeModals));

    function actualizarAvatarVoz(nombre) {
      const avatarInfo = getAvailableVoices().find((v) => v.nombre === nombre);
      const img = voiceBtn.querySelector('img');
      if (img && avatarInfo) img.src = avatarInfo.avatar;
      updateVoiceLabels(nombre);
    }

    function renderVoices() {
      voiceList.innerHTML = '';
      const availableVoices = getAvailableVoices();

      if (!userGoogleTTSKey && availableVoices.length) {
        const warning = document.createElement('div');
        warning.className = 'guest-warning';
        warning.innerHTML = 'âš ï¸ Necesitas configurar tu API Key de Google Cloud TTS para usar estas voces naturales.';
        warning.style.marginBottom = '12px';
        voiceList.appendChild(warning);
      }

      if (!availableVoices.length) {
        voiceList.innerHTML = '<p style="padding:12px; color:#666;">No hay voces disponibles.</p>';
        return;
      }

      if (!availableVoices.find((v) => v.nombre === vozSeleccionada)) {
        vozSeleccionada = availableVoices[0]?.nombre || vozSeleccionada;
        localStorage.setItem('vozSeleccionada', vozSeleccionada);
      }

      actualizarAvatarVoz(vozSeleccionada);
      updateVoiceLabels(vozSeleccionada);

      availableVoices.forEach((voz) => {
        const languageBadge = voz.languageCode?.startsWith('en-GB')
          ? 'GB'
          : voz.languageCode?.startsWith('en')
            ? 'EN'
            : 'ES';
        const card = document.createElement('div');
        card.className = 'voz-card' + (voz.nombre === vozSeleccionada ? ' activa' : '');
        card.innerHTML = `
          <div class="voice-avatar-wrapper">
            <span class="voice-language">${languageBadge}</span>
            <img class="voice-avatar" src="${voz.avatar}" alt="${voz.nombre}" onerror="this.src='https://placehold.co/64x64'" />
            <div class="voice-name">${voz.nombre}</div>
          </div>
          <div class="info-voz"><h4>${voz.nombre}</h4><p>${voz.desc || 'Disponible para todos'}</p><div class="onda-sonido">|||||||||||||||||||||</div></div>
          <button class="btn-play">â–¶</button>
        `;
        card.querySelector('.btn-play').addEventListener('click', () => previewVoice(voz.nombre));
        card.addEventListener('click', async () => {
          vozSeleccionada = voz.nombre;
          await guardarPreferenciaVoz(vozSeleccionada);
          renderVoices();
          actualizarAvatarVoz(vozSeleccionada);
          setVoiceSystem(userGoogleTTSKey ? 'google' : 'browser', vozSeleccionada);
        });
        voiceList.appendChild(card);
      });
    }

    async function previewVoice(vozNombre) {
      const vozConfig = VOICE_CONFIG[vozNombre] || getAvailableVoices().find((v) => v.nombre === vozNombre);

      if (!vozConfig) {
        console.error('âŒ ConfiguraciÃ³n de voz no encontrada:', vozNombre);
        return;
      }
      
      // Textos de demostraciÃ³n en el idioma nativo de cada voz
      const TEXTO_PREVIEW_POR_DEFECTO = 'Hola, esta es una muestra de mi voz.';
      const textoDemos = {
        'es-ES': `Hola, soy ${vozNombre}. Mi voz es natural y clara, perfecta para escuchar tus documentos en espaÃ±ol.`,
        'en-US': `Hello, I'm ${vozNombre}. My voice is natural and clear, perfect for listening to your documents.`,
        'en-GB': `Hello, I'm ${vozNombre}. My voice is natural and clear, perfect for listening to your documents in British English.`
      };

      const texto = (textoDemos[vozConfig.languageCode] || textoDemos['es-ES'] || TEXTO_PREVIEW_POR_DEFECTO).trim() || TEXTO_PREVIEW_POR_DEFECTO;

      console.log('ðŸ”Š Preview de voz:', vozNombre, 'idioma:', vozConfig.languageCode);

      // Detener cualquier reproducciÃ³n previa
      if (window.currentPreviewAudio) {
        try {
          window.currentPreviewAudio.pause();
        } catch (e) {
          console.warn('No se pudo pausar audio previo');
        }
      }

      // Generar y reproducir audio
      try {
        const audio = await speakNatural(texto, vozNombre, 1.0, { silenciarErrores: true });

        if (audio) {
          window.currentPreviewAudio = audio;
          audio.play();
          console.log('âœ… Reproduciendo preview');
        } else {
          mostrarPopupError('No se pudo generar el audio de previsualizaciÃ³n.');
          console.error('âŒ No se pudo generar preview');
        }
      } catch (error) {
        mostrarPopupError('No se pudo reproducir la previsualizaciÃ³n de voz. Intenta de nuevo.');
        console.error('âŒ Error en preview de voz:', error);
      }
    }

    function abrirClonacionVoz() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay active';
      modal.innerHTML = `
        <div class="modal-clonacion">
          <div class="modal-header">
            <button class="btn-volver" onclick="this.closest('.modal-overlay').remove()">â€¹</button>
            <h2>ðŸŽ™ï¸ ClonaciÃ³n de Voz</h2>
          </div>
          <div class="clonacion-content">
            <div class="clonacion-info">
              <p>Crea una voz personalizada idÃ©ntica a la tuya o de otra persona.</p>
              <div class="steps">
                <div class="step">
                  <span class="step-number">1</span>
                  <div>
                    <strong>Graba tu voz</strong>
                    <small>MÃ­nimo 1 minuto de audio claro</small>
                  </div>
                </div>
                <div class="step">
                  <span class="step-number">2</span>
                  <div>
                    <strong>Procesa con IA</strong>
                    <small>Entrenamiento automÃ¡tico (30 segundos)</small>
                  </div>
                </div>
                <div class="step">
                  <span class="step-number">3</span>
                  <div>
                    <strong>Usa tu voz clonada</strong>
                    <small>Disponible inmediatamente</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="recording-section" id="recording-section">
              <div class="record-controls">
                <button id="start-recording" class="btn-record"><span class="record-icon">ðŸ”´</span>Iniciar GrabaciÃ³n</button>
                <div id="recording-timer" style="display:none;">
                  <span class="timer-display">00:00</span>
                  <button id="stop-recording" class="btn-stop">â¹ï¸ Detener</button>
                </div>
              </div>
              <div id="audio-preview" style="display:none;">
                <audio controls id="recorded-audio"></audio>
                <button id="upload-voice" class="btn-primary">Crear Voz Clonada</button>
              </div>
              <div id="cloning-progress" style="display:none;">
                <div class="progress-bar-voice">
                  <div class="progress-fill-voice" id="progress-fill"></div>
                </div>
                <p>Procesando tu voz con IA... <span id="progress-percent">0%</span></p>
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      let mediaRecorder;
      let audioChunks = [];
      let recordingStartTime;
      let timerInterval;

      const startBtn = modal.querySelector('#start-recording');
      const stopBtn = modal.querySelector('#stop-recording');
      const timer = modal.querySelector('#recording-timer');
      const timerDisplay = modal.querySelector('.timer-display');
      const audioPreview = modal.querySelector('#audio-preview');
      const recordedAudio = modal.querySelector('#recorded-audio');
      const uploadBtn = modal.querySelector('#upload-voice');
      const progressSection = modal.querySelector('#cloning-progress');
      const progressFill = modal.querySelector('#progress-fill');
      const progressPercent = modal.querySelector('#progress-percent');

      startBtn.addEventListener('click', async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];

          mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
          };

          mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(audioBlob);
            recordedAudio.src = audioUrl;
            audioPreview.style.display = 'block';
            uploadBtn.dataset.audioBlob = audioUrl;
          };

          mediaRecorder.start();
          startBtn.style.display = 'none';
          timer.style.display = 'flex';
          recordingStartTime = Date.now();

          timerInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const seconds = (elapsed % 60).toString().padStart(2, '0');
            timerDisplay.textContent = `${minutes}:${seconds}`;
          }, 1000);

        } catch (error) {
          mostrarPopupError('No se pudo acceder al micrÃ³fono. Verifica los permisos.');
        }
      });

      stopBtn.addEventListener('click', () => {
        mediaRecorder.stop();
        clearInterval(timerInterval);
        timer.style.display = 'none';
        startBtn.style.display = 'block';
      });

      uploadBtn.addEventListener('click', async () => {
        progressSection.style.display = 'block';
        audioPreview.style.display = 'none';

        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += 5;
          progressFill.style.width = `${progress}%`;
          progressPercent.textContent = `${progress}%`;

          if (progress >= 100) {
            clearInterval(progressInterval);

          const newVoice = {
            nombre: 'Mi Voz Clonada',
            desc: 'Voz personalizada â€¢ Tu voz',
            avatar: 'https://i.pravatar.cc/150?img=68',
            googleVoice: 'es-ES-Neural2-C',
            languageCode: 'es-ES',
            gender: 'NEUTRAL',
            isCloned: true
          };

          // âœ… AÃ±adir a ambas estructuras
          VOICE_CONFIG['Mi Voz Clonada'] = newVoice;
          VOICES_DATA.push(newVoice);
          localStorage.setItem('clonedVoice', JSON.stringify(newVoice));

          console.log('âœ… Voz clonada aÃ±adida correctamente');

            mostrarPopupExito('âœ… Â¡Voz clonada creada con Ã©xito!');
            modal.remove();
            renderVoices();
          }
        }, 200);
      });
    }

    voiceBtn.addEventListener('click', () => {
      renderVoices();
      openModal(voiceModal);
    });

    saveVoiceBtn.addEventListener('click', () => {
      if (documentoActivo) updateDocumento(documentoActivo.id, { vozSeleccionada });
      closeModals();
    });

    function renderSpeedButtons() {
      speedButtons.innerHTML = '';
      [0.7, 1.0, 1.2, 1.5, 2.0, 2.5, 3.0].forEach((v) => {
        const btn = document.createElement('button');
        btn.textContent = v.toFixed(1);
        btn.addEventListener('click', () => setSpeed(v));
        speedButtons.appendChild(btn);
      });
    }

    function setSpeed(val) {
      velocidadActual = Number(val);
      localStorage.setItem('velocidadActual', velocidadActual);
      
      speedBtn.textContent = `${velocidadActual.toFixed(1)} x`;
      document.getElementById('velocidad-actual').textContent = `${velocidadActual.toFixed(1)} x`;
      speedSlider.value = velocidadActual;
      
      if (audioElement && audioElement.playbackRate !== undefined) {
        audioElement.playbackRate = velocidadActual;
      }
      
      console.log('âš¡ Velocidad:', velocidadActual);
    }

    speedBtn.addEventListener('click', () => {
      setSpeed(velocidadActual);
      openModal(speedModal);
    });
    speedSlider.addEventListener('input', (e) => setSpeed(e.target.value));
    renderSpeedButtons();

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = Math.floor(seconds % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }

    function calcularDuracion(texto) {
      const palabras = texto.trim().split(/\s+/).length;
      return palabras / (2.5 * velocidadActual);
    }

    function crearDocumentoItem(doc) {
      const item = document.createElement('div');
      item.className = 'documento-item';
      const iconoTipo = {
        'escaneo': 'ðŸ“·',
        'pdf': 'ðŸ“„',
        'docx': 'ðŸ“„',
        'archivo': 'ðŸ“„',
        'url': 'ðŸ”—',
        'texto': 'ðŸ“',
        'correo': 'âœ‰ï¸'
      };
      const fechaDoc = new Date(doc.fecha);
      const hoy = new Date();
      const fechaLabel = fechaDoc.toDateString() === hoy.toDateString() ? 'Hoy' : fechaDoc.toLocaleDateString();
      item.innerHTML = `
        <div class="miniatura">
          ${doc.miniatura && doc.miniatura.startsWith('data:')
            ? `<img src="${doc.miniatura}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;" />`
            : (doc.miniatura ? `<img src="${doc.miniatura}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;" />` : iconoTipo[doc.tipo] || 'ðŸ“„')}
        </div>
        <div class="info">
          <h3>${doc.titulo}</h3>
          <div class="meta"><span>${fechaLabel}</span><span>${doc.tipo}</span><span>${formatTime(doc.duracion)}</span></div>
        </div>
        <button class="menu-puntos">â‹®</button>
      `;
      item.querySelector('.menu-puntos').addEventListener('click', (e) => {
        e.stopPropagation();
        abrirMenuDocumento(doc);
      });
      item.addEventListener('click', () => abrirEnReproductor(doc));
      return item;
    }

    async function renderDocumentos() {
      const guestContext = isGuestSession();
      const targetUserId = guestContext ? 'guest' : currentUser?.uid;
      if (!targetUserId) {
        docList.innerHTML = '<p style="padding:16px; color:#666;">Inicia sesiÃ³n para ver tus documentos.</p>';
        return;
      }

      documentos = await getDocumentos(targetUserId);
      const guestWarning = guestContext
        ? '<div class="guest-warning">Documentos solo disponibles en este dispositivo. Inicia sesiÃ³n para sincronizar.</div>'
        : '';

      if (!documentos.length && guestContext) {
        docList.innerHTML = `${guestWarning}<p style=\"padding:16px; color:#666;\">AÃ±ade tu primer documento para verlo aquÃ­.</p>`;
        return;
      }
      docList.innerHTML = guestWarning;
      documentos.filter(filtrarDoc).forEach((doc) => docList.appendChild(crearDocumentoItem(doc)));
    }

    function filtrarDoc(doc) {
      if (filtroActual === 'favorito') return doc.favorito;
      if (filtroActual === 'todo') return true;
      return doc.estado === filtroActual;
    }

    document.querySelectorAll('.tab').forEach((tab) => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach((t) => t.classList.remove('active'));
        tab.classList.add('active');
        filtroActual = tab.dataset.filter;
        renderDocumentos();
      });
    });

    function highlightTexto(texto) {
      const baseText = texto || '';
      const paragraphs = baseText.split(/\n\s*\n/).filter((p) => p.trim());
      let sentenceIndex = 0;
      let wordIndex = 0;
      const blocks = paragraphs.length ? paragraphs : [baseText];

      const html = blocks
        .map((paragraph, idx) => {
          const palabras = paragraph.trim().split(/\s+/).filter(Boolean);
          if (!palabras.length) return '';
          const spans = palabras.map((palabra) => {
            const sentenceForWord = sentenceIndex;
            if (/[.!?Â¡Â¿â€¦]+$/.test(palabra.trim())) sentenceIndex += 1;
            const safe = palabra.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return `<span class="palabra" data-index="${wordIndex++}" data-sentence="${sentenceForWord}">${safe}</span>`;
          }).join(' ');
          return `<p class="texto-parrafo" data-parrafo="${idx}">${spans}</p>`;
        })
        .filter(Boolean)
        .join('');

      playerText.innerHTML = html || '<p class="texto-parrafo" data-parrafo="0"><span class="palabra" data-index="0" data-sentence="0">(Sin contenido)</span></p>';
      palabraElements = Array.from(playerText.querySelectorAll('.palabra'));
      palabrasTotales = palabraElements.length;
      currentSentenceId = null;
      applyTextConfig();
    }

    function clearHighlights() {
      palabraElements.forEach((el) => el.classList.remove('resaltado', 'highlight-word', 'highlight-sentence'));
      currentSentenceId = null;
    }

    function refreshPlayButtonLabel() {
      if (!playPauseBtn) return;
      if (audioElement && !audioElement.paused) {
        playPauseBtn.textContent = 'â¸ï¸';
      } else {
        playPauseBtn.textContent = 'â–¶ï¸';
      }
    }

    function togglePlayButtonLoading(isLoading) {
      if (!playPauseBtn) return;
      isGeneratingAudio = isLoading;
      playPauseBtn.disabled = isLoading;
      playPauseBtn.classList.toggle('loading', isLoading);

      if (isLoading) {
        playPauseBtn.innerHTML = '<span class="inline-spinner" aria-hidden="true"></span> <span>â³ Generando audio, por favor espera...</span>';
      } else {
        refreshPlayButtonLabel();
      }
    }

    function cancelarAudioActual() {
      if (currentTTSAbortController) {
        currentTTSAbortController.abort();
        currentTTSAbortController = null;
      }

      if (audioElement) {
        try { audioElement.pause(); } catch (e) {}
        try { audioElement.src = ''; } catch (e) {}
      }

      if (audioObjectUrl) {
        URL.revokeObjectURL(audioObjectUrl);
        audioObjectUrl = null;
      }

      audioElement = null;
    }

    async function iniciarLectura() {
      if (isGeneratingAudio) return;

      if (!documentoActivo) {
        console.error('âŒ No hay documento activo');
        return;
      }

      console.log('â–¶ï¸ Iniciando lectura:', documentoActivo.titulo);
      togglePlayButtonLoading(true);

      if (!userGoogleTTSKey && !hasAPIKeySkipPreference()) {
        mostrarPopupError('ðŸ”‘ Configura tu API Key de Google Cloud TTS para usar voces naturales');
        mostrarApiKeySetupModal();
        togglePlayButtonLoading(false);
        return;
      }

      cancelarAudioActual();
      stop();

      highlightTexto(documentoActivo.texto);
      palabrasTotales = palabraElements.length;

      console.log(`ðŸ“ ${palabrasTotales} palabras preparadas`);

      const vozConfig = VOICE_CONFIG[vozSeleccionada] || getAvailableVoices().find((v) => v.nombre === vozSeleccionada);

      try {
        if (!userGoogleTTSKey && hasAPIKeySkipPreference()) {
          audioElement = await usarVozNavegador(documentoActivo.texto, vozConfig, velocidadActual);
        } else {
          audioElement = await speakNatural(documentoActivo.texto, vozSeleccionada, velocidadActual);
        }
      } finally {
        togglePlayButtonLoading(false);
      }

      if (audioElement?.src?.startsWith('blob:')) {
        audioObjectUrl = audioElement.src;
      }

      if (!audioElement) {
        mostrarPopupError('No se pudo generar el audio');
        return;
      }

      audioElement.addEventListener('loadedmetadata', () => {
        console.log(`â±ï¸ DuraciÃ³n: ${formatTime(audioElement.duration)}`);
        timeEnd.textContent = formatTime(audioElement.duration);
      });

      audioElement.addEventListener('timeupdate', () => {
        if (!audioElement.duration || !palabrasTotales || !palabraElements.length) return;

        const currentTime = audioElement.currentTime;
        const duration = audioElement.duration;
        const porcentaje = currentTime / duration;

        progress.style.width = `${porcentaje * 100}%`;
        progressThumb.style.left = `${porcentaje * 100}%`;
        timeStart.textContent = formatTime(currentTime);
        timeEnd.textContent = formatTime(duration);

        const palabraActualIndex = Math.min(palabrasTotales - 1, Math.floor(palabrasTotales * porcentaje));
        const palabraActual = palabraElements[palabraActualIndex];

        if (!palabraActual) return;

        if (textConfig.highlightWord) {
          palabraElements.forEach((p) => p.classList.remove('resaltado', 'highlight-word'));
          palabraActual.classList.add('highlight-word', 'resaltado');
          palabraActual.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
        } else {
          palabraElements.forEach((p) => p.classList.remove('resaltado', 'highlight-word'));
        }

        if (textConfig.highlightSentence && palabraActual.dataset.sentence !== undefined) {
          const sentenceId = palabraActual.dataset.sentence;
          if (sentenceId !== currentSentenceId) {
            palabraElements.forEach((el) => {
              el.classList.toggle('highlight-sentence', el.dataset.sentence === sentenceId);
            });
            currentSentenceId = sentenceId;
          }
        } else if (currentSentenceId !== null) {
          palabraElements.forEach((el) => el.classList.remove('highlight-sentence'));
          currentSentenceId = null;
        }
      });

      audioElement.addEventListener('ended', () => {
        console.log('âœ… ReproducciÃ³n finalizada');
        detenerLectura();
      });

      try {
        await audioElement.play();
        refreshPlayButtonLabel();
        console.log('âœ… ReproducciÃ³n iniciada');
      } catch (error) {
        console.error('âŒ Error al reproducir:', error);
        mostrarPopupError('Error al reproducir el audio');
      }
    }

    function detenerLectura() {
      if (audioElement) {
        audioElement.pause();
        audioElement.currentTime = 0;
        if (audioObjectUrl) {
          URL.revokeObjectURL(audioObjectUrl);
          audioObjectUrl = null;
        }
      }
      if (currentTTSAbortController) {
        currentTTSAbortController.abort();
        currentTTSAbortController = null;
      }
      stop();
      isGeneratingAudio = false;
      playPauseBtn.disabled = false;
      refreshPlayButtonLabel();
      clearHighlights();
      console.log('â¹ï¸ ReproducciÃ³n detenida');
    }

    playPauseBtn.addEventListener('click', () => {
      if (isGeneratingAudio) return;

      if (!documentoActivo) {
        mostrarPopupError('No hay documento cargado');
        return;
      }

      if (!audioElement) {
        iniciarLectura();
      } else if (audioElement.paused) {
        audioElement.play();
        refreshPlayButtonLabel();
        console.log('â–¶ï¸ Reanudando');
      } else {
        audioElement.pause();
        refreshPlayButtonLabel();
        console.log('â¸ï¸ Pausando');
      }
    });

    backBtn.addEventListener('click', () => {
      if (!audioElement) return;
      audioElement.currentTime = Math.max(0, audioElement.currentTime - 10);
      console.log('âª -10s');
    });

    forwardBtn.addEventListener('click', () => {
      if (!audioElement) return;
      audioElement.currentTime = Math.min(audioElement.duration || 0, audioElement.currentTime + 10);
      console.log('â© +10s');
    });

    progressBar.addEventListener('click', (e) => {
      if (!audioElement || !audioElement.duration) return;
      const rect = progressBar.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const porcentaje = clickX / rect.width;
      audioElement.currentTime = porcentaje * audioElement.duration;
      console.log(`â© Salto a ${formatTime(audioElement.currentTime)}`);
    });

    let isDragging = false;
    progressThumb.addEventListener('mousedown', (e) => {
      isDragging = true;
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging || !audioElement || !audioElement.duration) return;
      const rect = progressBar.getBoundingClientRect();
      let x = e.clientX - rect.left;
      x = Math.max(0, Math.min(x, rect.width));
      const porcentaje = x / rect.width;
      audioElement.currentTime = porcentaje * audioElement.duration;
    });

    document.addEventListener('mouseup', () => {
      isDragging = false;
    });

    playerBackBtn.addEventListener('click', () => {
      detenerLectura();
      switchPage('library');
    });

    function openTextConfigPanel() {
      textConfigPanel?.classList.add('open');
      textConfigOverlay?.classList.add('active');
      if (!dockedConfigPanel) textConfigPanel?.classList.remove('docked');
      textConfigPanel?.setAttribute('tabindex', '-1');
      textConfigPanel?.focus({ preventScroll: true });
    }

    function closeTextConfigPanel() {
      textConfigPanel?.classList.remove('open');
      textConfigOverlay?.classList.remove('active');
    }

    function toggleDockConfigPanel() {
      dockedConfigPanel = !dockedConfigPanel;
      textConfigPanel?.classList.toggle('docked', dockedConfigPanel);
      dockTextConfigBtn.textContent = dockedConfigPanel ? 'Flotar' : 'Fijar';
    }

    openTextConfigBtn?.addEventListener('click', openTextConfigPanel);
    closeTextConfigBtn?.addEventListener('click', closeTextConfigPanel);
    textConfigOverlay?.addEventListener('click', closeTextConfigPanel);
    dockTextConfigBtn?.addEventListener('click', toggleDockConfigPanel);

    fontSizeSlider?.addEventListener('input', (e) => {
      textConfig.fontSize = Number(e.target.value);
      applyTextConfig(true);
    });

    fontFamilySelect?.addEventListener('change', (e) => {
      textConfig.fontFamily = e.target.value;
      applyTextConfig(true);
    });

    textColorPicker?.addEventListener('input', (e) => {
      textConfig.textColor = e.target.value;
      textConfig.highContrast = false;
      highContrastToggle.checked = false;
      applyTextConfig(true);
    });

    bgColorPicker?.addEventListener('input', (e) => {
      textConfig.backgroundColor = e.target.value;
      textConfig.highContrast = false;
      highContrastToggle.checked = false;
      applyTextConfig(true);
    });

    highlightSentenceToggle?.addEventListener('change', (e) => {
      textConfig.highlightSentence = e.target.checked;
      if (!e.target.checked) currentSentenceId = null;
      applyTextConfig(true);
      clearHighlights();
    });

    highlightWordToggle?.addEventListener('change', (e) => {
      textConfig.highlightWord = e.target.checked;
      applyTextConfig(true);
      clearHighlights();
    });

      highContrastToggle?.addEventListener('change', (e) => {
        textConfig.highContrast = e.target.checked;
        if (e.target.checked) {
          textConfig.textColor = HIGH_CONTRAST_TEXT;
          textConfig.backgroundColor = HIGH_CONTRAST_BACKGROUND;
        }
        applyTextConfig(true);
      });

    saveTextConfigBtn?.addEventListener('click', () => {
      applyTextConfig(true);
      mostrarPopupExito('Preferencias de lectura guardadas');
    });

    resetTextConfigBtn?.addEventListener('click', () => {
      textConfig = { ...TEXT_CONFIG_DEFAULTS };
      applyTextConfig(true);
      hydrateTextConfigUI();
      mostrarPopupExito('Se restablecieron los valores predeterminados');
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && textConfigPanel?.classList.contains('open')) {
        closeTextConfigPanel();
      }
    });

    function abrirEnReproductor(doc) {
      documentoActivo = doc;
      playerTitle.textContent = doc.titulo;
      highlightTexto(doc.texto);
      setSpeed(doc.velocidad || velocidadActual);
      vozSeleccionada = doc.vozSeleccionada || vozSeleccionada;
      actualizarAvatarVoz(vozSeleccionada);
      switchPage('player');
    }

    function abrirMenuDocumento(doc) {
      documentoActivo = doc;
      docMenuTitle.textContent = doc.titulo;
      docMenuType.textContent = doc.tipo;
      docVoiceLabel.textContent = doc.vozSeleccionada;
      docPreview.src = doc.miniatura || 'https://placehold.co/60x60';
      openModal(docMenu);
    }

    function abrirModalEdicion(doc) {
      if (!doc) return;
      editTitle.value = doc.titulo || '';
      editContent.value = doc.texto || '';
      toggleOverlay(true);
      editModal.style.display = 'block';
    }

    docMenu.querySelectorAll('.opciones-menu button').forEach((btn) => {
      btn.addEventListener('click', async () => {
        if (!documentoActivo) return;
        const action = btn.dataset.action;
        if (action === 'download') {
          if (!userGoogleTTSKey) {
            mostrarApiKeySetupModal();
            return;
          }

          await descargarAudio(documentoActivo, userGoogleTTSKey);
        }
        if (action === 'edit') {
          docMenu.style.display = 'none';
          abrirModalEdicion(documentoActivo);
        }
        if (action === 'share') {
          const contenido = `${documentoActivo.titulo}\n\n${documentoActivo.texto.substring(0, 800)}...\n${location.href}`;
          if (navigator.share) {
            navigator.share({ title: documentoActivo.titulo, text: contenido, url: location.href })
              .catch(() => mostrarPopupError('No se pudo compartir en este dispositivo'));
          } else {
            navigator.clipboard.writeText(contenido)
              .then(() => mostrarPopupExito('Texto copiado para compartir'))
              .catch(() => mostrarPopupError('No se pudo copiar el contenido'));
          }
        }
        if (action === 'notas') {
          const note = notas[documentoActivo.id] || '';
          notesArea.value = note;
          notesEmpty.style.display = note ? 'none' : 'block';
          openModal(notesModal);
        }
        if (action === 'resumir') {
          const resumen = resumirTexto(documentoActivo.texto);
          mostrarPopupExito(resumen, 3500);
        }
        if (action === 'finalizar') {
          await updateDocumento(documentoActivo.id, { estado: 'finalizado' });
          renderDocumentos();
        }
        if (action === 'favorito') {
          await updateDocumento(documentoActivo.id, { favorito: !documentoActivo.favorito });
          renderDocumentos();
        }
        if (action === 'temporizador') {
          mostrarPopupInput('Temporizador', 'Minutos para detener reproducciÃ³n', (valor) => {
            const minutos = Number(valor);
            if (minutos) setTimeout(detenerLectura, minutos * 60000);
          });
        }
        if (action === 'eliminar') {
          await deleteDocumento(documentoActivo.id);
          renderDocumentos();
        }
        closeModals();
      });
    });

    saveEdit.addEventListener('click', async () => {
      if (!documentoActivo) return;
      const nuevoTitulo = editTitle.value.trim();
      const nuevoContenido = editContent.value.trim();
      if (!nuevoTitulo || !nuevoContenido) {
        mostrarPopupError('Completa tÃ­tulo y contenido antes de guardar');
        return;
      }

      toggleLoader(true, 'Guardando cambios', 'Actualizando documento en tu biblioteca...');
      await updateDocumento(documentoActivo.id, {
        titulo: nuevoTitulo,
        texto: nuevoContenido,
        duracion: calcularDuracion(nuevoContenido)
      });
      toggleLoader(false);
      closeModals();
      renderDocumentos();
      mostrarPopupExito('âœ… Documento actualizado');
    });

    cancelEdit.addEventListener('click', closeModals);
    document.querySelectorAll('[data-close="edit"]').forEach((btn) => btn.addEventListener('click', closeModals));

    function resumirTexto(texto, porcentaje = 30) {
      texto = texto.replace(/\n+/g, ' ').trim();
      const oraciones = texto.match(/[^.!?]+[.!?]+/g);
      if (!oraciones || oraciones.length < 3) return texto;

      const cantidad = Math.max(3, Math.ceil(oraciones.length * (porcentaje / 100)));
      const oracionesPuntuadas = oraciones.map((oracion, indice) => {
        const palabras = oracion.split(/\s+/).filter((p) => p.length > 3);
        let puntuacion = palabras.length;
        if (indice < 2) puntuacion += 10;
        if (indice >= oraciones.length - 2) puntuacion += 5;
        ['importante', 'fundamental', 'principal', 'resumen', 'conclusiÃ³n', 'finalmente'].forEach((kw) => {
          if (oracion.toLowerCase().includes(kw)) puntuacion += 15;
        });
        return { texto: oracion, indice, puntuacion };
      });

      const seleccionadas = oracionesPuntuadas
        .sort((a, b) => b.puntuacion - a.puntuacion)
        .slice(0, cantidad)
        .sort((a, b) => a.indice - b.indice);

      return seleccionadas.map((o) => o.texto).join(' ');
    }

    async function descargarAudio(doc, apiKey) {
      try {
        const keyToUse = apiKey || userGoogleTTSKey;
        if (!keyToUse) {
          throw new Error('API key no configurada.');
        }
        const vozConfig = VOICE_CONFIG[doc.vozSeleccionada || 'Sasha'] || VOICE_CONFIG['Sasha'];
        const blob = await generateGoogleTTS(doc.texto, vozConfig.googleVoice, keyToUse, doc.velocidad || 1.0);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `${doc.titulo}.mp3`; a.click();
      } catch (error) {
        console.error('âŒ Error al descargar audio:', error);
        mostrarPopupError(`No se pudo descargar el audio: ${error.message}`);
      }
    }

    const cards = document.querySelectorAll('.tarjeta-acceso');

    function bindCardEvents() {
      cards.forEach((card) => {
        if (card.dataset.bound) return;
        card.dataset.bound = 'true';
        card.addEventListener('click', (e) => {
          const ripple = document.createElement('span');
          const rect = card.getBoundingClientRect();
          const size = Math.max(rect.width, rect.height);
          ripple.className = 'ripple';
          ripple.style.width = ripple.style.height = `${size}px`;
          ripple.style.left = `${e.clientX - rect.left - size / 2}px`;
          ripple.style.top = `${e.clientY - rect.top - size / 2}px`;
          card.appendChild(ripple);
          setTimeout(() => ripple.remove(), 500);
          handleAction(card.dataset.action);
        });
      });
    }

    bindCardEvents();

    fab.addEventListener('click', () => handleAction('texto'));

    function abrirSelectorArchivos() {
      toggleOverlay(true);
      fileSourceModal.style.display = 'block';
    }

    function abrirSelectorArchivoLocalDirecto() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.pdf,.doc,.docx,.txt';
      input.onchange = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        await procesarArchivoSeleccionado(file);
      };
      input.click();
    }

    function abrirSelectorImagenLocalDirecto() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        await procesarImagenParaOCR(file);
      };
      input.click();
    }

    async function handleAction(action) {
      if (action === 'archivo') abrirSelectorArchivoLocalDirecto();
      if (action === 'escanear') abrirSelectorImagenLocalDirecto();
      if (action === 'url') {
        mostrarPopupInput('Ingresa la URL', 'https://ejemplo.com', async (url) => {
          const texto = await extraerTextoURL(url);
          await crearDocumentoDesdeTexto('Enlace Web', texto, 'url');
        });
      }
      if (action === 'texto') {
        mostrarPopupInput('Texto rÃ¡pido', 'Escribe o pega tu texto', async (texto) => {
          await crearDocumentoDesdeTexto('Texto pegado', texto, 'texto');
        });
      }
      if (action === 'correo') {
        mostrarPopupInput('Correo', 'Pega el contenido del correo', async (texto) => {
          await crearDocumentoDesdeTexto('Correo', texto, 'correo');
        });
      }
    }

    pickFromDevice.addEventListener('click', () => {
      fileSourceModal.style.display = 'none';
      toggleOverlay(false);
      abrirSelectorArchivoLocalDirecto();
    });

    pickFromDrive.addEventListener('click', () => {
      fileSourceModal.style.display = 'none';
      toggleOverlay(false);
      mostrarPopupInput('Pega el enlace de Drive', 'https://drive.google.com/...', async (url) => {
        try {
          const response = await fetch(url);
          const texto = await response.text();
          await crearDocumentoDesdeTexto('Importado de Drive', texto.slice(0, 20000), 'archivo');
          mostrarPopupExito('Enlace de Drive importado');
        } catch (e) {
          mostrarPopupError('No se pudo importar desde Drive (revisa permisos del enlace)');
        }
      });
    });

    async function procesarArchivoSeleccionado(file) {
      try {
        toggleLoader(true, 'Procesando archivo', file.name);
        let texto = '';
        let tipo = 'archivo';

        if (file.name.endsWith('.pdf')) {
          texto = await extraerTextoPDF(file);
          tipo = 'pdf';
        } else if (file.name.endsWith('.doc')) {
          const arrayBuffer = await file.arrayBuffer();
          texto = new TextDecoder('utf-8').decode(arrayBuffer);
          tipo = 'doc';
        } else if (file.name.endsWith('.docx')) {
          texto = await extraerTextoDOCX(file);
          tipo = 'docx';
        } else if (file.name.endsWith('.txt')) {
          texto = await file.text();
          tipo = 'texto';
        } else {
          throw new Error('Formato no soportado');
        }

        if (!texto || texto.trim().length < 10) {
          throw new Error('El archivo no contiene texto vÃ¡lido');
        }

        await crearDocumentoDesdeTexto(file.name, texto, tipo);
      } catch (error) {
        mostrarPopupError(`âŒ Error procesando archivo: ${error.message}`);
        console.error(error);
      } finally {
        toggleLoader(false);
        if (fileInput) fileInput.value = '';
      }
    }

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      await procesarArchivoSeleccionado(file);
    });

    async function procesarImagenParaOCR(file) {
      if (!file) return;
      await procesarImagenesParaOCR([file]);
    }

    async function procesarImagenesParaOCR(fileList) {
      const files = Array.from(fileList).filter((f) => f.type.startsWith('image/'));
      if (!files.length) {
        mostrarPopupError('Por favor selecciona al menos una imagen vÃ¡lida');
        return;
      }

      const progressModal = document.createElement('div');
      progressModal.className = 'modal-overlay active';
      progressModal.innerHTML = `
        <div class="ocr-progress-modal">
          <div class="ocr-icon">ðŸ“·</div>
          <h3>Escaneando imÃ¡genes (${files.length})</h3>
          <div class="ocr-preview">
            <img id="ocr-preview-img" src="" alt="Preview" />
          </div>
          <div class="progress-bar-ocr">
            <div class="progress-fill-ocr" id="ocr-progress-fill"></div>
          </div>
          <p id="ocr-status">Inicializando OCR...</p>
          <p id="ocr-percent">0%</p>
        </div>
      `;

      document.body.appendChild(progressModal);

      let processed = 0;
      for (const file of files) {
        const previewUrl = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (event) => resolve(event.target.result);
          reader.readAsDataURL(file);
        });
        document.getElementById('ocr-preview-img').src = previewUrl;

        try {
          const { data: { text } } = await Tesseract.recognize(
            file,
            'spa+eng',
            {
              logger: (m) => {
                if (m.status === 'recognizing text') {
                  const percent = Math.round(((processed + m.progress) / files.length) * 100);
                  document.getElementById('ocr-progress-fill').style.width = `${percent}%`;
                  document.getElementById('ocr-percent').textContent = `${percent}%`;
                  document.getElementById('ocr-status').textContent = `Reconociendo texto... (${processed + 1}/${files.length})`;
                }
              }
            }
          );

          if (!text || text.trim().length < 10) {
            throw new Error('No se detectÃ³ texto legible en la imagen');
          }

          const nombreDoc = `Escaneo - ${new Date().toLocaleDateString('es-ES')} ${new Date().toLocaleTimeString('es-ES', { hour:'2-digit', minute: '2-digit' })}`;

          await crearDocumentoDesdeTexto(nombreDoc, text.trim(), 'image', { imageData: previewUrl, imagePreview: previewUrl });
          processed++;
        } catch (error) {
          progressModal.remove();
          mostrarPopupError(`Error al escanear: ${error.message}`);
          console.error(error);
          if (imageInput) imageInput.value = '';
          return;
        }
      }

      document.getElementById('ocr-progress-fill').style.width = '100%';
      document.getElementById('ocr-percent').textContent = '100%';
      document.getElementById('ocr-status').textContent = 'Escaneo completado';

      progressModal.remove();
      mostrarPopupExito('âœ… ImÃ¡genes escaneadas correctamente');
      switchPage('library');
      if (imageInput) imageInput.value = '';
    }

    imageInput.addEventListener('change', async (e) => {
      const { files } = e.target;
      if (!files || !files.length) return;
      await procesarImagenesParaOCR(files);
    });
    function generarMiniaturaTexto(texto) {
      return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        canvas.width = 120;
        canvas.height = 120;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, 120, 120);
        ctx.strokeStyle = '#E5E5E5';
        ctx.lineWidth = 2;
        ctx.strokeRect(0, 0, 120, 120);
        ctx.fillStyle = '#666';
        ctx.font = '10px Inter, sans-serif';
        const lineas = texto.substring(0, 100).split('\n').slice(0, 8);
        lineas.forEach((linea, i) => {
          ctx.fillText(linea.substring(0, 20), 5, 15 + (i * 12));
        });
        resolve(canvas.toDataURL());
      });
    }

    async function crearDocumentoDesdeTexto(titulo, texto, tipo, extras = {}) {
      let miniatura = 'https://placehold.co/60x60/F5F5F5/666?text=ðŸ“„';
      if (tipo === 'pdf' || tipo === 'archivo' || tipo === 'docx') {
        miniatura = await generarMiniaturaTexto(texto);
      } else if (tipo === 'escaneo' || tipo === 'image') {
        miniatura = extras.imagePreview || 'https://placehold.co/60x60/F5F5F5/666?text=ðŸ“·';
      } else if (tipo === 'url') {
        miniatura = 'https://placehold.co/60x60/F5F5F5/666?text=ðŸ”—';
      }

      const doc = {
        titulo,
        texto,
        tipo,
        duracion: calcularDuracion(texto),
        miniatura,
        vozSeleccionada,
        velocidad: velocidadActual,
        imagen: extras.imageData || null
      };
      await guardarDocumentoUsuario(doc);
      switchPage('library');
    }

    notesArea.addEventListener('input', () => {
      notesEmpty.style.display = notesArea.value ? 'none' : 'block';
    });

    document.getElementById('save-note').addEventListener('click', () => {
      if (documentoActivo) {
        notas[documentoActivo.id] = notesArea.value;
        localStorage.setItem('notasApp', JSON.stringify(notas));
        closeModals();
      }
    });

    deleteNoteBtn.addEventListener('click', () => {
      if (!documentoActivo) return;
      notas[documentoActivo.id] = '';
      localStorage.setItem('notasApp', JSON.stringify(notas));
      notesArea.value = '';
      notesEmpty.style.display = 'block';
      closeModals();
    });

    requestForm.addEventListener('submit', (e) => {
      e.preventDefault();
      mostrarPopupExito('Â¡Gracias por tu sugerencia!');
      closeModals();
    });

    ideaInfo.addEventListener('input', () => {
      charCounter.textContent = `${ideaInfo.value.length}/1000`;
      sendIdea.classList.toggle('activo', ideaInfo.value.length > 0);
    });

    document.querySelectorAll('[data-action="solicitar"]').forEach((el) => el.addEventListener('click', () => openModal(requestForm)));

    document.querySelectorAll('[data-action="cambiar-voz"]').forEach((el) => el.addEventListener('click', () => {
      renderVoices();
      openModal(voiceModal);
    }));

    document.querySelectorAll('[data-action="clonacion"]').forEach((el) => el.addEventListener('click', abrirClonacionVoz));

    document.querySelectorAll('[data-action="compartir"]').forEach((el) => el.addEventListener('click', () => {
      navigator.share ? navigator.share({ title: 'Listen AI', text: 'Prueba este clon de Listen AI', url: location.href }) : mostrarPopupError('Compartir no soportado');
    }));

    document.querySelectorAll('[data-action="calificar"]').forEach((el) => el.addEventListener('click', () => {
      console.log('â­ AcciÃ³n de calificar activada');
      mostrarPopupExito('Â¡Gracias por calificarnos! â­â­â­â­â­');
    }));

    document.querySelectorAll('[data-action="ayuda"]').forEach((el) => el.addEventListener('click', () => {
      console.log('ðŸ’¬ Abriendo soporte y ayuda');
      mostrarPopupConfirmacion('Soporte', 'Abriremos la secciÃ³n de ayuda en tu navegador. Â¿Continuar?', () => {
        window.open('https://support.google.com/', '_blank');
      });
    }));

    document.querySelectorAll('.btn-desconectar').forEach((btn) => btn.addEventListener('click', () => {
      console.log('ðŸ”Œ Solicitud de desconexiÃ³n de cuenta');
      mostrarPopupConfirmacion('Desconectar cuenta', 'Â¿Quieres desconectar tu cuenta de Google?', () => {
        mostrarPopupExito('Cuenta de Google desconectada');
      });
    }));

      window.addEventListener('DOMContentLoaded', async () => {
        // âœ… FORZAR PÃGINA INICIAL
        switchPage('home');
        console.log('âœ… PÃ¡gina inicial: home');
        if (isGuestMode) {
          showMainApp();
        } else {
          showLoginScreen();
        }

        bindCardEvents();
        setupAuthListeners();
        updateFirebaseStatusLabel(firebaseConfigInUse?.projectId || (isFirebaseAvailable() ? 'Listo' : 'Sin configurar'));
        if (isFirebaseAvailable()) {
          initializeAuthWatcher();
          createTestAccount();
        } else if (!isGuestMode) {
          console.warn('Firebase no disponible. Usando modo local.');
        }
        await inicializarAPIKey();
        await renderDocumentos();

      // âœ… BOTÃ“N DE API KEY EN HEADER
      const btnApiStatus = document.getElementById('btn-api-status');
      if (btnApiStatus) {
        btnApiStatus.addEventListener('click', () => {
          console.log('ðŸ”‘ Abriendo configuraciÃ³n de API Key');
          mostrarApiKeySetupModal();
        });

        actualizarEstadoAPIKeyUI(!!getStoredApiKey());
        window.addEventListener('apiKeyUpdated', () => actualizarEstadoAPIKeyUI(true));
      }

      const cancelApiKeyBtn = document.getElementById('cancel-api-key-setup');
      if (cancelApiKeyBtn) {
        cancelApiKeyBtn.addEventListener('click', marcarOmitirAPIKey);
      }

      const closeApiKeyBtn = document.getElementById('close-api-key-setup');
      if (closeApiKeyBtn) {
        closeApiKeyBtn.addEventListener('click', closeModals);
      }

        document.querySelectorAll('[data-action="config-api"]').forEach((el) => {
          el.addEventListener('click', () => {
            const skipKey = currentUser?.uid ? `skipAPIKey_${currentUser.uid}` : 'skipAPIKey_guest';
            localStorage.setItem(skipKey, 'false');
            mostrarApiKeySetupModal();
          });
        });

        document.querySelectorAll('[data-action="config-firebase"]').forEach((el) => {
          el.addEventListener('click', () => {
            mostrarPopupExito('La app estÃ¡ funcionando en modo local. Firebase no es obligatorio.');
          });
        });

      loadVoices(() => renderVoices());
      setSpeed(velocidadActual);
      actualizarAvatarVoz(vozSeleccionada);
      setVoiceSystem(userGoogleTTSKey ? 'google' : 'browser');

      // âœ… AÃ‘ADIR ESTA SECCIÃ“N DESPUÃ‰S DE LA INICIALIZACIÃ“N EXISTENTE

      // Conectar botÃ³n de idioma
      const idiomaBtn = document.querySelector('[data-action="idioma"]');
      if (idiomaBtn) {
        idiomaBtn.addEventListener('click', () => {
          console.log('ðŸŒ Abriendo modal de idiomas');
          abrirModalIdiomas();
        });
      } else {
        console.error('âŒ BotÃ³n de idioma no encontrado');
      }

      // Inicializar textos en el idioma actual
      updateUITranslations(currentLanguage);
      console.log('âœ… Idioma inicializado:', currentLanguage);
    });
  </script>
</body>
</html>
